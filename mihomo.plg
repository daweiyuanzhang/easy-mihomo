<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
<!ENTITY name      "easy-mihomo">
<!ENTITY author    "éš”å£å°ç‹">
<!ENTITY version   "1.0.1">
<!ENTITY launch    "Settings/EasyMihomo.Main">
<!ENTITY sourceDir "/boot/config/plugins/easy-mihomo">
<!ENTITY pluginURL "https://raw.githubusercontent.com/wlaosj/easy-mihomo/refs/heads/main/mihomo.plg">
<!ENTITY plgPATH   "/boot/config/plugins/&name;">
<!ENTITY plgNAME   "&name;-&version;-x86_64">
<!ENTITY emhttp    "/usr/local/emhttp/plugins/&name;">
]>

<PLUGIN name="&name;" author="&author;" version="&version;" launch="&launch;" pluginURL="&pluginURL;" min="6.12.0" support="https://t.me/+7jcTMePlNVwwZjg1" icon="icon-network">

<CHANGES>
1.0.1  æ—¥å¿—ç®¡ç†å¢å¼ºç‰ˆ
- æ–°å¢è‡ªåŠ¨æ—¥å¿—æ¸…ç†åŠŸèƒ½
- æ”¯æŒå®šæœŸæ¸…ç†ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
- æ™ºèƒ½ä¿ç•™æœ€è¿‘1000è¡Œæ—¥å¿—
- æ·»åŠ æ—¥å¿—çŠ¶æ€ç›‘æ§æ˜¾ç¤º
- æ–°å¢æ‰‹åŠ¨æ™ºèƒ½æ¸…ç†æŒ‰é’®
- ä¼˜åŒ–æ—¥å¿—æ–‡ä»¶å¤§å°ç®¡ç†
- æ”¹è¿›é…ç½®é€‰æ‹©ä½“éªŒï¼Œæ”¯æŒè‡ªåŠ¨ä¿å­˜
- æ–°å¢å¼¹å‡ºå¼é…ç½®ç¼–è¾‘å™¨ï¼Œæä¾›æ›´å¤§ç¼–è¾‘ç©ºé—´
- ä¼˜åŒ–ç•Œé¢å¸ƒå±€ï¼Œæ“ä½œæŒ‰é’®æ›´åˆç†
- æ”¹è¿›ä¸‹è½½è¿›åº¦æ˜¾ç¤ºï¼Œæ”¯æŒè‡ªåŠ¨æ¶ˆå¤±æç¤º
- æ›´æ–°æ ¸å¿ƒç‰ˆæœ¬åˆ° v1.19.15

1.0.0  åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- æ”¯æŒåŸºæœ¬çš„ä»£ç†åŠŸèƒ½
- é›†æˆ Web ç®¡ç†ç•Œé¢
- æ”¯æŒå¼€æœºè‡ªå¯åŠ¨
- æ”¯æŒå¤šé…ç½®æ–‡ä»¶ç®¡ç†
- æ”¯æŒåœ¨çº¿ç¼–è¾‘é…ç½®
</CHANGES>

<!-- pre-install: ensure clean run dir -->
<FILE Run="/bin/bash">
<INLINE>
set -e
rm -rf /usr/local/emhttp/plugins/easy-mihomo
mkdir -p /usr/local/emhttp/plugins/easy-mihomo/scripts
mkdir -p /boot/config/plugins/easy-mihomo
</INLINE>
</FILE>

<!-- copy files from source directory -->
<FILE Run="/bin/bash">
<INLINE><![CDATA[
set -e
# ä»æºç›®å½•å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
echo "æ­£åœ¨åˆ›å»ºç›®å½•ç»“æ„..."

# åœæ­¢æ­£åœ¨è¿è¡Œçš„mihomoæœåŠ¡
echo "æ­£åœ¨åœæ­¢mihomoæœåŠ¡..."
if pgrep -x mihomo >/dev/null 2>&1; then
  pkill -x mihomo 2>/dev/null || true
  sleep 2
  echo "  âœ“ mihomoæœåŠ¡å·²åœæ­¢"
else
  echo "  âœ“ mihomoæœåŠ¡æœªè¿è¡Œ"
fi

# ä»GitHubä¸‹è½½å¹¶å®‰è£…æ–‡ä»¶
echo "è·³è¿‡è‡ªåŠ¨ä¸‹è½½æ ¸å¿ƒä¸UIï¼šå°†ç”±æ’ä»¶é¡µé¢æä¾›æ‰‹åŠ¨ä¸‹è½½/æ›´æ–°å…¥å£"

# åˆ›å»ºå®šæœŸæ—¥å¿—æ¸…ç†è„šæœ¬
echo "  - æ­£åœ¨åˆ›å»ºæ—¥å¿—æ¸…ç†è„šæœ¬..."
cat > "/usr/local/emhttp/plugins/easy-mihomo/scripts/log_cleanup.sh" << 'EOF'
#!/bin/bash
# Mihomo æ—¥å¿—å®šæœŸæ¸…ç†è„šæœ¬
LOG_FILE="/var/log/mihomo.log"
MAX_SIZE="10MB"  # æœ€å¤§æ—¥å¿—å¤§å°
KEEP_LINES=1000  # ä¿ç•™è¡Œæ•°

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$LOG_FILE" ]; then
    exit 0
fi

# è·å–æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
FILE_SIZE=$(stat -c%s "$LOG_FILE" 2>/dev/null || echo 0)

# è§£ææœ€å¤§å¤§å°
case "$MAX_SIZE" in
    *MB) MAX_BYTES=$((${MAX_SIZE%MB} * 1024 * 1024)) ;;
    *KB) MAX_BYTES=$((${MAX_SIZE%KB} * 1024)) ;;
    *) MAX_BYTES=10485760 ;; # é»˜è®¤10MB
esac

# å¦‚æœæ–‡ä»¶è¶…è¿‡å¤§å°é™åˆ¶ï¼Œè¿›è¡Œæ¸…ç†
if [ "$FILE_SIZE" -gt "$MAX_BYTES" ]; then
    echo "[$(date)] æ—¥å¿—æ–‡ä»¶è¿‡å¤§ (${FILE_SIZE} bytes)ï¼Œå¼€å§‹æ¸…ç†..." >> "$LOG_FILE"
    # ä¿ç•™æœ€åKEEP_LINESè¡Œ
    tail -n "$KEEP_LINES" "$LOG_FILE" > "${LOG_FILE}.tmp" && mv "${LOG_FILE}.tmp" "$LOG_FILE"
    echo "[$(date)] æ—¥å¿—æ¸…ç†å®Œæˆï¼Œä¿ç•™æœ€è¿‘ $KEEP_LINES è¡Œ" >> "$LOG_FILE"
fi
EOF

chmod +x "/usr/local/emhttp/plugins/easy-mihomo/scripts/log_cleanup.sh"
echo "  âœ“ æ—¥å¿—æ¸…ç†è„šæœ¬å·²åˆ›å»º"

# æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹æ¸…ç†ï¼‰
echo "  - æ­£åœ¨è®¾ç½®å®šæ—¶æ¸…ç†ä»»åŠ¡..."
# ç§»é™¤æ—§çš„å®šæ—¶ä»»åŠ¡
crontab -l 2>/dev/null | grep -v "mihomo.*log_cleanup" | crontab - 2>/dev/null || true
# æ·»åŠ æ–°çš„å®šæ—¶ä»»åŠ¡
(crontab -l 2>/dev/null; echo "0 2 * * * /usr/local/emhttp/plugins/easy-mihomo/scripts/log_cleanup.sh >/dev/null 2>&1") | crontab - 2>/dev/null || true
echo "  âœ“ å®šæ—¶æ¸…ç†ä»»åŠ¡å·²è®¾ç½®ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰"

# å®‰è£…é˜¶æ®µå®Œæˆï¼ˆæ ¸å¿ƒ/UI ä¸‹è½½æ”¹ä¸ºé¡µé¢æ‰‹åŠ¨è§¦å‘ï¼‰
echo "âœ“ æ’ä»¶åŸºç¡€æ–‡ä»¶éƒ¨ç½²å®Œæˆï¼ˆæœªè‡ªåŠ¨ä¸‹è½½æ ¸å¿ƒä¸UIï¼‰"
]]></INLINE>
</FILE>

<!-- WebUI index -->
<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/index.php">
<INLINE><![CDATA[
<?php
$baseRun = '/usr/local/emhttp/plugins/easy-mihomo';
$scripts = $baseRun . '/scripts';
$logFile = '/var/log/mihomo.log';
$confDir = '/boot/config/plugins/easy-mihomo';
$selectFile = $confDir . '/selected.conf';

// è¿›åº¦æ–‡ä»¶ç›®å½•
$progressDir = '/var/tmp/easy-mihomo-progress';
@mkdir($progressDir, 0777, true);

$cmd = isset($_POST['cmd']) ? $_POST['cmd'] : (isset($_GET['cmd']) ? $_GET['cmd'] : '');
$msg = '';

// å…ˆå¤„ç†å‘½ä»¤ï¼Œå†è¯»å–é…ç½®çŠ¶æ€

// æ—©æœŸæ‹¦æˆªï¼šè¿›åº¦è½®è¯¢ï¼Œç›´æ¥è¾“å‡ºæ–‡æœ¬å¹¶é€€å‡º
if ($cmd === 'get_progress') {
  $target = $_GET['target'] ?? $_POST['target'] ?? '';
  $file = '';
  if ($target === 'core') $file = $progressDir . '/core.status';
  if ($target === 'ui')   $file = $progressDir . '/ui.status';
  header('Content-Type: text/plain; charset=utf-8');
  if ($file && is_file($file)) {
    echo @file_get_contents($file);
  }
  exit;
}
if ($cmd === 'start') {
  $out = shell_exec("bash $scripts/start.sh 2>&1");
  $msg = htmlspecialchars($out ?? '');
}
if ($cmd === 'stop') {
  $out = shell_exec("bash $scripts/stop.sh 2>&1");
  $msg = htmlspecialchars($out ?? '');
}
if ($cmd === 'restart') {
  $out = shell_exec("bash $scripts/restart.sh 2>&1");
  $msg = htmlspecialchars($out ?? '');
}
if ($cmd === 'clearlog') {
  @file_put_contents($logFile, "");
  $msg = 'æ—¥å¿—å·²æ¸…ç©º';
}
if ($cmd === 'cleanup_log') {
  $out = shell_exec("bash $scripts/log_cleanup.sh 2>&1");
  $msg = 'æ—¥å¿—æ¸…ç†å®Œæˆ: ' . htmlspecialchars($out ?? '');
}
if ($cmd === 'start_download') {
  $target = $_GET['target'] ?? $_POST['target'] ?? '';
  if ($target === 'core') {
    @unlink($progressDir . '/core.status');
    $out = shell_exec("nohup bash $scripts/download_core.sh --progress >$progressDir/core.log 2>&1 & echo $!");
    $msg = 'æ ¸å¿ƒä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ PID: ' . htmlspecialchars(trim($out));
  } elseif ($target === 'ui') {
    @unlink($progressDir . '/ui.status');
    $out = shell_exec("nohup bash $scripts/download_ui.sh --progress >$progressDir/ui.log 2>&1 & echo $!");
    $msg = 'UI ä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ PID: ' . htmlspecialchars(trim($out));
  } else {
    $msg = 'æœªçŸ¥çš„ä¸‹è½½ç›®æ ‡';
  }
  // è‹¥ä¸ºå¼‚æ­¥è¯·æ±‚ï¼ˆajax=1ï¼‰ï¼Œä»…è¿”å›çº¯æ–‡æœ¬å¹¶é€€å‡ºï¼Œé¿å…æ•´é¡µHTMLå›å¡«åˆ°æ¶ˆæ¯åŒºåŸŸ
  if ((isset($_GET['ajax']) && $_GET['ajax'] === '1') || (isset($_POST['ajax']) && $_POST['ajax'] === '1')) {
    header('Content-Type: text/plain; charset=utf-8');
    echo $msg;
    exit;
  }
}
if ($cmd === 'select_conf') {
  $name = basename($_POST['name'] ?? '');
  if ($name === '' || !preg_match('/\.(ya?ml)$/i', $name)) {
    $msg = 'æ— æ•ˆçš„é€‰æ‹©';
  } else {
    $path = $confDir . '/' . $name;
    if (is_file($path)) {
      if (@file_put_contents($selectFile, $name) !== false) {
        $msg = 'å·²é€‰æ‹©é…ç½®ï¼š' . htmlspecialchars($name);
      } else {
        $msg = 'ä¿å­˜é€‰æ‹©å¤±è´¥';
      }
    } else {
      $msg = 'æ–‡ä»¶ä¸å­˜åœ¨';
    }
  }
}
// ä¸Šä¼ åŠŸèƒ½å·²ç§»é™¤ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ°æ’ä»¶ç›®å½•
$maxSize = 1024*1024; // 1MB
if ($cmd === 'saveconf') {
  $content = $_POST['content'] ?? '';
  if ($content === '') {
    $msg = 'å†…å®¹ä¸ºç©º';
  } else if (strlen($content) > $maxSize) {
    $msg = 'å†…å®¹è¿‡å¤§ï¼ˆ>1MBï¼‰';
  } else {
    if (!$selectedPath) {
      $msg = 'æœªé€‰æ‹©é…ç½®ï¼Œè¯·å…ˆåœ¨é¡µé¢ä¸­é€‰æ‹©';
    } else {
      if (!is_dir(dirname($selectedPath))) @mkdir(dirname($selectedPath), 0777, true);
      if (@file_put_contents($selectedPath, $content) !== false) {
        $msg = 'é…ç½®å·²ä¿å­˜ï¼š' . htmlspecialchars($selectedPath);
        $shouldRestart = isset($_POST['restart']) && $_POST['restart'] === '1';
        if ($shouldRestart) {
          $out = shell_exec("bash $scripts/restart.sh 2>&1");
          $msg .= 'ï¼Œå¹¶å·²é‡å¯æœåŠ¡';
          if (!empty($out)) $msg .= ': ' . htmlspecialchars($out);
        }
      } else {
        $msg = 'ä¿å­˜å¤±è´¥';
      }
    }
  }
}
$status = shell_exec("bash $scripts/status.sh 2>&1");
$version = shell_exec("bash $scripts/version.sh 2>&1");
$logTail = file_exists($logFile) ? trim(shell_exec("tail -n 200 $logFile 2>&1")) : '';

// è·å–æ—¥å¿—æ–‡ä»¶ä¿¡æ¯
$logSize = file_exists($logFile) ? filesize($logFile) : 0;
$logSizeFormatted = formatBytes($logSize);
$logLines = file_exists($logFile) ? count(file($logFile)) : 0;

function formatBytes($size, $precision = 2) {
    $units = array('B', 'KB', 'MB', 'GB', 'TB');
    for ($i = 0; $size > 1024 && $i < count($units) - 1; $i++) {
        $size /= 1024;
    }
    return round($size, $precision) . ' ' . $units[$i];
}

// å¤„ç†ä¸Šä¼ é‡å®šå‘è¿”å›çš„æ¶ˆæ¯
if (isset($_GET['uploadmsg']) && $_GET['uploadmsg'] !== '') {
  $msg = $_GET['uploadmsg'];
}
// ä»…åœ¨è¾“å‡º HTML å‰è®¾ç½®å†…å®¹ç±»å‹ï¼Œé¿å…å½±å“ä¸Šä¼ é‡å®šå‘
header('Content-Type: text/html; charset=utf-8');

$available = array_values(array_filter(scandir($confDir) ?: [], function($f) use ($confDir){
  return is_file($confDir . '/' . $f) && preg_match('/\.(ya?ml)$/i', $f);
}));

// å¼€æœºå³å¯åŠ¨ï¼ˆä¸ä¾èµ–é˜µåˆ—ï¼‰è®¾ç½®
$bootFlag = '/boot/config/plugins/easy-mihomo/bootstart.enabled';
if ($cmd === 'set_bootstart') {
  $enable = ($_POST['enable'] ?? '') === '1';
  $goPath = '/boot/config/go';
  $begin = "# BEGIN easy-mihomo (do not edit)";
  $end   = "# END easy-mihomo";
  $block = $begin . "\n" .
    "(\n" .
    "cat <<'EOF' >/tmp/easy-mihomo-boot.sh\n" .
    "#!/bin/bash\n" .
    "FLAG=\"/boot/config/plugins/easy-mihomo/bootstart.enabled\"\n" .
    "START_SH=\"/usr/local/emhttp/plugins/easy-mihomo/scripts/start.sh\"\n" .
    "LOG=\"/var/log/mihomo.log\"\n" .
    "for i in \$(seq 1 60); do\n" .
    "  if [ -x \"\$START_SH\" ]; then break; fi\n" .
    "  sleep 1\n" .
    "done\n" .
    "if [ -f \"\$FLAG\" ] && [ -x \"\$START_SH\" ]; then\n" .
    "  echo \"[easy-mihomo] boot detected, starting service...\" >> \"\$LOG\" 2>&1\n" .
    "  bash \"\$START_SH\" >> \"\$LOG\" 2>&1 || true\n" .
    "fi\n" .
    "rm -f /tmp/easy-mihomo-boot.sh\n" .
    "EOF\n" .
    "bash /tmp/easy-mihomo-boot.sh &\n" .
    ")\n" .
    $end . "\n";

  if ($enable) {
    if (!is_dir(dirname($bootFlag))) @mkdir(dirname($bootFlag), 0777, true);
    @file_put_contents($bootFlag, 'enabled');
    $go = file_exists($goPath) ? @file_get_contents($goPath) : "";
    if (strpos($go, $begin) !== false && strpos($go, $end) !== false) {
      $pattern = sprintf('/%s[\s\S]*?%s\n?/m', preg_quote($begin, '/'), preg_quote($end, '/'));
      $go = preg_replace($pattern, $block, $go, 1);
    } else {
      if ($go !== "" && substr($go, -1) !== "\n") $go .= "\n";
      $go .= $block;
    }
    @file_put_contents($goPath, $go);
    $msg = 'bootstart enabled (go injected)';
  } else {
    @unlink($bootFlag);
    $go = file_exists($goPath) ? @file_get_contents($goPath) : "";
    if ($go !== "") {
      $pattern = sprintf('/%s[\s\S]*?%s\n?/m', preg_quote($begin, '/'), preg_quote($end, '/'));
      $newGo = preg_replace($pattern, '', $go, 1);
      if ($newGo !== null) @file_put_contents($goPath, $newGo);
    }
    $msg = 'bootstart disabled (go cleaned)';
  }
}
$bootstartOn = file_exists($bootFlag);

// ç°åœ¨è¯»å–å·²é€‰æ‹©çš„é…ç½®ï¼ˆåœ¨æ‰€æœ‰å‘½ä»¤å¤„ç†å®Œæˆåï¼‰
$selectedName = is_file($selectFile) ? trim(@file_get_contents($selectFile)) : '';
$selectedPath = ($selectedName && is_file($confDir . '/' . $selectedName)) ? ($confDir . '/' . $selectedName) : '';

// è¯»å–é…ç½®å†…å®¹ç”¨äºç¼–è¾‘
$confText = ($selectedPath && file_exists($selectedPath)) ? @file_get_contents($selectedPath) : '';

// æ£€æŸ¥å®‰è£…çŠ¶æ€
$installStatus = '';
$binExists = file_exists('/usr/local/bin/mihomo');
$binUdiskExists = file_exists('/boot/config/plugins/easy-mihomo/mihomo');
$uiExists = file_exists('/boot/config/plugins/easy-mihomo/zashboard.zip');

// æ£€æŸ¥æ’ä»¶ç›®å½•ä¸‹æ˜¯å¦æœ‰ä»»ä½•é…ç½®æ–‡ä»¶
$confDir = '/boot/config/plugins/easy-mihomo';
$confExists = false;
if (is_dir($confDir)) {
  $files = scandir($confDir);
  foreach ($files as $file) {
    if (preg_match('/\.(ya?ml)$/i', $file)) {
      $confExists = true;
      break;
    }
  }
}

// åªæ£€æŸ¥æ ¸å¿ƒç»„ä»¶ï¼Œé…ç½®æ–‡ä»¶ç”±ç”¨æˆ·è‡ªå·±ä¸Šä¼ 
if (!$binExists) {
  $installStatus = '<div class="error">âŒ ç¼ºå°‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹â€œä¸‹è½½/æ›´æ–°æ ¸å¿ƒâ€æŒ‰é’®å®‰è£…</div>';
} elseif (!$uiExists) {
  $installStatus = '<div class="warning">âš ï¸ æœªæ£€æµ‹åˆ° UI å‹ç¼©åŒ…ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹â€œä¸‹è½½/æ›´æ–°UIâ€è·å–ï¼ˆä¸å½±å“æŒ‰é…ç½®è‡ªå®šä¹‰ external-uiï¼‰</div>';
} elseif (!$confExists) {
  $installStatus = '<div class="success">ğŸ’¡ å°šæœªå‘ç°é…ç½®æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ åˆ°æ’ä»¶ç›®å½•ï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹â€œæ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨â€</div>';
}
?>
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Easy-Mihomo</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:16px;color:#222}
.card{border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px}
pre{background:#f7f7f7;border:1px solid #eee;border-radius:6px;padding:10px;max-height:360px;overflow:auto}
button{padding:8px 14px;margin-right:8px;cursor:pointer}
input[type=file]{margin-top:8px;margin-bottom:8px}
.warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:12px;border-radius:6px;margin-bottom:16px}
.error{color:#dc3545;margin:4px 0;font-size:14px}
.success{color:#28a745;margin:4px 0;font-size:14px}
</style>
<script>
function executeAction(action) {
  // ä½¿ç”¨GETå‚æ•°ç›´æ¥è·³è½¬
  var url = new URL(window.location);
  url.searchParams.set('cmd', action);
  window.location.href = url.toString();
}

function openConsole() {
  // è·å–å½“å‰é¡µé¢çš„ä¸»æœºåï¼ˆä¸åŒ…å«ç«¯å£ï¼‰
  var currentHostname = window.location.hostname;
  var consoleUrl = 'http://' + currentHostname + ':9090/ui/zashboard/#/proxies';
  // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æ§åˆ¶å°
  window.open(consoleUrl, '_blank');
}

function openFileManager() {
  // è·å–å½“å‰é¡µé¢çš„ä¸»æœºåå’Œç«¯å£
  var currentHostname = window.location.hostname;
  var currentPort = window.location.port;
  // æ„å»ºæ–‡ä»¶ç®¡ç†å™¨URLï¼Œç›´æ¥å®šä½åˆ°æ’ä»¶é…ç½®ç›®å½•
  var fileManagerUrl = 'http://' + currentHostname + ':' + currentPort + '/Main/Browse?dir=%2Fboot%2Fconfig%2Fplugins%2Feasy-mihomo';
  // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨
  window.open(fileManagerUrl, '_blank');
}

function startDownload(target, btn) {
  try {
    if (btn) {
      btn.dataset.oldText = btn.innerText;
      btn.disabled = true;
      btn.innerText = 'ä¸‹è½½ä¸­...';
    }
    var box = document.getElementById('download-msg');
    if (box) box.innerText = 'å·²å‘èµ·ä¸‹è½½ä»»åŠ¡ï¼Œæ­£åœ¨å‡†å¤‡...';
  } catch (e) {}
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/plugins/easy-mihomo/api.php?cmd=start_download&target=' + encodeURIComponent(target));
  xhr.onload = function(){
    if (xhr.status === 200) {
      var box = document.getElementById('download-msg');
      if (box) box.innerText = (xhr.responseText || '').trim() || 'ä»»åŠ¡å·²å¯åŠ¨';
    }
    try { if (btn) { btn.disabled = false; btn.innerText = btn.dataset.oldText || btn.innerText; } } catch (e) {}
  };
  xhr.onerror = function(){ try { if (btn) { btn.disabled = false; btn.innerText = btn.dataset.oldText || btn.innerText; } } catch(e){} };
  xhr.send();
}

function pollProgress(target, elId) {
  function tick(){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/plugins/easy-mihomo/api.php?cmd=get_progress&target=' + encodeURIComponent(target));
    xhr.onload = function(){
      if (xhr.status === 200) {
        var box = document.getElementById(elId);
        var txt = xhr.responseText || '';
        if (txt.trim()) {
          box.innerText = txt;
        } else {
          // è¿›åº¦æ–‡ä»¶å·²è¢«æ¸…ç†ï¼Œè§†ä¸ºå®Œæˆ
          if (box.innerText && box.innerText.trim() !== '') {
            box.innerText = 'âœ… ä¸‹è½½å®Œæˆ';
            setTimeout(function(){ box.innerText=''; }, 3000);
          }
        }
      }
    };
    xhr.send();
  }
  tick();
  return setInterval(tick, 2000);
}

function openConfigEditor() {
  document.getElementById('configModal').style.display = 'block';
  // ç¦ç”¨é¡µé¢æ»šåŠ¨
  document.body.style.overflow = 'hidden';
}

function closeConfigEditor() {
  document.getElementById('configModal').style.display = 'none';
  // æ¢å¤é¡µé¢æ»šåŠ¨
  document.body.style.overflow = 'auto';
}

// ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹å‡ºçª—å£
document.addEventListener('click', function(event) {
  var modal = document.getElementById('configModal');
  if (event.target === modal) {
    closeConfigEditor();
  }
});

// ESCé”®å…³é—­å¼¹å‡ºçª—å£
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeConfigEditor();
  }
});

// ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿè¡¨å•æäº¤ï¼Œç¡®ä¿ emhttp æ­£å¸¸æ¥æ”¶å¸¦ Content-Length çš„ä¸Šä¼ 
</script>
</head>
<body>
<h2>Mihomo ç®¡ç†</h2>
<?php if ($installStatus) { echo $installStatus; } ?>
<div class="card">
  <div>
    <b>è¿è¡ŒçŠ¶æ€ï¼š</b>
    <?php
      $statusText = trim($status ?? 'unknown');
      if (strpos($statusText, 'running') !== false) {
        $pid = '';
        if (preg_match('/pid=(\d+)/', $statusText, $matches)) { $pid = ' (è¿›ç¨‹ID: ' . $matches[1] . ')'; }
        echo '<span style="color:#28a745;font-weight:bold;">ğŸŸ¢ è¿è¡Œä¸­' . $pid . '</span>';
      } elseif (strpos($statusText, 'stopped') !== false) {
        echo '<span style="color:#dc3545;font-weight:bold;">ğŸ”´ å·²åœæ­¢</span>';
      } else {
        echo '<span style="color:#6c757d;">âšª ' . htmlspecialchars($statusText) . '</span>';
      }
    ?>
  </div>

  <div style="margin-top:8px">
    <b>æ ¸å¿ƒï¼š</b>
    <?php if ($binExists): ?>
      <span style="color:#28a745">å·²å®‰è£…</span> | <button onclick="startDownload('core', this)">ä¸‹è½½/æ›´æ–°æ ¸å¿ƒ</button> | ç‰ˆæœ¬ï¼š<?= htmlspecialchars(trim($version ?? 'unknown')) ?>
    <?php elseif ($binUdiskExists): ?>
      <span style="color:#ffc107">å·²ä¿å­˜</span>ï¼ˆé‡å¯åè‡ªåŠ¨æ¢å¤ï¼‰ | <button onclick="startDownload('core', this)">ä¸‹è½½/æ›´æ–°æ ¸å¿ƒ</button>
    <?php else: ?>
      <span style="color:#dc3545">æœªå®‰è£…</span> | <button onclick="startDownload('core', this)">ä¸‹è½½/æ›´æ–°æ ¸å¿ƒ</button>
    <?php endif; ?>
    <div id="progress-core" style="font-size:12px;color:#6c757d;margin-top:4px"></div>
  </div>

  <div style="margin-top:6px">
    <b>UIï¼š</b>
    <?php if ($uiExists): ?>
      <span style="color:#28a745">å·²å®‰è£…</span>
    <?php else: ?>
      <span style="color:#dc3545">æœªå®‰è£…</span>
    <?php endif; ?>
    | <button onclick="startDownload('ui', this)">ä¸‹è½½/æ›´æ–°UI</button>
    | <button onclick="openConsole()">æ‰“å¼€æ§åˆ¶å°</button>
    <div id="progress-ui" style="font-size:12px;color:#6c757d;margin-top:4px"></div>
  </div>

  <div style="margin-top:6px">
    <b>é…ç½®ï¼š</b>
     <form id="configForm" method="POST" style="display:inline-block;margin:0 8px;vertical-align:middle">
       <input type="hidden" name="cmd" value="select_conf" />
       <select name="name" onchange="this.form.submit()" style="min-width:260px">
         <?php if (!$selectedName): ?>
           <option value="" disabled selected>è¯·é€‰æ‹©é…ç½®æ–‡ä»¶</option>
         <?php endif; ?>
         <?php foreach ($available as $f): ?>
           <option value="<?= htmlspecialchars($f) ?>" <?= ($f === $selectedName ? 'selected' : '') ?>><?= htmlspecialchars($f) ?></option>
         <?php endforeach; ?>
       </select>
     </form>
     <button onclick="document.getElementById('configForm').submit()">åˆ·æ–°é…ç½®åˆ—è¡¨</button>
     | <button onclick="openFileManager()">æ‰“å¼€é…ç½®æ–‡ä»¶å¤¹</button>
     | <span style="color:#6c757d">å½“å‰ï¼š<?= $selectedPath ? htmlspecialchars($selectedPath) : 'æœªé€‰æ‹©' ?></span>
  </div>

  <div style="margin-top:8px">
    <b>æ—¥å¿—ï¼š</b> æ–‡ä»¶å¤§å°: <?= $logSizeFormatted ?> | æ€»è¡Œæ•°: <?= $logLines ?> è¡Œ | è‡ªåŠ¨æ¸…ç†: æ¯å¤©å‡Œæ™¨2ç‚¹
  </div>

  <div style="margin-top:10px">
    <button onclick="executeAction('start')">å¯åŠ¨</button>
    <button onclick="executeAction('stop')">åœæ­¢</button>
    <button onclick="executeAction('restart')">é‡å¯æœåŠ¡</button>
    <button onclick="executeAction('clearlog')">æ¸…ç©ºæ—¥å¿—</button>
    <button onclick="executeAction('cleanup_log')" style="background:#ffc107;color:#000;">æ™ºèƒ½æ¸…ç†</button>
  </div>

  <div style="margin-top:8px">
    <b>å¼€æœºå¯åŠ¨ï¼š</b>
    <form method="POST" style="display:inline-block;margin:0 8px;vertical-align:middle">
      <input type="hidden" name="cmd" value="set_bootstart" />
      <label>
        <input type="checkbox" name="enable" value="1" <?= $bootstartOn ? 'checked' : '' ?> onchange="this.form.submit()" />
        å¼€æœºè‡ªåŠ¨å¯åŠ¨ Mihomo
      </label>
    </form>
    <span style="color:#6c757d">
      <?= $bootstartOn ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨' ?>
    </span>
  </div>
</div>
<!-- åœ¨çº¿ç¼–è¾‘é…ç½®æŒ‰é’® -->
<div class="card">
  <div><b>é…ç½®ç¼–è¾‘ï¼š</b>
    <button onclick="openConfigEditor()" <?= $selectedPath? '':'disabled' ?> style="margin-left:8px">
      <?= $selectedPath? 'ç¼–è¾‘é…ç½® (' . htmlspecialchars($selectedName) . ')':'è¯·å…ˆé€‰æ‹©é…ç½®æ–‡ä»¶' ?>
    </button>
  </div>
</div>

<!-- é…ç½®ç¼–è¾‘å¼¹å‡ºçª—å£ -->
<div id="configModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow:auto;box-sizing:border-box;">
  <div style="position:relative;margin:8% auto 5% auto;background:white;border-radius:8px;padding:20px;width:90%;max-width:1200px;min-height:600px;box-shadow:0 4px 20px rgba(0,0,0,0.3);box-sizing:border-box;">
    <div style="margin-bottom:15px;border-bottom:1px solid #eee;padding-bottom:10px;">
      <h3 style="margin:0;">ç¼–è¾‘é…ç½®: <?= htmlspecialchars($selectedName) ?></h3>
    </div>
    <form method="POST" style="display:flex;flex-direction:column;">
      <input type="hidden" name="cmd" value="saveconf" />
      <div style="margin-bottom:15px;">
        <textarea name="content" style="width:100%;height:500px;font-family:monospace;font-size:14px;border:1px solid #ddd;border-radius:4px;padding:10px;resize:vertical;box-sizing:border-box;" spellcheck="false" <?= $selectedPath? '':'disabled' ?>><?php echo htmlspecialchars($confText); ?></textarea>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid #eee;padding-top:15px;">
        <label><input type="checkbox" name="restart" value="1" <?= $selectedPath? '':'disabled' ?> /> ä¿å­˜åé‡å¯æœåŠ¡</label>
        <div>
          <button type="button" onclick="closeConfigEditor()" style="margin-right:10px;padding:8px 16px;border:1px solid #ddd;background:white;border-radius:4px;cursor:pointer;">å–æ¶ˆ</button>
          <button type="submit" <?= $selectedPath? '':'disabled' ?> style="padding:8px 16px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;">ä¿å­˜é…ç½®</button>
        </div>
      </div>
    </form>
    <small style="color:#6c757d;margin-top:10px;display:block;"><?= $selectedPath? 'ä¿å­˜å°†ç›´æ¥è¦†ç›–æ‰€é€‰é…ç½®ï¼ˆä¸Šé™ 1MBï¼‰ã€‚':'å°šæœªé€‰æ‹©é…ç½®æ–‡ä»¶ã€‚' ?></small>
  </div>
</div>
<div class="card">
  <div><b>æ—¥å¿—ï¼ˆæœ€è¿‘ 200 è¡Œï¼‰ï¼š</b></div>
  <pre><?= htmlspecialchars($logTail) ?></pre>
  <div>
    <button onclick="executeAction('start')">åˆ·æ–°ï¼ˆå¹¶å°è¯•å¯åŠ¨ï¼‰</button>
  </div>
</div>
<div id="download-msg" style="font-size:12px;color:#6c757d;margin-top:6px"></div>
<script>
// é¡µé¢åŠ è½½åå¼€å§‹è½®è¯¢è¿›åº¦
pollProgress('core', 'progress-core');
pollProgress('ui', 'progress-ui');
</script>
</body>
</html>
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/api.php">
<INLINE><![CDATA[
<?php
// è½»é‡ APIï¼šçº¯æ–‡æœ¬è¿”å›ï¼Œé¿å… emhttp å¤–å±‚ HTML åŒ…è£…
header('Content-Type: text/plain; charset=utf-8');

$baseRun = '/usr/local/emhttp/plugins/easy-mihomo';
$scripts = $baseRun . '/scripts';
$progressDir = '/var/tmp/easy-mihomo-progress';
@mkdir($progressDir, 0777, true);

$cmd = $_GET['cmd'] ?? $_POST['cmd'] ?? '';
if ($cmd === 'get_progress') {
  $target = $_GET['target'] ?? $_POST['target'] ?? '';
  $file = '';
  if ($target === 'core') $file = $progressDir . '/core.status';
  if ($target === 'ui')   $file = $progressDir . '/ui.status';
  if ($file && is_file($file)) { echo @file_get_contents($file); }
  exit;
}
if ($cmd === 'start_download') {
  $target = $_GET['target'] ?? $_POST['target'] ?? '';
  if ($target === 'core') {
    @unlink($progressDir . '/core.status');
    $out = shell_exec("nohup bash $scripts/download_core.sh --progress >$progressDir/core.log 2>&1 & echo $!");
    echo 'æ ¸å¿ƒä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ PID: ' . trim($out);
  } elseif ($target === 'ui') {
    @unlink($progressDir . '/ui.status');
    $out = shell_exec("nohup bash $scripts/download_ui.sh --progress >$progressDir/ui.log 2>&1 & echo $!");
    echo 'UI ä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ PID: ' . trim($out);
  } else {
    echo 'æœªçŸ¥çš„ä¸‹è½½ç›®æ ‡';
  }
  exit;
}
echo 'unknown command';
]]></INLINE>
</FILE>

<!-- scripts -->
<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/start.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
BIN="/usr/local/bin/mihomo"
CONF_DIR="/boot/config/plugins/easy-mihomo"
SELECT_FILE="$CONF_DIR/selected.conf"
if [ -f "$SELECT_FILE" ]; then
  NAME=$(cat "$SELECT_FILE" 2>/dev/null || true)
  if [ -n "$NAME" ] && [ -f "$CONF_DIR/$NAME" ]; then
    CONF_FILE="$CONF_DIR/$NAME"
  else
    echo "æœªæ‰¾åˆ°æœ‰æ•ˆçš„å·²é€‰é…ç½® ("$NAME")" >&2; exit 1
  fi
else
  echo "æœªé€‰æ‹©é…ç½®ï¼Œè¯·å…ˆåœ¨é¡µé¢ä¸­é€‰æ‹©" >&2; exit 1
fi
LOG_FILE="/var/log/mihomo.log"
PID_FILE="/var/run/mihomo.pid"

# é˜²é‡å¤å¯åŠ¨æ£€æŸ¥ï¼ˆå¿…é¡»åœ¨æœ€å‰é¢ï¼‰
if [ -f "$PID_FILE" ]; then
  PID=$(cat "$PID_FILE" 2>/dev/null || true)
  if [ -n "$PID" ] && ps -p "$PID" >/dev/null 2>&1; then
    echo "running (pid $PID)"
    exit 0
  fi
fi

# æ£€æŸ¥å¹¶æ¢å¤æ ¸å¿ƒæ–‡ä»¶ï¼ˆé‡å¯åå†…å­˜æ–‡ä»¶ä¸¢å¤±ï¼‰
if [ ! -f "$BIN" ]; then
  UDISK_BIN="/boot/config/plugins/easy-mihomo/mihomo"
  if [ -f "$UDISK_BIN" ]; then
    echo "æ£€æµ‹åˆ°æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼Œä»Uç›˜æ¢å¤..." >> "$LOG_FILE" 2>&1
    mkdir -p /usr/local/bin
    cp -f "$UDISK_BIN" "$BIN"
    chmod +x "$BIN"
    echo "æ ¸å¿ƒæ–‡ä»¶å·²ä»Uç›˜æ¢å¤åˆ°å†…å­˜" >> "$LOG_FILE" 2>&1
  else
    echo "äºŒè¿›åˆ¶ç¼ºå¤±: $BIN" >> "$LOG_FILE" 2>&1
    echo "äºŒè¿›åˆ¶ç¼ºå¤±: $BIN"
    exit 1
  fi
fi

# UI è¿è¡Œäºå†…å­˜ï¼Œç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶è·¯å¾„æŒ‡å‘å†…å­˜ç›®å½•
UI_ZIP_PATH="/boot/config/plugins/easy-mihomo/zashboard.zip"
UI_RAM_DIR="/var/tmp/easy-mihomo-ui/zashboard"

# æ¯æ¬¡å¯åŠ¨éƒ½é‡æ–°è§£å‹UIåˆ°å†…å­˜ï¼ˆç¡®ä¿æœ€æ–°ï¼‰
if [ -f "$UI_ZIP_PATH" ]; then
  echo "è§£å‹ UI åˆ°å†…å­˜ï¼ˆè¦†ç›–ï¼‰..." >> "$LOG_FILE" 2>&1
  rm -rf "$UI_RAM_DIR" && mkdir -p "$UI_RAM_DIR"
  if command -v unzip >/dev/null 2>&1; then
    unzip -oq "$UI_ZIP_PATH" -d "$UI_RAM_DIR" >> "$LOG_FILE" 2>&1 || true
  elif command -v busybox >/dev/null 2>&1; then
    busybox unzip -oq "$UI_ZIP_PATH" -d "$UI_RAM_DIR" >> "$LOG_FILE" 2>&1 || true
  fi
  # è‹¥æœ‰ dist/ å­ç›®å½•ï¼Œä¸Šç§»å…¶å†…å®¹å¹¶åˆ é™¤
  if [ -d "$UI_RAM_DIR/dist" ]; then
    cp -rf "$UI_RAM_DIR/dist/." "$UI_RAM_DIR/" 2>>"$LOG_FILE" || true
    rm -rf "$UI_RAM_DIR/dist" 2>>"$LOG_FILE" || true
  fi
  echo "UI è§£å‹å®Œæˆ" >> "$LOG_FILE" 2>&1
else
  echo "UI zipæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡è§£å‹" >> "$LOG_FILE" 2>&1
fi

# åœ¨mihomoå·¥ä½œç›®å½•å†…åˆ›å»ºbind mountæŒ‡å‘å†…å­˜UIç›®å½•
UI_MOUNT_DIR="/boot/config/plugins/easy-mihomo/ui/zashboard"
echo "åˆ›å»ºUI bind mount..." >> "$LOG_FILE" 2>&1

# ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
mkdir -p "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true

# å¦‚æœå·²ç»æŒ‚è½½ï¼Œå…ˆå¸è½½
if mountpoint -q "$UI_MOUNT_DIR" 2>/dev/null; then
  echo "å¸è½½ç°æœ‰bind mount: $UI_MOUNT_DIR" >> "$LOG_FILE" 2>&1
  umount "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || umount -l "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
fi

# æ¸…ç†ç›®å½•å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if [ -d "$UI_MOUNT_DIR" ] && [ ! -L "$UI_MOUNT_DIR" ]; then
  echo "æ¸…ç†ç›®å½•å†…å®¹: $UI_MOUNT_DIR" >> "$LOG_FILE" 2>&1
  rm -rf "$UI_MOUNT_DIR"/* 2>>"$LOG_FILE" || true
fi

# åˆ›å»ºbind mount
echo "åˆ›å»ºbind mount: $UI_MOUNT_DIR <- $UI_RAM_DIR" >> "$LOG_FILE" 2>&1
mount --bind "$UI_RAM_DIR" "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || {
  echo "bind mountåˆ›å»ºå¤±è´¥ï¼Œå°è¯•æ¸…ç†åé‡è¯•..." >> "$LOG_FILE" 2>&1
  # å¦‚æœå¤±è´¥ï¼Œæ¸…ç†ç›®å½•åé‡è¯•
  rm -rf "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
  mkdir -p "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
  mount --bind "$UI_RAM_DIR" "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
}

# éªŒè¯bind mountæ˜¯å¦æˆåŠŸ
if mountpoint -q "$UI_MOUNT_DIR" 2>/dev/null; then
  echo "bind mountåˆ›å»ºæˆåŠŸ" >> "$LOG_FILE" 2>&1
else
  echo "bind mountåˆ›å»ºå¤±è´¥ï¼Œä½¿ç”¨è½¯é“¾æ¥ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ..." >> "$LOG_FILE" 2>&1
  rm -rf "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
  ln -s "$UI_RAM_DIR" "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
fi

# æ£€æŸ¥å¹¶ä¿®å¤é…ç½®æ–‡ä»¶ä¸­çš„UIè·¯å¾„
if [ -f "$CONF_FILE" ]; then
  echo "æ£€æŸ¥é…ç½®æ–‡ä»¶UIè·¯å¾„..." >> "$LOG_FILE" 2>&1
  CURRENT_UI_PATH=$(grep "^external-ui:" "$CONF_FILE" | head -1 | sed 's/.*external-ui: *//' | tr -d ' ' || echo "")
  
  if [[ "$CURRENT_UI_PATH" != "ui" ]]; then
    echo "æ£€æµ‹åˆ°UIè·¯å¾„ä¸º: $CURRENT_UI_PATHï¼Œä¿®æ”¹ä¸º: ui" >> "$LOG_FILE" 2>&1
    # å¤‡ä»½åŸé…ç½®
    cp "$CONF_FILE" "$CONF_FILE.bak.$(date +%s)" 2>/dev/null || true
    # ä¿®æ”¹UIè·¯å¾„ä¸ºui
    sed -i "s|^external-ui:.*|external-ui: ui|g" "$CONF_FILE"
    echo "UIè·¯å¾„å·²ä¿®æ”¹ä¸º: ui" >> "$LOG_FILE" 2>&1
  else
    echo "UIè·¯å¾„æ­£ç¡®: ui" >> "$LOG_FILE" 2>&1
  fi
else
  echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡UIè·¯å¾„æ£€æŸ¥" >> "$LOG_FILE" 2>&1
fi

if [ ! -x "$BIN" ]; then echo "äºŒè¿›åˆ¶ç¼ºå¤±: $BIN" >&2; exit 1; fi
if [ ! -f "$CONF_FILE" ]; then echo "é…ç½®æ–‡ä»¶ç¼ºå¤±: $CONF_FILE" >&2; exit 1; fi

# å°è¯•åŠ è½½ TUNï¼ˆå¿½ç•¥å¤±è´¥ï¼‰
modprobe tun 2>/dev/null || true

# åå°å¯åŠ¨
nohup "$BIN" -d "$CONF_DIR" -f "$CONF_FILE" >> "$LOG_FILE" 2>&1 &
NEWPID=$!
echo $NEWPID > "$PID_FILE"
sleep 1

if ps -p "$NEWPID" >/dev/null 2>&1; then
  echo "started (pid $NEWPID)"
  exit 0
else
  echo "start failed, see $LOG_FILE" >&2
  exit 1
fi
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/stop.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
PID_FILE="/var/run/mihomo.pid"

# ä¼˜å…ˆæŒ‰ pidfile åœæ­¢
if [ -f "$PID_FILE" ]; then
  PID=$(cat "$PID_FILE" 2>/dev/null || true)
  if [ -n "$PID" ] && ps -p "$PID" >/dev/null 2>&1; then
    kill "$PID" 2>/dev/null || true
  fi
fi

# å…œåº•æŒ‰è¿›ç¨‹ååœæ­¢
if pgrep -x mihomo >/dev/null 2>&1; then
  # ç­‰å¾…ä¼˜é›…é€€å‡º
  for i in $(seq 1 5); do
    if pgrep -x mihomo >/dev/null 2>&1; then
      sleep 1
    else
      break
    fi
  done
  # ä»å­˜æ´»åˆ™å¼ºæ€
  if pgrep -x mihomo >/dev/null 2>&1; then
    pkill -9 -x mihomo 2>/dev/null || true
  fi
fi

# æ¸…ç†UI bind mountæˆ–è½¯é“¾æ¥
UI_MOUNT_DIR="/boot/config/plugins/easy-mihomo/ui/zashboard"
if mountpoint -q "$UI_MOUNT_DIR" 2>/dev/null; then
  echo "å¸è½½bind mount: $UI_MOUNT_DIR" >&2
  umount "$UI_MOUNT_DIR" 2>/dev/null || umount -l "$UI_MOUNT_DIR" 2>/dev/null || true
elif [ -L "$UI_MOUNT_DIR" ]; then
  echo "æ¸…ç†è½¯é“¾æ¥: $UI_MOUNT_DIR" >&2
  rm -f "$UI_MOUNT_DIR" 2>/dev/null || true
elif [ -d "$UI_MOUNT_DIR" ]; then
  echo "æ¸…ç†ç›®å½•: $UI_MOUNT_DIR" >&2
  rm -rf "$UI_MOUNT_DIR" 2>/dev/null || true
fi

# æ¸…ç† pidfileï¼ˆè‹¥è¿›ç¨‹å·²ä¸å­˜åœ¨ï¼‰
if [ -f "$PID_FILE" ]; then
  if ! ps -p $(cat "$PID_FILE" 2>/dev/null || echo 0) >/dev/null 2>&1; then
    rm -f "$PID_FILE"
  fi
fi

echo "stopped"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/restart.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
SCRIPT_DIR="/usr/local/emhttp/plugins/easy-mihomo/scripts"

bash "$SCRIPT_DIR/stop.sh" || true
sleep 1
bash "$SCRIPT_DIR/start.sh"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/status.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
PID_FILE="/var/run/mihomo.pid"
STATUS="stopped"; PID=""
if pgrep -x mihomo >/dev/null 2>&1; then STATUS="running"; PID=$(pgrep -x mihomo | head -n1); fi
echo "status=$STATUS pid=$PID"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/version.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
BIN="/usr/local/bin/mihomo"
if [ -f "$BIN" ]; then 
  # åœ¨vfatæ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œç›´æ¥å°è¯•æ‰§è¡Œ
  "$BIN" -v 2>&1 | head -n 1 || echo "binary exists but cannot execute"
else 
  echo "binary missing"
fi
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/download_core.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e

PROGRESS=0
if [ "$1" = "--progress" ]; then PROGRESS=1; fi

DOWNLOAD_DIR="/tmp/mihomo-download"
GITHUB_BASE="https://raw.githubusercontent.com/wlaosj/easy-mihomo/main"
CORE_GZ="mihomo.gz"
TMP_BIN="/tmp/mihomo-latest"
STATUS_DIR="/var/tmp/easy-mihomo-progress"
STATUS_FILE="$STATUS_DIR/core.status"
mkdir -p "$STATUS_DIR"

write_status(){
  echo "$1"
  if [ "$PROGRESS" = "1" ]; then echo "$1" > "$STATUS_FILE"; fi
}

trap 'write_status "error: unexpected failure"' ERR

mkdir -p "$DOWNLOAD_DIR"
write_status "10%: å‡†å¤‡ä¸‹è½½æ ¸å¿ƒ..."
if wget -q "$GITHUB_BASE/$CORE_GZ" -O "$DOWNLOAD_DIR/$CORE_GZ"; then
  write_status "60%: ä¸‹è½½å®Œæˆï¼Œæ­£åœ¨è§£å‹..."
else
  write_status "error: ä¸‹è½½å¤±è´¥"; exit 1
fi

if gunzip -c "$DOWNLOAD_DIR/$CORE_GZ" > "$TMP_BIN" 2>/dev/null; then
  chmod +x "$TMP_BIN"
else
  write_status "error: è§£å‹å¤±è´¥"; rm -f "$TMP_BIN"; exit 1
fi

write_status "90%: æ­£åœ¨å®‰è£…æ ¸å¿ƒ..."
mkdir -p /usr/local/bin
mkdir -p /boot/config/plugins/easy-mihomo

# åŒé‡å­˜å‚¨ï¼šUç›˜æŒä¹…åŒ– + å†…å­˜ç³»ç»ŸPATH
cp -f "$TMP_BIN" /boot/config/plugins/easy-mihomo/mihomo
cp -f "$TMP_BIN" /usr/local/bin/mihomo
chmod +x /boot/config/plugins/easy-mihomo/mihomo
chmod +x /usr/local/bin/mihomo

rm -f "$TMP_BIN"
rm -rf "$DOWNLOAD_DIR"
write_status "100%: æ ¸å¿ƒå®‰è£…å®Œæˆï¼ˆå·²ä¿å­˜åˆ°Uç›˜å’Œå†…å­˜ï¼‰"
( sleep 1; rm -f "$STATUS_FILE" ) >/dev/null 2>&1 &
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/download_ui.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e

PROGRESS=0
if [ "$1" = "--progress" ]; then PROGRESS=1; fi

UI_URL="https://github.com/Zephyruso/zashboard/releases/latest/download/dist.zip"
UI_ROOT="/boot/config/plugins/easy-mihomo"
ZIP_PATH="$UI_ROOT/zashboard.zip"
RAM_ROOT="/var/tmp/easy-mihomo-ui"
RAM_DIR="$RAM_ROOT/zashboard"
STATUS_DIR="/var/tmp/easy-mihomo-progress"
STATUS_FILE="$STATUS_DIR/ui.status"
TMP_DIR="/tmp/easy-mihomo-ui"
ZIP_FILE="$TMP_DIR/dist.zip"

mkdir -p "$STATUS_DIR" "$TMP_DIR" "$UI_ROOT" "$RAM_DIR"

write_status(){
  echo "$1"
  if [ "$PROGRESS" = "1" ]; then echo "$1" > "$STATUS_FILE"; fi
}

trap 'write_status "error: unexpected failure"' ERR

write_status "10%: æ­£åœ¨ä¸‹è½½ UI åŒ…..."
if ! wget -qO "$ZIP_FILE" --tries=3 --waitretry=1 --connect-timeout=5 --read-timeout=30 "$UI_URL"; then
  write_status "error: ä¸‹è½½å¤±è´¥"; rm -rf "$TMP_DIR"; exit 1
fi

write_status "60%: æ­£åœ¨ä¿å­˜åˆ°Uç›˜..."
# å•æ¬¡é¡ºåºå†™å…¥åˆ° U ç›˜ï¼Œå‡å°‘éšæœºå†™
mv -f "$ZIP_FILE" "$ZIP_PATH"

write_status "90%: æ­£åœ¨è§£å‹åˆ°å†…å­˜..."
# åœ¨å†…å­˜ç›®å½•ä¸­è§£å‹ï¼ˆè¦†ç›–ç°æœ‰ï¼‰
rm -rf "$RAM_DIR" && mkdir -p "$RAM_DIR"
if command -v unzip >/dev/null 2>&1; then
  unzip -oq "$ZIP_PATH" -d "$RAM_DIR"
elif command -v busybox >/dev/null 2>&1; then
  busybox unzip -oq "$ZIP_PATH" -d "$RAM_DIR"
else
  write_status "error: ç³»ç»Ÿç¼ºå°‘ unzip/busybox"; rm -rf "$TMP_DIR"; exit 1
fi
# è§„èŒƒåŒ–ï¼šå¦‚æœè§£å‹åå­˜åœ¨ dist/ å­ç›®å½•ï¼Œç§»åŠ¨å…¶å†…å®¹åˆ°æ ¹å¹¶åˆ é™¤ dist/
if [ -d "$RAM_DIR/dist" ]; then
  cp -rf "$RAM_DIR/dist/." "$RAM_DIR/"
  rm -rf "$RAM_DIR/dist"
fi

rm -rf "$TMP_DIR"
write_status "100%: UI å·²ä¿å­˜åˆ°Uç›˜å¹¶è§£å‹åˆ°å†…å­˜"
( sleep 1; rm -f "$STATUS_FILE" ) >/dev/null 2>&1 &
]]></INLINE>
</FILE>

<!-- Main page content -->
<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/EasyMihomo.Main.page">
<INLINE><![CDATA[
Menu="Utilities"
Type="xmenu"
Title="Easy-Mihomo"
Icon="icon-network"
Tabs="false"
---
<?php
include '/usr/local/emhttp/plugins/easy-mihomo/index.php';
?>
]]></INLINE>
</FILE>

<!-- post-install: setup menu entry -->
<FILE Run="/bin/bash">
<INLINE>
set -e
echo "Mihomo plugin installed. Persistent path: /boot/config/plugins/easy-mihomo"
</INLINE>
</FILE>

<!-- version cleanup -->
<FILE Run="/bin/bash">
<INLINE>
set -e
echo "Cleanup completed"
</INLINE>
</FILE>

<!-- remove -->
<FILE Run="/bin/bash" Method="remove">
<INLINE><![CDATA[
set -e
echo "æ­£åœ¨å¸è½½ Easy-Mihomo æ’ä»¶..."

# åœæ­¢mihomoè¿›ç¨‹
echo "  - æ­£åœ¨åœæ­¢ Mihomo æœåŠ¡..."
if pgrep -x mihomo >/dev/null 2>&1; then
  echo "    æ£€æµ‹åˆ°mihomoè¿›ç¨‹ï¼Œæ­£åœ¨åœæ­¢..."
  pkill -9 -x mihomo 2>/dev/null || true
  # ç­‰å¾…è¿›ç¨‹å®Œå…¨åœæ­¢
  sleep 2
  if pgrep -x mihomo >/dev/null 2>&1; then
    echo "    å¼ºåˆ¶åœæ­¢mihomoè¿›ç¨‹..."
    pkill -9 -x mihomo 2>/dev/null || true
    sleep 1
  fi
  echo "  âœ“ Mihomo æœåŠ¡å·²åœæ­¢"
else
  echo "  âœ“ Mihomo æœåŠ¡æœªè¿è¡Œ"
fi

# å¸è½½ UI bind æŒ‚è½½ï¼ˆè‹¥å­˜åœ¨ï¼‰
echo "  - å¸è½½ UI æŒ‚è½½..."
UI_MOUNT_DIR="/boot/config/plugins/easy-mihomo/ui/zashboard"
if [ -d "$UI_MOUNT_DIR" ] && mountpoint -q "$UI_MOUNT_DIR"; then
  echo "    æ£€æµ‹åˆ°bind mountï¼Œæ­£åœ¨å¸è½½..."
  umount "$UI_MOUNT_DIR" 2>/dev/null || umount -l "$UI_MOUNT_DIR" 2>/dev/null || true
  echo "    bind mountå·²å¸è½½"
elif [ -L "$UI_MOUNT_DIR" ]; then
  echo "    æ£€æµ‹åˆ°è½¯é“¾æ¥ï¼Œæ­£åœ¨åˆ é™¤..."
  rm -f "$UI_MOUNT_DIR" 2>/dev/null || true
  echo "    è½¯é“¾æ¥å·²åˆ é™¤"
else
  echo "    æ— éœ€å¤„ç†UIæŒ‚è½½"
fi
echo "  âœ“ UI æŒ‚è½½å¤„ç†å®Œæˆ"

# æ¸…ç†PIDæ–‡ä»¶
echo "  - æ¸…ç†è¿›ç¨‹æ–‡ä»¶..."
rm -f /var/run/mihomo.pid
echo "  âœ“ è¿›ç¨‹æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†äºŒè¿›åˆ¶æ–‡ä»¶
echo "  - æ¸…ç†äºŒè¿›åˆ¶æ–‡ä»¶..."
rm -f /usr/local/bin/mihomo
rm -f /boot/config/plugins/easy-mihomo/mihomo
echo "  âœ“ äºŒè¿›åˆ¶æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†æ’ä»¶ç›®å½•
echo "  - æ¸…ç†æ’ä»¶ç›®å½•..."
rm -rf /usr/local/emhttp/plugins/easy-mihomo
rm -rf /boot/config/plugins/easy-mihomo
echo "  âœ“ æ’ä»¶ç›®å½•å·²æ¸…ç†"

# æ¸…ç†å†…å­˜ä¸´æ—¶ç›®å½•
echo "  - æ¸…ç†å†…å­˜ä¸´æ—¶ç›®å½•..."
rm -rf /var/tmp/easy-mihomo-ui /var/tmp/easy-mihomo-progress /tmp/easy-mihomo-ui /tmp/mihomo-download
echo "  âœ“ å†…å­˜ä¸´æ—¶ç›®å½•å·²æ¸…ç†"

# æ¸…ç†ç³»ç»Ÿè¦†ç›–å±‚æ–‡ä»¶ï¼ˆä»…é™æœ¬æ’ä»¶å‘½åç©ºé—´ï¼‰
echo "  - æ¸…ç†ç³»ç»Ÿæ–‡ä»¶..."
rm -rf /var/local/overlay/usr/local/emhttp/plugins/easy-mihomo
rm -f /var/local/overlay/usr/local/emhttp/plugins/easy-mihomo.*
echo "  âœ“ ç³»ç»Ÿæ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
echo "  - æ¸…ç†æ—¥å¿—æ–‡ä»¶..."
rm -f /var/log/mihomo.log
echo "  âœ“ æ—¥å¿—æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
echo "  - æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
rm -f /tmp/mihomo
echo "  âœ“ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†å¼€æœºå³å¯åŠ¨æ³¨å…¥ä¸æ ‡å¿—
echo "  - æ¸…ç†å¼€æœºå¯åŠ¨é…ç½®..."
sed -i "/^# BEGIN easy-mihomo (do not edit)$/,/^# END easy-mihomo$/d" /boot/config/go 2>/dev/null || true
rm -f /boot/config/plugins/easy-mihomo/bootstart.enabled
echo "  âœ“ å¼€æœºå¯åŠ¨é…ç½®å·²æ¸…ç†"

# æ¸…ç†å®šæ—¶ä»»åŠ¡
echo "  - æ¸…ç†å®šæ—¶æ¸…ç†ä»»åŠ¡..."
crontab -l 2>/dev/null | grep -v "mihomo.*log_cleanup" | crontab - 2>/dev/null || true
echo "  âœ“ å®šæ—¶æ¸…ç†ä»»åŠ¡å·²æ¸…ç†"

echo ""
echo "ğŸ‰ Easy-Mihomo æ’ä»¶å¸è½½å®Œæˆï¼"
echo "   æ‰€æœ‰ç›¸å…³æ–‡ä»¶å’Œé…ç½®å·²å®Œå…¨æ¸…ç†ã€‚"
]]></INLINE>
</FILE>

</PLUGIN>

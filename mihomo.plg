<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
<!ENTITY name      "easy-mihomo">
<!ENTITY author    "éš”å£å°ç‹">
<!ENTITY version   "1.0.0">
<!ENTITY launch    "Settings/EasyMihomo.Main">
<!ENTITY sourceDir "/boot/config/plugins/easy-mihomo">
<!ENTITY pluginURL "https://raw.githubusercontent.com/wlaosj/easy-mihomo/main/mihomo.plg">
<!ENTITY plgPATH   "/boot/config/plugins/&name;">
<!ENTITY plgNAME   "&name;-&version;-x86_64">
<!ENTITY emhttp    "/usr/local/emhttp/plugins/&name;">
]>

<PLUGIN name="&name;" author="&author;" version="&version;" launch="&launch;" pluginURL="local" min="6.12.0" support="https://t.me/+7jcTMePlNVwwZjg1" icon="icon-network">

<CHANGES>
1.0.0  åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- æ”¯æŒåŸºæœ¬çš„ä»£ç†åŠŸèƒ½
- é›†æˆ Web ç®¡ç†ç•Œé¢
- æ”¯æŒå¼€æœºè‡ªå¯åŠ¨
- æ”¯æŒå¤šé…ç½®æ–‡ä»¶ç®¡ç†
- æ”¯æŒåœ¨çº¿ç¼–è¾‘é…ç½®
</CHANGES>

<!-- pre-install: ensure clean run dir -->
<FILE Run="/bin/bash">
<INLINE>
set -e
rm -rf &emhttp;
mkdir -p &emhttp;/scripts
mkdir -p &plgPATH;
</INLINE>
</FILE>

<!-- copy files from source directory -->
<FILE Run="/bin/bash">
<INLINE>
set -e
mkdir -p &plgPATH;
mkdir -p &emhttp;/scripts;

# ä»æºç›®å½•å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
echo "æ­£åœ¨åˆ›å»ºç›®å½•ç»“æ„..."
mkdir -p &plgPATH;
mkdir -p &emhttp;/scripts;

if [ -d "&sourceDir;" ]; then
  echo "æ­£åœ¨å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶..."
  
  # è§£å‹mihomoäºŒè¿›åˆ¶æ–‡ä»¶
  if [ -f "&sourceDir;/mihomo-linux-amd64-v3-go123-v1.19.14.gz" ]; then
    echo "  - æ­£åœ¨è§£å‹ mihomo æ ¸å¿ƒ..."
    MIHOME_TMP="/tmp/mihomo-latest"
    
    if gunzip -c "&sourceDir;/mihomo-linux-amd64-v3-go123-v1.19.14.gz" > "$MIHOME_TMP" 2>/dev/null; then
      # è§£å‹æˆåŠŸï¼Œå¤åˆ¶åˆ°ç›®æ ‡ä½ç½®
      cp "$MIHOME_TMP" "/usr/local/bin/mihomo"
      chmod +x "/usr/local/bin/mihomo"
      # å¤‡ä»½åˆ°æ’ä»¶ç›®å½•
      cp "$MIHOME_TMP" "&plgPATH;/mihomo"
      rm -f "$MIHOME_TMP"
      echo "  âœ“ mihomo æ ¸å¿ƒè§£å‹å¹¶å®‰è£…å®Œæˆ"
    else
      echo "  âŒ mihomo æ ¸å¿ƒè§£å‹å¤±è´¥"
      rm -f "$MIHOME_TMP"
      exit 1
    fi
  elif [ -f "&sourceDir;/mihomo" ]; then
    echo "  - å¤åˆ¶ mihomo äºŒè¿›åˆ¶æ–‡ä»¶..."
    cp "&sourceDir;/mihomo" "/usr/local/bin/mihomo"
    chmod +x "/usr/local/bin/mihomo"
    cp "&sourceDir;/mihomo" "&plgPATH;/mihomo"
    echo "  âœ“ mihomo äºŒè¿›åˆ¶æ–‡ä»¶å·²å®‰è£…"
  else
    echo "  âŒ æ‰¾ä¸åˆ° mihomo æ ¸å¿ƒæ–‡ä»¶"
    exit 1
  fi
  
  # é…ç½®æ–‡ä»¶éœ€è¦ç”¨æˆ·è‡ªå·±ä¸Šä¼ ï¼Œä¸å†è‡ªåŠ¨å¤åˆ¶
  
  # è§£å‹UIæ–‡ä»¶
  if [ -f "&sourceDir;/ui.tar.gz" ]; then
    echo "  - æ­£åœ¨è§£å‹UIæ–‡ä»¶ï¼ˆè§£å‹æœ‰ç‚¹æ…¢ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼Œåˆ‡å‹¿å…³é—­å®‰è£…çª—å£ï¼‰..."
    mkdir -p "&plgPATH;/ui"
    tar -xzf "&sourceDir;/ui.tar.gz" -C "&plgPATH;/ui"
    echo "  âœ“ UIæ–‡ä»¶è§£å‹å®Œæˆ"
  elif [ -d "&sourceDir;/ui" ]; then
    echo "  - æ­£åœ¨å¤åˆ¶UIæ–‡ä»¶ï¼ˆçº¦11MBï¼Œè¯·ç¨å€™ï¼‰..."
    cp -r "&sourceDir;/ui" "&plgPATH;/ui"
    echo "  âœ“ UIæ–‡ä»¶å¤åˆ¶å®Œæˆ"
  fi
  
  echo "âœ“ æ‰€æœ‰æ–‡ä»¶å·²ä» &sourceDir; å¤åˆ¶åˆ° &plgPATH;"
else
  echo "âŒ æºç›®å½• &sourceDir; æœªæ‰¾åˆ°"
  exit 1
fi
</INLINE>
</FILE>

<!-- WebUI index -->
<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/index.php">
<INLINE><![CDATA[
<?php
$baseRun = '/usr/local/emhttp/plugins/easy-mihomo';
$scripts = $baseRun . '/scripts';
$logFile = '/var/log/mihomo.log';
$binUsb  = '/boot/config/plugins/easy-mihomo/mihomo';
$confDir = '/boot/config/plugins/easy-mihomo';
$selectFile = $confDir . '/selected.conf';

// é¢„å…ˆè§£æå·²é€‰æ‹©çš„é…ç½®ï¼Œä¾›åç»­ saveconf ä¸æ¸²æŸ“ä½¿ç”¨
$selectedName = is_file($selectFile) ? trim(@file_get_contents($selectFile)) : '';
$selectedPath = ($selectedName && is_file($confDir . '/' . $selectedName)) ? ($confDir . '/' . $selectedName) : '';

$cmd = isset($_POST['cmd']) ? $_POST['cmd'] : (isset($_GET['cmd']) ? $_GET['cmd'] : '');
$msg = '';
if ($cmd === 'start') {
  $out = shell_exec("bash $scripts/start.sh 2>&1");
  $msg = htmlspecialchars($out ?? '');
}
if ($cmd === 'stop') {
  $out = shell_exec("bash $scripts/stop.sh 2>&1");
  $msg = htmlspecialchars($out ?? '');
}
if ($cmd === 'restart') {
  $out = shell_exec("bash $scripts/restart.sh 2>&1");
  $msg = htmlspecialchars($out ?? '');
}
if ($cmd === 'clearlog') {
  @file_put_contents($logFile, "");
  $msg = 'æ—¥å¿—å·²æ¸…ç©º';
}
if ($cmd === 'select_conf') {
  $name = basename($_POST['name'] ?? '');
  if ($name === '' || !preg_match('/\.(ya?ml)$/i', $name)) {
    $msg = 'æ— æ•ˆçš„é€‰æ‹©';
  } else {
    $path = $confDir . '/' . $name;
    if (is_file($path)) {
      if (@file_put_contents($selectFile, $name) !== false) {
        $msg = 'å·²é€‰æ‹©é…ç½®ï¼š' . htmlspecialchars($name);
      } else {
        $msg = 'ä¿å­˜é€‰æ‹©å¤±è´¥';
      }
    } else {
      $msg = 'æ–‡ä»¶ä¸å­˜åœ¨';
    }
  }
}
// ä¸Šä¼ åŠŸèƒ½å·²ç§»é™¤ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ°æ’ä»¶ç›®å½•
$maxSize = 1024*1024; // 1MB
if ($cmd === 'saveconf') {
  $content = $_POST['content'] ?? '';
  if ($content === '') {
    $msg = 'å†…å®¹ä¸ºç©º';
  } else if (strlen($content) > $maxSize) {
    $msg = 'å†…å®¹è¿‡å¤§ï¼ˆ>1MBï¼‰';
  } else {
    if (!$selectedPath) {
      $msg = 'æœªé€‰æ‹©é…ç½®ï¼Œè¯·å…ˆåœ¨é¡µé¢ä¸­é€‰æ‹©';
    } else {
      if (!is_dir(dirname($selectedPath))) @mkdir(dirname($selectedPath), 0777, true);
      if (@file_put_contents($selectedPath, $content) !== false) {
        $msg = 'é…ç½®å·²ä¿å­˜ï¼š' . htmlspecialchars($selectedPath);
        $shouldRestart = isset($_POST['restart']) && $_POST['restart'] === '1';
        if ($shouldRestart) {
          $out = shell_exec("bash $scripts/restart.sh 2>&1");
          $msg .= 'ï¼Œå¹¶å·²é‡å¯æœåŠ¡';
          if (!empty($out)) $msg .= ': ' . htmlspecialchars($out);
        }
      } else {
        $msg = 'ä¿å­˜å¤±è´¥';
      }
    }
  }
}
$status = shell_exec("bash $scripts/status.sh 2>&1");
$version = shell_exec("bash $scripts/version.sh 2>&1");
$logTail = file_exists($logFile) ? trim(shell_exec("tail -n 200 $logFile 2>&1")) : '';

// å¤„ç†ä¸Šä¼ é‡å®šå‘è¿”å›çš„æ¶ˆæ¯
if (isset($_GET['uploadmsg']) && $_GET['uploadmsg'] !== '') {
  $msg = $_GET['uploadmsg'];
}
// ä»…åœ¨è¾“å‡º HTML å‰è®¾ç½®å†…å®¹ç±»å‹ï¼Œé¿å…å½±å“ä¸Šä¼ é‡å®šå‘
header('Content-Type: text/html; charset=utf-8');

$confText = ($selectedPath && file_exists($selectedPath)) ? @file_get_contents($selectedPath) : '';
$available = array_values(array_filter(scandir($confDir) ?: [], function($f) use ($confDir){
  return is_file($confDir . '/' . $f) && preg_match('/\.(ya?ml)$/i', $f);
}));

// å¼€æœºå³å¯åŠ¨ï¼ˆä¸ä¾èµ–é˜µåˆ—ï¼‰è®¾ç½®
$bootFlag = '/boot/config/plugins/easy-mihomo/bootstart.enabled';
if ($cmd === 'set_bootstart') {
  $enable = ($_POST['enable'] ?? '') === '1';
  $goPath = '/boot/config/go';
  $begin = "# BEGIN easy-mihomo (do not edit)";
  $end   = "# END easy-mihomo";
  $block = $begin . "\n" .
    "(\n" .
    "cat <<'EOF' >/tmp/easy-mihomo-boot.sh\n" .
    "#!/bin/bash\n" .
    "FLAG=\"/boot/config/plugins/easy-mihomo/bootstart.enabled\"\n" .
    "START_SH=\"/usr/local/emhttp/plugins/easy-mihomo/scripts/start.sh\"\n" .
    "LOG=\"/var/log/mihomo.log\"\n" .
    "for i in \$(seq 1 60); do\n" .
    "  if [ -x \"\$START_SH\" ]; then break; fi\n" .
    "  sleep 1\n" .
    "done\n" .
    "if [ -f \"\$FLAG\" ] && [ -x \"\$START_SH\" ]; then\n" .
    "  echo \"[easy-mihomo] boot detected, starting service...\" >> \"\$LOG\" 2>&1\n" .
    "  bash \"\$START_SH\" >> \"\$LOG\" 2>&1 || true\n" .
    "fi\n" .
    "rm -f /tmp/easy-mihomo-boot.sh\n" .
    "EOF\n" .
    "bash /tmp/easy-mihomo-boot.sh &\n" .
    ")\n" .
    $end . "\n";

  if ($enable) {
    if (!is_dir(dirname($bootFlag))) @mkdir(dirname($bootFlag), 0777, true);
    @file_put_contents($bootFlag, 'enabled');
    $go = file_exists($goPath) ? @file_get_contents($goPath) : "";
    if (strpos($go, $begin) !== false && strpos($go, $end) !== false) {
      $pattern = sprintf('/%s[\s\S]*?%s\n?/m', preg_quote($begin, '/'), preg_quote($end, '/'));
      $go = preg_replace($pattern, $block, $go, 1);
    } else {
      if ($go !== "" && substr($go, -1) !== "\n") $go .= "\n";
      $go .= $block;
    }
    @file_put_contents($goPath, $go);
    $msg = 'bootstart enabled (go injected)';
  } else {
    @unlink($bootFlag);
    $go = file_exists($goPath) ? @file_get_contents($goPath) : "";
    if ($go !== "") {
      $pattern = sprintf('/%s[\s\S]*?%s\n?/m', preg_quote($begin, '/'), preg_quote($end, '/'));
      $newGo = preg_replace($pattern, '', $go, 1);
      if ($newGo !== null) @file_put_contents($goPath, $newGo);
    }
    $msg = 'bootstart disabled (go cleaned)';
  }
}
$bootstartOn = file_exists($bootFlag);

// æ£€æŸ¥å®‰è£…çŠ¶æ€
$installStatus = '';
$binExists = file_exists('/usr/local/bin/mihomo');
$uiExists = is_dir('/boot/config/plugins/easy-mihomo/ui');

// æ£€æŸ¥æ’ä»¶ç›®å½•ä¸‹æ˜¯å¦æœ‰ä»»ä½•é…ç½®æ–‡ä»¶
$confDir = '/boot/config/plugins/easy-mihomo';
$confExists = false;
if (is_dir($confDir)) {
  $files = scandir($confDir);
  foreach ($files as $file) {
    if (preg_match('/\.(ya?ml)$/i', $file)) {
      $confExists = true;
      break;
    }
  }
}

// åªæ£€æŸ¥æ ¸å¿ƒç»„ä»¶ï¼Œé…ç½®æ–‡ä»¶ç”±ç”¨æˆ·è‡ªå·±ä¸Šä¼ 
if (!$binExists) {
  $installStatus = '<div class="error">âŒ ç¼ºå°‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯·é‡æ–°å®‰è£…æ’ä»¶</div>';
} elseif (!$uiExists) {
  $installStatus = '<div class="warning">âš ï¸ ç¼ºå°‘UIæ–‡ä»¶ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨</div>';
} elseif (!$confExists) {
  $installStatus = '<div class="success">ğŸ’¡ è¯·ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ°æ’ä»¶ç›®å½•ï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹æ–‡ä»¶ç®¡ç†å™¨</div>';
}
?>
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Easy-Mihomo</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:16px;color:#222}
.card{border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px}
pre{background:#f7f7f7;border:1px solid #eee;border-radius:6px;padding:10px;max-height:360px;overflow:auto}
button{padding:8px 14px;margin-right:8px;cursor:pointer}
input[type=file]{margin-top:8px;margin-bottom:8px}
.warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:12px;border-radius:6px;margin-bottom:16px}
.error{color:#dc3545;margin:4px 0;font-size:14px}
.success{color:#28a745;margin:4px 0;font-size:14px}
</style>
<script>
function executeAction(action) {
  // ä½¿ç”¨GETå‚æ•°ç›´æ¥è·³è½¬
  var url = new URL(window.location);
  url.searchParams.set('cmd', action);
  window.location.href = url.toString();
}

function openConsole() {
  // è·å–å½“å‰é¡µé¢çš„ä¸»æœºåï¼ˆä¸åŒ…å«ç«¯å£ï¼‰
  var currentHostname = window.location.hostname;
  var consoleUrl = 'http://' + currentHostname + ':9090/ui/zashboard/#/proxies';
  // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æ§åˆ¶å°
  window.open(consoleUrl, '_blank');
}

function openFileManager() {
  // è·å–å½“å‰é¡µé¢çš„ä¸»æœºåå’Œç«¯å£
  var currentHostname = window.location.hostname;
  var currentPort = window.location.port;
  // æ„å»ºæ–‡ä»¶ç®¡ç†å™¨URLï¼Œç›´æ¥å®šä½åˆ°æ’ä»¶é…ç½®ç›®å½•
  var fileManagerUrl = 'http://' + currentHostname + ':' + currentPort + '/Main/Browse?dir=%2Fboot%2Fconfig%2Fplugins%2Feasy-mihomo';
  // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨
  window.open(fileManagerUrl, '_blank');
}

// ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿè¡¨å•æäº¤ï¼Œç¡®ä¿ emhttp æ­£å¸¸æ¥æ”¶å¸¦ Content-Length çš„ä¸Šä¼ 
</script>
</head>
<body>
<h2>Mihomo ç®¡ç†</h2>
<?php if ($installStatus) { echo $installStatus; } ?>
<?php if ($msg) { echo '<div class="card"><b>ç»“æœï¼š</b> '. $msg .'</div>'; } ?>
<div class="card">
  <div><b>çŠ¶æ€ï¼š</b> <?php
    $statusText = trim($status ?? 'unknown');
    if (strpos($statusText, 'running') !== false) {
      $pid = '';
      if (preg_match('/pid=(\d+)/', $statusText, $matches)) {
        $pid = ' (è¿›ç¨‹ID: ' . $matches[1] . ')';
      }
      echo '<span style="color: #28a745; font-weight: bold;">ğŸŸ¢ è¿è¡Œä¸­' . $pid . '</span>';
    } elseif (strpos($statusText, 'stopped') !== false) {
      echo '<span style="color: #dc3545; font-weight: bold;">ğŸ”´ å·²åœæ­¢</span>';
    } else {
      echo '<span style="color: #6c757d;">âšª ' . htmlspecialchars($statusText) . '</span>';
    }
  ?></div>
  <div><b>æ ¸å¿ƒï¼š</b> <?= htmlspecialchars(trim($version ?? 'unknown')) ?></div>
  <div><b>é…ç½®ï¼š</b> <?= $selectedPath ? htmlspecialchars($selectedPath) : 'æœªé€‰æ‹©ï¼ˆè¯·åœ¨ä¸‹æ–¹é€‰æ‹©ï¼‰' ?> | <b>äºŒè¿›åˆ¶ï¼š</b> <?= file_exists($binUsb)? htmlspecialchars($binUsb):'ç¼ºå¤±' ?></div>
  <div style="margin-top:10px">
    <button onclick="executeAction('start')">å¯åŠ¨</button>
    <button onclick="executeAction('stop')">åœæ­¢</button>
    <button onclick="executeAction('restart')">é‡å¯æœåŠ¡</button>
    <button onclick="executeAction('clearlog')">æ¸…ç©ºæ—¥å¿—</button>
    <button onclick="openConsole()">æ‰“å¼€æ§åˆ¶å°</button>
  </div>
</div>
<div class="card">
  <div><b>å¼€æœºå³å¯åŠ¨ï¼ˆä¸ä¾èµ–é˜µåˆ—ï¼‰</b></div>
  <form method="POST" style="margin-top:8px">
    <input type="hidden" name="cmd" value="set_bootstart" />
    <label>
      <input type="checkbox" name="enable" value="1" <?php if ($bootstartOn) echo 'checked'; ?> />
      å¯ç”¨åå°†åœ¨ç³»ç»Ÿå¯åŠ¨é˜¶æ®µå¯åŠ¨ï¼ˆé€šè¿‡ go æ³¨å…¥ï¼‰
    </label>
    <div style="margin-top:8px"><button type="submit">ä¿å­˜</button></div>
  </form>
  <small>ç­‰å¾…å¯åŠ¨è„šæœ¬å°±ç»ªï¼ˆæœ€å¤š 60 ç§’ï¼‰ï¼Œå¯éšæ—¶åœ¨æ­¤ç§»é™¤ã€‚</small>
</div>
<div class="card">
  <div><b>é€‰æ‹©é…ç½®æ–‡ä»¶å¯åŠ¨</b></div>
  <form method="POST" style="margin-top:8px">
    <input type="hidden" name="cmd" value="select_conf" />
    <select name="name" style="min-width:260px">
      <?php if (!$selectedName): ?>
        <option value="" disabled selected>è¯·é€‰æ‹©é…ç½®æ–‡ä»¶</option>
      <?php endif; ?>
      <?php foreach ($available as $f): ?>
        <option value="<?= htmlspecialchars($f) ?>" <?= ($f === $selectedName ? 'selected' : '') ?>><?= htmlspecialchars($f) ?></option>
      <?php endforeach; ?>
    </select>
    <button type="submit">ä¿å­˜é€‰æ‹©</button>
  </form>
  <small>æœªé€‰æ‹©é…ç½®æ—¶æ— æ³•å¯åŠ¨ï¼›ä»…åˆ—å‡ºè¯¥ç›®å½•ä¸‹çš„ .yml/.yaml æ–‡ä»¶ã€‚</small>
</div>
<div class="card">
  <div><b>é…ç½®æ–‡ä»¶ç®¡ç†</b></div>
  <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin:8px 0;">
    <strong>ğŸ“ é…ç½®æ–‡ä»¶ç›®å½•ï¼š</strong><br>
    <code>/boot/config/plugins/easy-mihomo/</code><br><br>
    <strong>ğŸ“ æ·»åŠ é…ç½®æ–‡ä»¶ï¼š</strong><br>
    1. ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ Unraid æ–‡ä»¶ç®¡ç†å™¨<br>
    2. æˆ–é€šè¿‡ SMBã€FTPã€SSH ç­‰æ–¹å¼è®¿é—® Unraid çš„ /boot åˆ†åŒº<br>
    3. ä¸Šä¼ ååˆ·æ–°é¡µé¢å³å¯åœ¨ä¸Šæ–¹é€‰æ‹©é…ç½®<br><br>
    <div style="margin-top:12px;">
      <button onclick="openFileManager()" style="background:#007bff;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">
        ğŸ“‚ æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨ä¸Šä¼ é…ç½®
      </button>
    </div>
    <br>
    <strong>ğŸ’¡ æç¤ºï¼š</strong> æ”¯æŒå¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ« .yaml/.yml æ ¼å¼
  </div>
</div>
<div class="card">
  <div><b>åœ¨çº¿ç¼–è¾‘æ‰€é€‰é…ç½®</b> <?= $selectedName? '(' . htmlspecialchars($selectedName) . ')':'' ?></div>
  <form method="POST">
    <input type="hidden" name="cmd" value="saveconf" />
    <div>
      <textarea name="content" style="width:100%;height:260px;font-family:monospace" spellcheck="false" <?= $selectedPath? '':'disabled' ?>><?php echo htmlspecialchars($confText); ?></textarea>
    </div>
    <div style="margin-top:8px">
      <label><input type="checkbox" name="restart" value="1" <?= $selectedPath? '':'disabled' ?> /> ä¿å­˜åé‡å¯æœåŠ¡</label>
    </div>
    <div style="margin-top:8px">
      <button type="submit" <?= $selectedPath? '':'disabled' ?>>ä¿å­˜é…ç½®</button>
    </div>
  </form>
  <small><?= $selectedPath? 'ä¿å­˜å°†ç›´æ¥è¦†ç›–æ‰€é€‰é…ç½®ï¼ˆä¸Šé™ 1MBï¼‰ã€‚':'å°šæœªé€‰æ‹©é…ç½®æ–‡ä»¶ï¼Œè¯·å…ˆåœ¨â€œé€‰æ‹©é…ç½®æ–‡ä»¶å¯åŠ¨â€ä¸­é€‰æ‹©ã€‚' ?></small>
</div>
<div class="card">
  <div><b>æ—¥å¿—ï¼ˆæœ€è¿‘ 200 è¡Œï¼‰ï¼š</b></div>
  <pre><?= htmlspecialchars($logTail) ?></pre>
  <div>
    <button onclick="executeAction('start')">åˆ·æ–°ï¼ˆå¹¶å°è¯•å¯åŠ¨ï¼‰</button>
  </div>
</div>
</body>
</html>
]]></INLINE>
</FILE>

<!-- scripts -->
<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/start.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
BIN="/usr/local/bin/mihomo"
CONF_DIR="/boot/config/plugins/easy-mihomo"
SELECT_FILE="$CONF_DIR/selected.conf"
if [ -f "$SELECT_FILE" ]; then
  NAME=$(cat "$SELECT_FILE" 2>/dev/null || true)
  if [ -n "$NAME" ] && [ -f "$CONF_DIR/$NAME" ]; then
    CONF_FILE="$CONF_DIR/$NAME"
  else
    echo "æœªæ‰¾åˆ°æœ‰æ•ˆçš„å·²é€‰é…ç½® ("$NAME")" >&2; exit 1
  fi
else
  echo "æœªé€‰æ‹©é…ç½®ï¼Œè¯·å…ˆåœ¨é¡µé¢ä¸­é€‰æ‹©" >&2; exit 1
fi
LOG_FILE="/var/log/mihomo.log"
PID_FILE="/var/run/mihomo.pid"

if [ ! -x "$BIN" ]; then echo "äºŒè¿›åˆ¶ç¼ºå¤±: $BIN" >&2; exit 1; fi
if [ ! -f "$CONF_FILE" ]; then echo "é…ç½®æ–‡ä»¶ç¼ºå¤±: $CONF_FILE" >&2; exit 1; fi

# å·²åœ¨è¿è¡Œåˆ™é€€å‡º
if [ -f "$PID_FILE" ]; then
  PID=$(cat "$PID_FILE" 2>/dev/null || true)
  if [ -n "$PID" ] && ps -p "$PID" >/dev/null 2>&1; then
    echo "running (pid $PID)"
    exit 0
  fi
fi

# å°è¯•åŠ è½½ TUNï¼ˆå¿½ç•¥å¤±è´¥ï¼‰
modprobe tun 2>/dev/null || true

# åå°å¯åŠ¨
nohup "$BIN" -d "$CONF_DIR" -f "$CONF_FILE" >> "$LOG_FILE" 2>&1 &
NEWPID=$!
echo $NEWPID > "$PID_FILE"
sleep 1

if ps -p "$NEWPID" >/dev/null 2>&1; then
  echo "started (pid $NEWPID)"
  exit 0
else
  echo "start failed, see $LOG_FILE" >&2
  exit 1
fi
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/stop.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
PID_FILE="/var/run/mihomo.pid"

# ä¼˜å…ˆæŒ‰ pidfile åœæ­¢
if [ -f "$PID_FILE" ]; then
  PID=$(cat "$PID_FILE" 2>/dev/null || true)
  if [ -n "$PID" ] && ps -p "$PID" >/dev/null 2>&1; then
    kill "$PID" 2>/dev/null || true
  fi
fi

# å…œåº•æŒ‰è¿›ç¨‹ååœæ­¢
if pgrep -x mihomo >/dev/null 2>&1; then
  # ç­‰å¾…ä¼˜é›…é€€å‡º
  for i in $(seq 1 5); do
    if pgrep -x mihomo >/dev/null 2>&1; then
      sleep 1
    else
      break
    fi
  done
  # ä»å­˜æ´»åˆ™å¼ºæ€
  if pgrep -x mihomo >/dev/null 2>&1; then
    pkill -9 -x mihomo 2>/dev/null || true
  fi
fi

# æ¸…ç† pidfileï¼ˆè‹¥è¿›ç¨‹å·²ä¸å­˜åœ¨ï¼‰
if [ -f "$PID_FILE" ]; then
  if ! ps -p $(cat "$PID_FILE" 2>/dev/null || echo 0) >/dev/null 2>&1; then
    rm -f "$PID_FILE"
  fi
fi

echo "stopped"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/restart.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
SCRIPT_DIR="/usr/local/emhttp/plugins/easy-mihomo/scripts"

bash "$SCRIPT_DIR/stop.sh" || true
sleep 1
bash "$SCRIPT_DIR/start.sh"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/status.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
PID_FILE="/var/run/mihomo.pid"
STATUS="stopped"; PID=""
if pgrep -x mihomo >/dev/null 2>&1; then STATUS="running"; PID=$(pgrep -x mihomo | head -n1); fi
echo "status=$STATUS pid=$PID"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/version.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
BIN="/usr/local/bin/mihomo"
if [ -f "$BIN" ]; then 
  # åœ¨vfatæ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œç›´æ¥å°è¯•æ‰§è¡Œ
  "$BIN" -v 2>&1 | head -n 1 || echo "binary exists but cannot execute"
else 
  echo "binary missing"
fi
]]></INLINE>
</FILE>

<!-- Main page content -->
<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/EasyMihomo.Main.page">
<INLINE><![CDATA[
Menu="Utilities"
Type="xmenu"
Title="Easy-Mihomo"
Icon="icon-network"
Tabs="false"
---
<?php
include '/usr/local/emhttp/plugins/easy-mihomo/index.php';
?>
]]></INLINE>
</FILE>

<!-- post-install: setup menu entry -->
<FILE Run="/bin/bash">
<INLINE>
set -e
mkdir -p &emhttp;/scripts;

echo "Mihomo plugin installed. Persistent path: &plgPATH;"
</INLINE>
</FILE>

<!-- version cleanup -->
<FILE Run="/bin/bash">
<INLINE>
set -e
echo "Cleanup completed"
</INLINE>
</FILE>

<!-- remove -->
<FILE Run="/bin/bash" Method="remove">
<INLINE>
set -e
echo "æ­£åœ¨å¸è½½ Easy-Mihomo æ’ä»¶..."

# åœæ­¢mihomoè¿›ç¨‹
echo "  - æ­£åœ¨åœæ­¢ Mihomo æœåŠ¡..."
if pgrep -x mihomo >/dev/null 2>&amp;1; then
  pkill -9 -x mihomo 2>/dev/null || true
  echo "  âœ“ Mihomo æœåŠ¡å·²åœæ­¢"
else
  echo "  âœ“ Mihomo æœåŠ¡æœªè¿è¡Œ"
fi

# æ¸…ç†PIDæ–‡ä»¶
echo "  - æ¸…ç†è¿›ç¨‹æ–‡ä»¶..."
rm -f /var/run/mihomo.pid
echo "  âœ“ è¿›ç¨‹æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†äºŒè¿›åˆ¶æ–‡ä»¶
echo "  - æ¸…ç†äºŒè¿›åˆ¶æ–‡ä»¶..."
rm -f /usr/local/bin/mihomo
echo "  âœ“ äºŒè¿›åˆ¶æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†æ’ä»¶ç›®å½•
echo "  - æ¸…ç†æ’ä»¶ç›®å½•..."
rm -rf &emhttp;
rm -rf &plgPATH;
echo "  âœ“ æ’ä»¶ç›®å½•å·²æ¸…ç†"

# æ¸…ç†ç³»ç»Ÿè¦†ç›–å±‚æ–‡ä»¶ï¼ˆä»…é™æœ¬æ’ä»¶å‘½åç©ºé—´ï¼‰
echo "  - æ¸…ç†ç³»ç»Ÿæ–‡ä»¶..."
rm -rf /var/local/overlay/usr/local/emhttp/plugins/easy-mihomo
rm -f /var/local/overlay/usr/local/emhttp/plugins/easy-mihomo.*
echo "  âœ“ ç³»ç»Ÿæ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
echo "  - æ¸…ç†æ—¥å¿—æ–‡ä»¶..."
rm -f /var/log/mihomo.log
echo "  âœ“ æ—¥å¿—æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
echo "  - æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
rm -f /tmp/mihomo
echo "  âœ“ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†å¼€æœºå³å¯åŠ¨æ³¨å…¥ä¸æ ‡å¿—
echo "  - æ¸…ç†å¼€æœºå¯åŠ¨é…ç½®..."
sed -i "/^# BEGIN easy-mihomo (do not edit)$/,/^# END easy-mihomo$/d" /boot/config/go 2>/dev/null || true
rm -f /boot/config/plugins/easy-mihomo/bootstart.enabled
echo "  âœ“ å¼€æœºå¯åŠ¨é…ç½®å·²æ¸…ç†"

echo ""
echo "ğŸ‰ Easy-Mihomo æ’ä»¶å¸è½½å®Œæˆï¼"
echo "   æ‰€æœ‰ç›¸å…³æ–‡ä»¶å’Œé…ç½®å·²å®Œå…¨æ¸…ç†ã€‚"
</INLINE>
</FILE>

</PLUGIN>

<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
<!ENTITY name      "easy-mihomo">
<!ENTITY author    "éš”å£å°ç‹">
<!ENTITY version   "1.1.0">
<!ENTITY launch    "Settings/EasyMihomo.Main">
<!ENTITY sourceDir "/boot/config/plugins/easy-mihomo">
<!ENTITY pluginURL "https://raw.githubusercontent.com/wlaosj/easy-mihomo/refs/heads/main/mihomo.plg">
<!ENTITY plgPATH   "/boot/config/plugins/&name;">
<!ENTITY plgNAME   "&name;-&version;-x86_64">
<!ENTITY emhttp    "/usr/local/emhttp/plugins/&name;">
]>

<PLUGIN name="&name;" author="&author;" version="&version;" launch="&launch;" pluginURL="&pluginURL;" min="6.12.0" support="https://t.me/+7jcTMePlNVwwZjg1" icon="icon-network">

<CHANGES>
1.1.0  å®Œæ•´åŠŸèƒ½ç‰ˆ
- â­ æ ¸å¿ƒä¸UIè‡ªåŠ¨æ£€æµ‹æ›´æ–°ï¼Œä¸€é”®å‡çº§
- â­ æ”¯æŒ3ç§CPUæ¶æ„ï¼šæ ‡å‡†ç‰ˆ/å…¼å®¹ç‰ˆ/v3ä¼˜åŒ–ç‰ˆ
- â­ æ™ºèƒ½ä¸‹è½½ç®¡ç†ï¼šè‡ªåŠ¨é‡è¯•ã€è¿›åº¦æ˜¾ç¤ºã€é”™è¯¯æç¤º
- æ ¸å¿ƒæ˜¾ç¤ºå®é™…å®‰è£…çš„ç‰ˆæœ¬ç±»å‹ï¼ˆå¦‚ 1.19.15 [v3ä¼˜åŒ–ç‰ˆ]ï¼‰
- æ”¯æŒæœåŠ¡è¿è¡Œæ—¶ä¸‹è½½æ ¸å¿ƒï¼ˆé‡å¯åç”Ÿæ•ˆï¼‰
- æ—¥å¿—è‡ªåŠ¨æ¸…ç†ï¼šæ¯6å°æ—¶æ£€æŸ¥ï¼Œè¶…è¿‡2MBä¿ç•™æœ€è¿‘1000è¡Œ
- ç•Œé¢å¸ƒå±€ä¼˜åŒ–ï¼šæ“ä½œæ›´æµç•…ï¼Œä¿¡æ¯æ›´æ¸…æ™°

1.0.3  é…ç½®ç®¡ç†ä¼˜åŒ–ç‰ˆ
- ä¼˜åŒ–ï¼šç®€åŒ–é…ç½®è¦†å†™é€»è¾‘ï¼Œåªè¦†å†™UIç›¸å…³é…ç½®é¡¹ï¼ˆexternal-ui-url/nameã€external-uiï¼‰
- ä¼˜åŒ–ï¼šç«¯å£å’Œå¯†ç ä¿¡æ¯ä»é…ç½®æ–‡ä»¶åŠ¨æ€è¯»å–ï¼Œæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰é…ç½®
- ä¼˜åŒ–ï¼šé¡µé¢æ˜¾ç¤ºä¿¡æ¯ä¸å®é™…é…ç½®å®Œå…¨ä¸€è‡´ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- ä¼˜åŒ–ï¼šä»ªè¡¨æ¿å’Œæ§åˆ¶å°é“¾æ¥ä½¿ç”¨åŠ¨æ€ç«¯å£ï¼Œæ”¯æŒè‡ªå®šä¹‰ç«¯å£é…ç½®
- ä¼˜åŒ–ï¼šå‡å°‘ä¸å¿…è¦çš„é…ç½®å¹²é¢„ï¼Œç»™ç”¨æˆ·æ›´å¤šé…ç½®çµæ´»æ€§
- ä¿®å¤ï¼šç¡®ä¿é…ç½®ä¿®æ”¹åé¡µé¢æ˜¾ç¤ºç«‹å³åæ˜ å˜åŒ–

1.0.2  åŠŸèƒ½ä¸ä½“éªŒæ›´æ–°
- ä¿®å¤ï¼šé…ç½®ç¼–è¾‘å™¨ä¿å­˜ä¸ç”Ÿæ•ˆï¼ˆæå‰åˆå§‹åŒ–å·²é€‰é…ç½®å¹¶åœ¨ä¿å­˜æ—¶é˜²å¾¡æ€§å›è¯»ï¼‰
- ä¼˜åŒ–ï¼šå¯åŠ¨æ—¶ç»Ÿä¸€æ ‡å‡†åŒ–å…³é”®é…ç½®é¡¹ï¼ˆexternal-ui-url/nameã€external-uiã€external-controllerã€secretï¼‰ï¼Œè‡ªåŠ¨è¦†å†™æˆ–è¿½åŠ ä»¥æå‡å…¼å®¹æ€§
- æ¸…ç†ï¼šç§»é™¤é‡å¤ external-ui è¦†å†™ï¼Œåˆå¹¶ä¸ºä¸€æ¬¡å¤‡ä»½+ç»Ÿä¸€ upsert
- ä½“éªŒï¼šåœ¨"æ‰“å¼€æ§åˆ¶å°"åæ–°å¢ä¸»æœº/ç«¯å£/å¯†ç è¡Œå†…æç¤ºï¼ˆä¸»æœºè‡ªåŠ¨å–å½“å‰å†…ç½‘IPï¼Œç«¯å£9090ï¼Œå¯†ç yyds666ï¼‰
- æ–°å¢ï¼šä»ªè¡¨æ¿æ˜¾ç¤ºæ¨¡å—ï¼ˆè‡ªåŠ¨5ç§’åˆ·æ–°çŠ¶æ€/ç‰ˆæœ¬/é…ç½®/å†…å­˜/è¿è¡Œæ—¶é—´ï¼Œå«å¿«æ·æ“ä½œï¼‰

1.0.1  æ—¥å¿—ç®¡ç†å¢å¼ºç‰ˆ
- æ–°å¢è‡ªåŠ¨æ—¥å¿—æ¸…ç†åŠŸèƒ½
- æ”¯æŒå®šæœŸæ¸…ç†ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
- æ™ºèƒ½ä¿ç•™æœ€è¿‘1000è¡Œæ—¥å¿—
- æ·»åŠ æ—¥å¿—çŠ¶æ€ç›‘æ§æ˜¾ç¤º
- æ–°å¢æ‰‹åŠ¨æ™ºèƒ½æ¸…ç†æŒ‰é’®
- ä¼˜åŒ–æ—¥å¿—æ–‡ä»¶å¤§å°ç®¡ç†
- æ”¹è¿›é…ç½®é€‰æ‹©ä½“éªŒï¼Œæ”¯æŒè‡ªåŠ¨ä¿å­˜
- æ–°å¢å¼¹å‡ºå¼é…ç½®ç¼–è¾‘å™¨ï¼Œæä¾›æ›´å¤§ç¼–è¾‘ç©ºé—´
- ä¼˜åŒ–ç•Œé¢å¸ƒå±€ï¼Œæ“ä½œæŒ‰é’®æ›´åˆç†
- æ”¹è¿›ä¸‹è½½è¿›åº¦æ˜¾ç¤ºï¼Œæ”¯æŒè‡ªåŠ¨æ¶ˆå¤±æç¤º
- æ›´æ–°æ ¸å¿ƒç‰ˆæœ¬åˆ° v1.19.15

1.0.0  åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- æ”¯æŒåŸºæœ¬çš„ä»£ç†åŠŸèƒ½
- é›†æˆ Web ç®¡ç†ç•Œé¢
- æ”¯æŒå¼€æœºè‡ªå¯åŠ¨
- æ”¯æŒå¤šé…ç½®æ–‡ä»¶ç®¡ç†
- æ”¯æŒåœ¨çº¿ç¼–è¾‘é…ç½®
</CHANGES>

<!-- pre-install: ensure clean run dir -->
<FILE Run="/bin/bash">
<INLINE>
set -e
rm -rf /usr/local/emhttp/plugins/easy-mihomo
mkdir -p /usr/local/emhttp/plugins/easy-mihomo/scripts
mkdir -p /boot/config/plugins/easy-mihomo
</INLINE>
</FILE>

<!-- copy files from source directory -->
<FILE Run="/bin/bash">
<INLINE><![CDATA[
set -e
# ä»æºç›®å½•å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
echo "æ­£åœ¨åˆ›å»ºç›®å½•ç»“æ„..."

# åœæ­¢æ­£åœ¨è¿è¡Œçš„mihomoæœåŠ¡
echo "æ­£åœ¨åœæ­¢mihomoæœåŠ¡..."
if pgrep -x mihomo >/dev/null 2>&1; then
  pkill -x mihomo 2>/dev/null || true
  sleep 2
  echo "  âœ“ mihomoæœåŠ¡å·²åœæ­¢"
else
  echo "  âœ“ mihomoæœåŠ¡æœªè¿è¡Œ"
fi

# ä»GitHubä¸‹è½½å¹¶å®‰è£…æ–‡ä»¶
echo "è·³è¿‡è‡ªåŠ¨ä¸‹è½½æ ¸å¿ƒä¸UIï¼šå°†ç”±æ’ä»¶é¡µé¢æä¾›æ‰‹åŠ¨ä¸‹è½½/æ›´æ–°å…¥å£"

# åˆ›å»ºå®šæœŸæ—¥å¿—æ¸…ç†è„šæœ¬
echo "  - æ­£åœ¨åˆ›å»ºæ—¥å¿—æ¸…ç†è„šæœ¬..."
cat > "/usr/local/emhttp/plugins/easy-mihomo/scripts/log_cleanup.sh" << 'EOF'
#!/bin/bash
# Mihomo æ—¥å¿—å®šæœŸæ¸…ç†è„šæœ¬
LOG_FILE="/var/log/mihomo.log"
MAX_SIZE="2MB"  # æœ€å¤§æ—¥å¿—å¤§å°
KEEP_LINES=1000  # ä¿ç•™è¡Œæ•°

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$LOG_FILE" ]; then
    exit 0
fi

# è·å–æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
FILE_SIZE=$(stat -c%s "$LOG_FILE" 2>/dev/null || echo 0)

# è§£ææœ€å¤§å¤§å°
case "$MAX_SIZE" in
    *MB) MAX_BYTES=$((${MAX_SIZE%MB} * 1024 * 1024)) ;;
    *KB) MAX_BYTES=$((${MAX_SIZE%KB} * 1024)) ;;
    *) MAX_BYTES=10485760 ;; # é»˜è®¤10MB
esac

# å¦‚æœæ–‡ä»¶è¶…è¿‡å¤§å°é™åˆ¶ï¼Œè¿›è¡Œæ¸…ç†
if [ "$FILE_SIZE" -gt "$MAX_BYTES" ]; then
    echo "[$(date)] æ—¥å¿—æ–‡ä»¶è¿‡å¤§ (${FILE_SIZE} bytes)ï¼Œå¼€å§‹æ¸…ç†..." >> "$LOG_FILE"
    # ä¿ç•™æœ€åKEEP_LINESè¡Œ
    tail -n "$KEEP_LINES" "$LOG_FILE" > "${LOG_FILE}.tmp" && mv "${LOG_FILE}.tmp" "$LOG_FILE"
    echo "[$(date)] æ—¥å¿—æ¸…ç†å®Œæˆï¼Œä¿ç•™æœ€è¿‘ $KEEP_LINES è¡Œ" >> "$LOG_FILE"
fi
EOF

chmod +x "/usr/local/emhttp/plugins/easy-mihomo/scripts/log_cleanup.sh"
echo "  âœ“ æ—¥å¿—æ¸…ç†è„šæœ¬å·²åˆ›å»º"

# åˆ›å»ºä»ªè¡¨æ¿JavaScriptæ–‡ä»¶
echo "  - æ­£åœ¨åˆ›å»ºä»ªè¡¨æ¿JavaScriptæ–‡ä»¶..."
cat > "/usr/local/emhttp/plugins/easy-mihomo/scripts/mihomo-dashboard.js" << 'EOF'
/*
  MIT License

  Copyright (c) 2024 Easy-Mihomo

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in all
  copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
*/

/**
 * Mihomo Dashboard JavaScript Functions
 * æä¾›ä»ªè¡¨æ¿å®æ—¶æ•°æ®æ›´æ–°åŠŸèƒ½
 */

// å…¨å±€å˜é‡
let mihomoDashboardInterval = null;
let mihomoLastUpdate = 0;

/**
 * åˆ·æ–°mihomoä»ªè¡¨æ¿æ•°æ®
 */
function refreshMihomoDashboard() {
    const now = Date.now();
    
    // é˜²æ­¢è¿‡äºé¢‘ç¹çš„è¯·æ±‚ï¼ˆæœ€å°é—´éš”1ç§’ï¼‰
    if (now - mihomoLastUpdate < 1000) {
        return;
    }
    
    mihomoLastUpdate = now;
    
    $.getJSON('/plugins/easy-mihomo/api.php?cmd=dashboard_status')
        .done(function(data) {
            updateMihomoDashboard(data);
        })
        .fail(function(xhr, status, error) {
            console.error('Failed to fetch mihomo dashboard data:', error);
            showMihomoError();
        });
}

/**
 * æ›´æ–°ä»ªè¡¨æ¿æ˜¾ç¤º
 * @param {Object} data - ä»APIè·å–çš„æ•°æ®
 */
function updateMihomoDashboard(data) {
    if (!data) {
        showMihomoError();
        return;
    }
    
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    updateMihomoStatus(data);
    
    // æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
    updateMihomoVersion(data);
    
    // æ›´æ–°æœåŠ¡çŠ¶æ€
    updateMihomoService(data);
    
    // æ›´æ–°é…ç½®ä¿¡æ¯
    updateMihomoConfig(data);
    
    // æ›´æ–°å†…å­˜ä½¿ç”¨ä¿¡æ¯
    updateMihomoMemory(data);
    
    // æ›´æ–°è¿è¡Œæ—¶é—´ä¿¡æ¯
    updateMihomoUptime(data);
}

/**
 * æ›´æ–°mihomoè¿è¡ŒçŠ¶æ€
 * @param {Object} data - æ•°æ®å¯¹è±¡
 */
function updateMihomoStatus(data) {
    const statusIcon = $('.mihomo-status-icon');
    const statusText = $('.mihomo-status-text');
    
    // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
    statusIcon.removeClass('running stopped loading');
    
    if (data.running) {
        statusIcon.addClass('running');
        statusText.text(_('è¿è¡Œä¸­'));
    } else {
        statusIcon.addClass('stopped');
        statusText.text(_('å·²åœæ­¢'));
    }
}

/**
 * æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
 * @param {Object} data - æ•°æ®å¯¹è±¡
 */
function updateMihomoVersion(data) {
    const versionText = $('#mihomo-version');
    const version = data.version || _('æœªçŸ¥');
    versionText.text(_('ç‰ˆæœ¬: ') + version);
}

/**
 * æ›´æ–°æœåŠ¡çŠ¶æ€
 * @param {Object} data - æ•°æ®å¯¹è±¡
 */
function updateMihomoService(data) {
    const serviceStatus = $('.mihomo-service-status');
    
    if (data.running) {
        serviceStatus.html('<span style="color:#28a745;font-weight:bold;">' + _('è¿è¡Œä¸­') + '</span>');
    } else {
        serviceStatus.html('<span style="color:#dc3545;font-weight:bold;">' + _('å·²åœæ­¢') + '</span>');
    }
}

/**
 * æ›´æ–°é…ç½®ä¿¡æ¯
 * @param {Object} data - æ•°æ®å¯¹è±¡
 */
function updateMihomoConfig(data) {
    const configInfo = $('.mihomo-config-info');
    
    if (data.config && data.config.has_config) {
        const configName = data.config.selected_config || _('æœªçŸ¥');
        configInfo.html('<span style="color:#28a745;">' + configName + '</span>');
    } else {
        configInfo.html('<span style="color:#dc3545;">' + _('æœªé€‰æ‹©é…ç½®') + '</span>');
    }
}

/**
 * æ›´æ–°å†…å­˜ä½¿ç”¨ä¿¡æ¯
 * @param {Object} data - æ•°æ®å¯¹è±¡
 */
function updateMihomoMemory(data) {
    const memoryInfo = $('.mihomo-memory-info');
    
    if (data.running && data.memory) {
        memoryInfo.html('<span style="color:#17a2b8;">' + data.memory + '</span>');
    } else {
        memoryInfo.html('<span style="color:#6c757d;">' + _('æœªçŸ¥') + '</span>');
    }
}

/**
 * æ›´æ–°è¿è¡Œæ—¶é—´ä¿¡æ¯
 * @param {Object} data - æ•°æ®å¯¹è±¡
 */
function updateMihomoUptime(data) {
    const uptimeInfo = $('.mihomo-uptime-info');
    
    if (data.running && data.uptime) {
        uptimeInfo.html('<span style="color:#28a745;">' + data.uptime + '</span>');
    } else {
        uptimeInfo.html('<span style="color:#6c757d;">' + _('æœªçŸ¥') + '</span>');
    }
}

/**
 * æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
 */
function showMihomoError() {
    $('.mihomo-status-icon').removeClass('running stopped').addClass('loading');
    $('.mihomo-status-text').text(_('çŠ¶æ€: é”™è¯¯'));
    $('.mihomo-service-status').text(_('é”™è¯¯'));
    $('.mihomo-config-info').text(_('é”™è¯¯'));
    $('.mihomo-memory-info').text(_('é”™è¯¯'));
    $('.mihomo-uptime-info').text(_('é”™è¯¯'));
}

/**
 * å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
 * @param {number} interval - åˆ·æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰
 */
function startMihomoDashboardRefresh(interval = 5000) {
    // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
    if (mihomoDashboardInterval) {
        clearInterval(mihomoDashboardInterval);
    }
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    refreshMihomoDashboard();
    
    // è®¾ç½®å®šæ—¶åˆ·æ–°
    mihomoDashboardInterval = setInterval(refreshMihomoDashboard, interval);
}

/**
 * åœæ­¢è‡ªåŠ¨åˆ·æ–°
 */
function stopMihomoDashboardRefresh() {
    if (mihomoDashboardInterval) {
        clearInterval(mihomoDashboardInterval);
        mihomoDashboardInterval = null;
    }
}

/**
 * æ‰‹åŠ¨åˆ·æ–°ä»ªè¡¨æ¿
 */
function manualRefreshMihomoDashboard() {
    refreshMihomoDashboard();
}

// é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¯åŠ¨
$(document).ready(function() {
    // æ£€æŸ¥æ˜¯å¦åœ¨ä»ªè¡¨æ¿é¡µé¢
    if ($('#tblMihomoDash').length > 0) {
        startMihomoDashboardRefresh(5000);
    }
});

// é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
$(window).on('beforeunload', function() {
    stopMihomoDashboardRefresh();
});
EOF

chmod +x "/usr/local/emhttp/plugins/easy-mihomo/scripts/mihomo-dashboard.js"
echo "  âœ“ ä»ªè¡¨æ¿JavaScriptæ–‡ä»¶å·²åˆ›å»º"

# æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹æ¸…ç†ï¼‰
echo "  - æ­£åœ¨è®¾ç½®å®šæ—¶æ¸…ç†ä»»åŠ¡..."
# ç§»é™¤æ—§çš„å®šæ—¶ä»»åŠ¡
crontab -l 2>/dev/null | grep -v "mihomo.*log_cleanup" | crontab - 2>/dev/null || true
# æ·»åŠ æ–°çš„å®šæ—¶ä»»åŠ¡ï¼ˆæ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼‰
(crontab -l 2>/dev/null; echo "0 */6 * * * /usr/local/emhttp/plugins/easy-mihomo/scripts/log_cleanup.sh >/dev/null 2>&1") | crontab - 2>/dev/null || true
echo "  âœ“ å®šæ—¶æ¸…ç†ä»»åŠ¡å·²è®¾ç½®ï¼ˆæ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼‰"

# å®‰è£…é˜¶æ®µå®Œæˆï¼ˆæ ¸å¿ƒ/UI ä¸‹è½½æ”¹ä¸ºé¡µé¢æ‰‹åŠ¨è§¦å‘ï¼‰
echo "âœ“ æ’ä»¶åŸºç¡€æ–‡ä»¶éƒ¨ç½²å®Œæˆï¼ˆæœªè‡ªåŠ¨ä¸‹è½½æ ¸å¿ƒä¸UIï¼‰"
]]></INLINE>
</FILE>

<!-- WebUI index -->
<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/index.php">
<INLINE><![CDATA[
<?php
$baseRun = '/usr/local/emhttp/plugins/easy-mihomo';
$scripts = $baseRun . '/scripts';
$logFile = '/var/log/mihomo.log';
$confDir = '/boot/config/plugins/easy-mihomo';
$selectFile = $confDir . '/selected.conf';
$variantFile = $confDir . '/variant.conf';

// æå‰è¯»å–å½“å‰é€‰æ‹©çš„é…ç½®ï¼Œä¾›åç»­å‘½ä»¤å¤„ç†ï¼ˆå¦‚ saveconfï¼‰ä½¿ç”¨
$selectedName = is_file($selectFile) ? trim(@file_get_contents($selectFile)) : '';
$selectedPath = ($selectedName && is_file($confDir . '/' . $selectedName)) ? ($confDir . '/' . $selectedName) : '';

// è¯»å–å½“å‰é€‰æ‹©çš„ç‰ˆæœ¬ç±»å‹ï¼ˆé»˜è®¤ standardï¼‰
$currentVariant = is_file($variantFile) ? trim(@file_get_contents($variantFile)) : 'standard';
if (!in_array($currentVariant, ['standard', 'compatible', 'v3'])) {
  $currentVariant = 'standard';
}

// è¿›åº¦æ–‡ä»¶ç›®å½•
$progressDir = '/var/tmp/easy-mihomo-progress';
@mkdir($progressDir, 0777, true);

$cmd = isset($_POST['cmd']) ? $_POST['cmd'] : (isset($_GET['cmd']) ? $_GET['cmd'] : '');
$msg = '';

// å…ˆå¤„ç†å‘½ä»¤ï¼Œå†è¯»å–é…ç½®çŠ¶æ€

// æ—©æœŸæ‹¦æˆªï¼šè¿›åº¦è½®è¯¢ï¼Œç›´æ¥è¾“å‡ºæ–‡æœ¬å¹¶é€€å‡º
if ($cmd === 'get_progress') {
  $target = $_GET['target'] ?? $_POST['target'] ?? '';
  $file = '';
  if ($target === 'core') $file = $progressDir . '/core.status';
  if ($target === 'ui')   $file = $progressDir . '/ui.status';
  header('Content-Type: text/plain; charset=utf-8');
  if ($file && is_file($file)) {
    echo @file_get_contents($file);
  }
  exit;
}
if ($cmd === 'start') {
  $out = shell_exec("bash $scripts/start.sh 2>&1");
  $msg = htmlspecialchars($out ?? '');
}
if ($cmd === 'stop') {
  $out = shell_exec("bash $scripts/stop.sh 2>&1");
  $msg = htmlspecialchars($out ?? '');
}
if ($cmd === 'restart') {
  $out = shell_exec("bash $scripts/restart.sh 2>&1");
  $msg = htmlspecialchars($out ?? '');
}
if ($cmd === 'clearlog') {
  @file_put_contents($logFile, "");
  $msg = 'æ—¥å¿—å·²æ¸…ç©º';
}
if ($cmd === 'cleanup_log') {
  $out = shell_exec("bash $scripts/log_cleanup.sh 2>&1");
  $msg = 'æ—¥å¿—æ¸…ç†å®Œæˆ: ' . htmlspecialchars($out ?? '');
}
if ($cmd === 'start_download') {
  $target = $_GET['target'] ?? $_POST['target'] ?? '';
  if ($target === 'core') {
    @unlink($progressDir . '/core.status');
    $out = shell_exec("nohup bash $scripts/download_core.sh --progress >$progressDir/core.log 2>&1 & echo $!");
    $msg = 'æ ¸å¿ƒä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ PID: ' . htmlspecialchars(trim($out));
  } elseif ($target === 'ui') {
    @unlink($progressDir . '/ui.status');
    $out = shell_exec("nohup bash $scripts/download_ui.sh --progress >$progressDir/ui.log 2>&1 & echo $!");
    $msg = 'UI ä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ PID: ' . htmlspecialchars(trim($out));
  } else {
    $msg = 'æœªçŸ¥çš„ä¸‹è½½ç›®æ ‡';
  }
  // è‹¥ä¸ºå¼‚æ­¥è¯·æ±‚ï¼ˆajax=1ï¼‰ï¼Œä»…è¿”å›çº¯æ–‡æœ¬å¹¶é€€å‡ºï¼Œé¿å…æ•´é¡µHTMLå›å¡«åˆ°æ¶ˆæ¯åŒºåŸŸ
  if ((isset($_GET['ajax']) && $_GET['ajax'] === '1') || (isset($_POST['ajax']) && $_POST['ajax'] === '1')) {
    header('Content-Type: text/plain; charset=utf-8');
    echo $msg;
    exit;
  }
}
if ($cmd === 'select_conf') {
  $name = basename($_POST['name'] ?? '');
  if ($name === '' || !preg_match('/\.(ya?ml)$/i', $name)) {
    $msg = 'æ— æ•ˆçš„é€‰æ‹©';
  } else {
    $path = $confDir . '/' . $name;
    if (is_file($path)) {
      if (@file_put_contents($selectFile, $name) !== false) {
        $msg = 'å·²é€‰æ‹©é…ç½®ï¼š' . htmlspecialchars($name);
      } else {
        $msg = 'ä¿å­˜é€‰æ‹©å¤±è´¥';
      }
    } else {
      $msg = 'æ–‡ä»¶ä¸å­˜åœ¨';
    }
  }
}
if ($cmd === 'set_variant') {
  $variant = $_POST['variant'] ?? '';
  if (!in_array($variant, ['standard', 'compatible', 'v3'])) {
    $msg = 'æ— æ•ˆçš„ç‰ˆæœ¬ç±»å‹';
  } else {
    if (@file_put_contents($variantFile, $variant) !== false) {
      $variantNames = [
        'standard' => 'æ ‡å‡†ç‰ˆï¼ˆx86-64-v2ï¼Œæ¨èï¼‰',
        'compatible' => 'å…¼å®¹ç‰ˆï¼ˆè€æ—§CPUæ”¯æŒï¼‰',
        'v3' => 'v3ä¼˜åŒ–ç‰ˆï¼ˆé«˜æ€§èƒ½ï¼Œéœ€æ–°CPUï¼‰'
      ];
      $msg = 'å·²é€‰æ‹©ï¼š' . htmlspecialchars($variantNames[$variant]);
      $currentVariant = $variant; // ç«‹å³æ›´æ–°å½“å‰å€¼
    } else {
      $msg = 'ä¿å­˜å¤±è´¥';
    }
  }
}
// ä¸Šä¼ åŠŸèƒ½å·²ç§»é™¤ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ°æ’ä»¶ç›®å½•
$maxSize = 1024*1024; // 1MB
if ($cmd === 'saveconf') {
  $content = $_POST['content'] ?? '';
  if ($content === '') {
    $msg = 'å†…å®¹ä¸ºç©º';
  } else if (strlen($content) > $maxSize) {
    $msg = 'å†…å®¹è¿‡å¤§ï¼ˆ>1MBï¼‰';
  } else {
    // é˜²å¾¡æ€§ï¼šè‹¥ä¸‹æ–¹æœªè¯»å–åˆ°ï¼Œå‘½ä»¤é˜¶æ®µå†æ¬¡è§£æä¸€æ¬¡
    if (!$selectedPath) {
      $selectedNameCmd = is_file($selectFile) ? trim(@file_get_contents($selectFile)) : '';
      $selectedPath = ($selectedNameCmd && is_file($confDir . '/' . $selectedNameCmd)) ? ($confDir . '/' . $selectedNameCmd) : '';
    }
    if (!$selectedPath) {
      $msg = 'æœªé€‰æ‹©é…ç½®ï¼Œè¯·å…ˆåœ¨é¡µé¢ä¸­é€‰æ‹©';
    } else {
      if (!is_dir(dirname($selectedPath))) @mkdir(dirname($selectedPath), 0777, true);
      if (@file_put_contents($selectedPath, $content) !== false) {
        $msg = 'é…ç½®å·²ä¿å­˜ï¼š' . htmlspecialchars($selectedPath);
        $shouldRestart = isset($_POST['restart']) && $_POST['restart'] === '1';
        if ($shouldRestart) {
          $out = shell_exec("bash $scripts/restart.sh 2>&1");
          $msg .= 'ï¼Œå¹¶å·²é‡å¯æœåŠ¡';
          if (!empty($out)) $msg .= ': ' . htmlspecialchars($out);
        }
      } else {
        $msg = 'ä¿å­˜å¤±è´¥';
      }
    }
  }
}
$status = shell_exec("bash $scripts/status.sh 2>&1");
$version = shell_exec("bash $scripts/version.sh 2>&1");
$uiVersion = shell_exec("bash $scripts/ui_version.sh 2>&1");
$logTail = file_exists($logFile) ? trim(shell_exec("tail -n 200 $logFile 2>&1")) : '';

// è¯»å–å®é™…å®‰è£…çš„ç‰ˆæœ¬ç±»å‹ï¼ˆä» .version æ–‡ä»¶ï¼‰
$installedVariant = 'standard'; // é»˜è®¤å€¼
$versionFile = '/boot/config/plugins/easy-mihomo/.version';
if (file_exists($versionFile)) {
  $versionContent = trim(@file_get_contents($versionFile));
  if (strpos($versionContent, '|') !== false) {
    // æ–°æ ¼å¼ï¼šç‰ˆæœ¬å·|ç‰ˆæœ¬ç±»å‹
    $parts = explode('|', $versionContent, 2);
    if (count($parts) === 2) {
      $installedVariant = $parts[1];
    }
  }
  // éªŒè¯æœ‰æ•ˆæ€§
  if (!in_array($installedVariant, ['standard', 'compatible', 'v3'])) {
    $installedVariant = 'standard';
  }
}

// è·å–æ—¥å¿—æ–‡ä»¶ä¿¡æ¯
$logSize = file_exists($logFile) ? filesize($logFile) : 0;
$logSizeFormatted = formatBytes($logSize);
$logLines = file_exists($logFile) ? count(file($logFile)) : 0;

function formatBytes($size, $precision = 2) {
    $units = array('B', 'KB', 'MB', 'GB', 'TB');
    for ($i = 0; $size > 1024 && $i < count($units) - 1; $i++) {
        $size /= 1024;
    }
    return round($size, $precision) . ' ' . $units[$i];
}

// ä»é…ç½®æ–‡ä»¶ä¸­è§£æç«¯å£å’Œå¯†ç ä¿¡æ¯
function getMihomoConfigValues($configPath) {
    if (!file_exists($configPath)) {
        return ['controller' => null, 'secret' => null, 'port' => null];
    }
    
    $content = file_get_contents($configPath);
    $controller = null;
    $secret = null;
    $port = null;
    
    // è§£æ external-controller
    if (preg_match('/external-controller:\s*(.+)/', $content, $matches)) {
        $controller = trim($matches[1]);
        // ä»controllerä¸­æå–ç«¯å£
        if (strpos($controller, ':') !== false) {
            $port = explode(':', $controller)[1] ?? null;
        }
    }
    
    // è§£æ secret
    if (preg_match('/secret:\s*(.+)/', $content, $matches)) {
        $secret = trim($matches[1]);
    }
    
    return ['controller' => $controller, 'secret' => $secret, 'port' => $port];
}

// å¤„ç†ä¸Šä¼ é‡å®šå‘è¿”å›çš„æ¶ˆæ¯
if (isset($_GET['uploadmsg']) && $_GET['uploadmsg'] !== '') {
  $msg = $_GET['uploadmsg'];
}
// ä»…åœ¨è¾“å‡º HTML å‰è®¾ç½®å†…å®¹ç±»å‹ï¼Œé¿å…å½±å“ä¸Šä¼ é‡å®šå‘
header('Content-Type: text/html; charset=utf-8');

$available = array_values(array_filter(scandir($confDir) ?: [], function($f) use ($confDir){
  return is_file($confDir . '/' . $f) && preg_match('/\.(ya?ml)$/i', $f);
}));

// å¼€æœºå³å¯åŠ¨ï¼ˆä¸ä¾èµ–é˜µåˆ—ï¼‰è®¾ç½®
$bootFlag = '/boot/config/plugins/easy-mihomo/bootstart.enabled';
if ($cmd === 'set_bootstart') {
  $enable = ($_POST['enable'] ?? '') === '1';
  $goPath = '/boot/config/go';
  $begin = "# BEGIN easy-mihomo (do not edit)";
  $end   = "# END easy-mihomo";
  $block = $begin . "\n" .
    "(\n" .
    "cat <<'EOF' >/tmp/easy-mihomo-boot.sh\n" .
    "#!/bin/bash\n" .
    "FLAG=\"/boot/config/plugins/easy-mihomo/bootstart.enabled\"\n" .
    "START_SH=\"/usr/local/emhttp/plugins/easy-mihomo/scripts/start.sh\"\n" .
    "LOG=\"/var/log/mihomo.log\"\n" .
    "for i in \$(seq 1 60); do\n" .
    "  if [ -x \"\$START_SH\" ]; then break; fi\n" .
    "  sleep 1\n" .
    "done\n" .
    "if [ -f \"\$FLAG\" ] && [ -x \"\$START_SH\" ]; then\n" .
    "  echo \"[easy-mihomo] boot detected, starting service...\" >> \"\$LOG\" 2>&1\n" .
    "  bash \"\$START_SH\" >> \"\$LOG\" 2>&1 || true\n" .
    "fi\n" .
    "rm -f /tmp/easy-mihomo-boot.sh\n" .
    "EOF\n" .
    "bash /tmp/easy-mihomo-boot.sh &\n" .
    ")\n" .
    $end . "\n";

  if ($enable) {
    if (!is_dir(dirname($bootFlag))) @mkdir(dirname($bootFlag), 0777, true);
    @file_put_contents($bootFlag, 'enabled');
    $go = file_exists($goPath) ? @file_get_contents($goPath) : "";
    if (strpos($go, $begin) !== false && strpos($go, $end) !== false) {
      $pattern = sprintf('/%s[\s\S]*?%s\n?/m', preg_quote($begin, '/'), preg_quote($end, '/'));
      $go = preg_replace($pattern, $block, $go, 1);
    } else {
      if ($go !== "" && substr($go, -1) !== "\n") $go .= "\n";
      $go .= $block;
    }
    @file_put_contents($goPath, $go);
    $msg = 'bootstart enabled (go injected)';
  } else {
    @unlink($bootFlag);
    $go = file_exists($goPath) ? @file_get_contents($goPath) : "";
    if ($go !== "") {
      $pattern = sprintf('/%s[\s\S]*?%s\n?/m', preg_quote($begin, '/'), preg_quote($end, '/'));
      $newGo = preg_replace($pattern, '', $go, 1);
      if ($newGo !== null) @file_put_contents($goPath, $newGo);
    }
    $msg = 'bootstart disabled (go cleaned)';
  }
}
$bootstartOn = file_exists($bootFlag);

// ç°åœ¨è¯»å–å·²é€‰æ‹©çš„é…ç½®ï¼ˆåœ¨æ‰€æœ‰å‘½ä»¤å¤„ç†å®Œæˆåï¼‰
$selectedName = is_file($selectFile) ? trim(@file_get_contents($selectFile)) : '';
$selectedPath = ($selectedName && is_file($confDir . '/' . $selectedName)) ? ($confDir . '/' . $selectedName) : '';

// è¯»å–é…ç½®å†…å®¹ç”¨äºç¼–è¾‘
$confText = ($selectedPath && file_exists($selectedPath)) ? @file_get_contents($selectedPath) : '';

// è§£æé…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£å’Œå¯†ç ä¿¡æ¯
$configValues = getMihomoConfigValues($selectedPath);
$controller = $configValues['controller'];
$secret = $configValues['secret'];
$port = $configValues['port'];

// æ£€æŸ¥å®‰è£…çŠ¶æ€ï¼ˆä¼˜å…ˆæ£€æµ‹Uç›˜ï¼Œå› ä¸ºæ ¸å¿ƒä¿å­˜åœ¨Uç›˜ï¼Œå¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½åˆ°å†…å­˜ï¼‰
$installStatus = '';
$binUdiskExists = file_exists('/boot/config/plugins/easy-mihomo/mihomo');  // Uç›˜æ ¸å¿ƒï¼ˆçœŸå®å®‰è£…çŠ¶æ€ï¼‰
$binExists = file_exists('/usr/local/bin/mihomo');  // å†…å­˜æ ¸å¿ƒï¼ˆè¿è¡Œæ—¶ä¸´æ—¶ç¼“å­˜ï¼‰
$uiExists = file_exists('/boot/config/plugins/easy-mihomo/zashboard.zip');

// æ£€æŸ¥æ’ä»¶ç›®å½•ä¸‹æ˜¯å¦æœ‰ä»»ä½•é…ç½®æ–‡ä»¶
$confDir = '/boot/config/plugins/easy-mihomo';
$confExists = false;
if (is_dir($confDir)) {
  $files = scandir($confDir);
  foreach ($files as $file) {
    if (preg_match('/\.(ya?ml)$/i', $file)) {
      $confExists = true;
      break;
    }
  }
}

// æ£€æŸ¥æ ¸å¿ƒç»„ä»¶ï¼ˆUç›˜ä¸ºå‡†ï¼Œå› ä¸ºå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½åˆ°å†…å­˜ï¼‰
if (!$binUdiskExists) {
  $installStatus = '<div class="error">âŒ æ ¸å¿ƒæ–‡ä»¶æœªå®‰è£…ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹"ä¸‹è½½æ ¸å¿ƒ"æŒ‰é’®</div>';
} elseif (!$uiExists) {
  $installStatus = '<div class="warning">âš ï¸ æœªæ£€æµ‹åˆ° UI å‹ç¼©åŒ…ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹"ä¸‹è½½/æ›´æ–°UI"è·å–ï¼ˆä¸å½±å“æŒ‰é…ç½®è‡ªå®šä¹‰ external-uiï¼‰</div>';
} elseif (!$confExists) {
  $installStatus = '<div class="success">ğŸ’¡ å°šæœªå‘ç°é…ç½®æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ åˆ°æ’ä»¶ç›®å½•ï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹"æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨"</div>';
}
?>
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Easy-Mihomo</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:16px;color:#222}
.card{border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px}
pre{background:#f7f7f7;border:1px solid #eee;border-radius:6px;padding:10px;max-height:360px;overflow:auto}
button{padding:8px 14px;margin-right:8px;cursor:pointer}
input[type=file]{margin-top:8px;margin-bottom:8px}
.warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:12px;border-radius:6px;margin-bottom:16px}
.error{color:#dc3545;margin:4px 0;font-size:14px}
.success{color:#28a745;margin:4px 0;font-size:14px}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
</style>
<script>
function executeAction(action) {
  // ä½¿ç”¨GETå‚æ•°ç›´æ¥è·³è½¬
  var url = new URL(window.location);
  url.searchParams.set('cmd', action);
  window.location.href = url.toString();
}

function openConsole() {
  // è·å–å½“å‰é¡µé¢çš„ä¸»æœºåï¼ˆä¸åŒ…å«ç«¯å£ï¼‰
  var currentHostname = window.location.hostname;
  // ä»é¡µé¢ä¸­è·å–åŠ¨æ€ç«¯å£ä¿¡æ¯
  var portSpans = document.querySelectorAll('span');
  var port = null;
  for (var i = 0; i < portSpans.length; i++) {
    if (portSpans[i].textContent === 'ç«¯å£ï¼š') {
      var nextSpan = portSpans[i].nextElementSibling;
      if (nextSpan && nextSpan.tagName === 'SPAN') {
        var portText = nextSpan.textContent.trim();
        // æ£€æŸ¥æ˜¯å¦åŒ…å«"æœªè®¾ç½®"æ–‡æœ¬ï¼ˆå¤„ç†åµŒå¥—spançš„æƒ…å†µï¼‰
        if (portText && portText !== 'æœªè®¾ç½®' && !portText.includes('æœªè®¾ç½®')) {
          port = portText;
        }
        break;
      }
    }
  }
  
  // å¦‚æœæ²¡æ‰¾åˆ°ç«¯å£ï¼Œå°è¯•é€šè¿‡æ›´ç®€å•çš„æ–¹æ³•è·å–
  if (!port) {
    // æŸ¥æ‰¾åŒ…å«ç«¯å£å·çš„spanå…ƒç´ 
    var allSpans = document.querySelectorAll('span');
    for (var j = 0; j < allSpans.length; j++) {
      var text = allSpans[j].textContent.trim();
      // æ£€æŸ¥æ˜¯å¦æ˜¯çº¯æ•°å­—ï¼ˆç«¯å£å·ï¼‰
      if (/^\d+$/.test(text) && parseInt(text) > 0 && parseInt(text) < 65536) {
        port = text;
        break;
      }
    }
  }
  
  if (!port) {
    alert('è¯·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® external-controller ç«¯å£');
    return;
  }
  
  var consoleUrl = 'http://' + currentHostname + ':' + port + '/ui/zashboard/#/proxies';
  // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æ§åˆ¶å°
  window.open(consoleUrl, '_blank');
}

function openFileManager() {
  // è·å–å½“å‰é¡µé¢çš„ä¸»æœºåå’Œç«¯å£
  var currentHostname = window.location.hostname;
  var currentPort = window.location.port;
  // æ„å»ºæ–‡ä»¶ç®¡ç†å™¨URLï¼Œç›´æ¥å®šä½åˆ°æ’ä»¶é…ç½®ç›®å½•
  var fileManagerUrl = 'http://' + currentHostname + ':' + currentPort + '/Main/Browse?dir=%2Fboot%2Fconfig%2Fplugins%2Feasy-mihomo';
  // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨
  window.open(fileManagerUrl, '_blank');
}

// å…¨å±€å˜é‡å­˜å‚¨æ›´æ–°çŠ¶æ€
window.updateCheckData = null;

function checkUpdate(silent) {
  var updateInfo = document.getElementById('update-info');
  if (updateInfo && !silent) {
    updateInfo.innerHTML = '<span style="color:#6c757d;">æ£€æŸ¥ä¸­...</span>';
  }
  
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/plugins/easy-mihomo/api.php?cmd=check_update');
  xhr.onload = function(){
    if (xhr.status === 200) {
      try {
        var data = JSON.parse(xhr.responseText);
        // ä¿å­˜åˆ°å…¨å±€å˜é‡
        window.updateCheckData = data;
        
        var localVer = document.getElementById('local-version');
        
        if (localVer && data.local && data.local !== 'not installed') {
          localVer.textContent = data.local;
        }
        
        if (updateInfo) {
          if (data.has_update) {
            if (data.local === 'not installed') {
              updateInfo.innerHTML = '<span style="color:#dc3545;">ğŸ”´ ' + data.message + '</span>';
            } else {
              updateInfo.innerHTML = '<span style="color:#ffc107;">ğŸŸ¡ ' + data.message + '</span>';
            }
          } else {
            updateInfo.innerHTML = '<span style="color:#28a745;">âœ… ' + data.message + '</span>';
          }
          
          // 5ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯ï¼ˆå¦‚æœæ˜¯å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼‰
          if (!data.has_update && !silent) {
            setTimeout(function(){ 
              if (updateInfo) updateInfo.innerHTML = ''; 
            }, 5000);
          }
        }
        
        // æ›´æ–°ä¸‹è½½æŒ‰é’®çŠ¶æ€
        updateDownloadButtonState();
        
      } catch (e) {
        if (updateInfo && !silent) {
          updateInfo.innerHTML = '<span style="color:#dc3545;">è§£æå¤±è´¥</span>';
        }
      }
    } else {
      if (updateInfo && !silent) {
        updateInfo.innerHTML = '<span style="color:#dc3545;">æ£€æŸ¥å¤±è´¥</span>';
      }
    }
  };
  xhr.onerror = function(){
    if (updateInfo && !silent) {
      updateInfo.innerHTML = '<span style="color:#dc3545;">ç½‘ç»œé”™è¯¯</span>';
    }
  };
  xhr.send();
}

// æ£€æŸ¥ UI æ›´æ–°
function checkUIUpdate(silent) {
  var uiUpdateInfo = document.getElementById('ui-update-info');
  if (uiUpdateInfo && !silent) {
    uiUpdateInfo.innerHTML = '<span style="color:#6c757d;">æ£€æŸ¥ä¸­...</span>';
  }
  
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/plugins/easy-mihomo/api.php?cmd=check_ui_update');
  xhr.onload = function(){
    if (xhr.status === 200) {
      try {
        var data = JSON.parse(xhr.responseText);
        // ä¿å­˜åˆ°å…¨å±€å˜é‡
        window.uiUpdateCheckData = data;
        
        var localVer = document.getElementById('ui-local-version');
        
        if (localVer && data.local && data.local !== 'not installed') {
          localVer.textContent = data.local;
        }
        
        if (uiUpdateInfo) {
          if (data.has_update) {
            if (data.local === 'not installed') {
              uiUpdateInfo.innerHTML = '<span style="color:#dc3545;">ğŸ”´ ' + data.message + '</span>';
            } else {
              uiUpdateInfo.innerHTML = '<span style="color:#ffc107;">ğŸŸ¡ ' + data.message + '</span>';
            }
          } else {
            uiUpdateInfo.innerHTML = '<span style="color:#28a745;">âœ… ' + data.message + '</span>';
          }
          
          // 5ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯ï¼ˆå¦‚æœæ˜¯å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼‰
          if (!data.has_update && !silent) {
            setTimeout(function(){ 
              if (uiUpdateInfo) uiUpdateInfo.innerHTML = ''; 
            }, 5000);
          }
        }
        
        // æ›´æ–° UI ä¸‹è½½æŒ‰é’®çŠ¶æ€
        updateUIDownloadButtonState();
        
      } catch (e) {
        if (uiUpdateInfo && !silent) {
          uiUpdateInfo.innerHTML = '<span style="color:#dc3545;">è§£æå¤±è´¥</span>';
        }
      }
    } else {
      if (uiUpdateInfo && !silent) {
        uiUpdateInfo.innerHTML = '<span style="color:#dc3545;">æ£€æŸ¥å¤±è´¥</span>';
      }
    }
  };
  xhr.onerror = function(){
    if (uiUpdateInfo && !silent) {
      uiUpdateInfo.innerHTML = '<span style="color:#dc3545;">ç½‘ç»œé”™è¯¯</span>';
    }
  };
  xhr.send();
}

// æ›´æ–° UI ä¸‹è½½æŒ‰é’®çŠ¶æ€
function updateUIDownloadButtonState() {
  var downloadBtn = document.getElementById('download-ui-btn');
  if (!downloadBtn) return;
  
  // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä¸‹è½½
  var progressBox = document.getElementById('progress-ui');
  if (progressBox && progressBox.textContent && progressBox.textContent.includes('%')) {
    downloadBtn.disabled = true;
    downloadBtn.style.background = '#6c757d';
    downloadBtn.style.cursor = 'not-allowed';
    downloadBtn.textContent = 'ä¸‹è½½ä¸­...';
    return;
  }
  
  // å¯ç”¨æŒ‰é’®
  downloadBtn.disabled = false;
  downloadBtn.style.cursor = 'pointer';
  
  if (window.uiUpdateCheckData) {
    var data = window.uiUpdateCheckData;
    if (data.has_update) {
      if (data.local === 'not installed') {
        downloadBtn.style.background = '#28a745';
        downloadBtn.textContent = 'ä¸‹è½½ UI';
      } else {
        downloadBtn.style.background = '#ffc107';
        downloadBtn.style.color = '#000';
        downloadBtn.textContent = 'æ›´æ–°åˆ° ' + data.remote;
      }
    } else {
      downloadBtn.style.background = '#6c757d';
      downloadBtn.textContent = 'é‡æ–°å®‰è£…';
    }
  } else {
    downloadBtn.style.background = '#007bff';
    downloadBtn.textContent = 'ä¸‹è½½/æ›´æ–° UI';
  }
}

// æ™ºèƒ½ä¸‹è½½ UI å‡½æ•°
function smartDownloadUI(target, btn) {
  // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä¸‹è½½
  var progressBox = document.getElementById('progress-ui');
  if (progressBox && progressBox.textContent && progressBox.textContent.includes('%')) {
    alert('âš ï¸ æ­£åœ¨ä¸‹è½½ä¸­ï¼Œè¯·ç­‰å¾…å½“å‰ä¸‹è½½å®Œæˆ');
    return;
  }
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°ä¿¡æ¯
  if (!window.uiUpdateCheckData) {
    // æ²¡æœ‰æ£€æŸ¥è¿‡æ›´æ–°ï¼Œå…ˆæ£€æŸ¥
    if (confirm('ğŸ“¦ å³å°†ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ UI\n\næ˜¯å¦ç»§ç»­ï¼Ÿ')) {
      startDownload(target, btn);
    }
    return;
  }
  
  var data = window.uiUpdateCheckData;
  
  // æ ¹æ®æ›´æ–°çŠ¶æ€ç»™å‡ºä¸åŒæç¤º
  if (data.has_update) {
    // æœ‰æ–°ç‰ˆæœ¬
    var confirmMsg = '';
    if (data.local === 'not installed') {
      confirmMsg = 'ğŸ“¦ å³å°†ä¸‹è½½ UI\n\næœ€æ–°ç‰ˆæœ¬: ' + data.remote + '\n\næ˜¯å¦ç»§ç»­ï¼Ÿ';
    } else {
      confirmMsg = 'ğŸ”„ å‘ç°æ–°ç‰ˆæœ¬ï¼\n\nå½“å‰ç‰ˆæœ¬: ' + data.local + '\næœ€æ–°ç‰ˆæœ¬: ' + data.remote + '\n\næ˜¯å¦æ›´æ–°ï¼Ÿ';
    }
    
    if (confirm(confirmMsg)) {
      startDownload(target, btn);
    }
  } else {
    // å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè¯¢é—®æ˜¯å¦é‡æ–°å®‰è£…
    var reinstallMsg = 'âœ… å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬: ' + data.remote + '\n\næ˜¯å¦é‡æ–°å®‰è£…ï¼Ÿ';
    if (confirm(reinstallMsg)) {
      startDownload(target, btn);
    }
  }
}

// æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
function checkServiceRunning() {
  var statusElements = document.querySelectorAll('span[style*="color:#28a745"]');
  for (var i = 0; i < statusElements.length; i++) {
    if (statusElements[i].textContent.includes('è¿è¡Œä¸­')) {
      return true;
    }
  }
  return false;
}

// æ›´æ–°ä¸‹è½½æŒ‰é’®çŠ¶æ€
function updateDownloadButtonState() {
  var downloadBtn = document.getElementById('download-btn');
  var updateInfo = document.getElementById('update-info');
  
  if (!downloadBtn) return;
  
  // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä¸‹è½½
  var progressBox = document.getElementById('progress-core');
  if (progressBox && progressBox.textContent && progressBox.textContent.includes('%')) {
    downloadBtn.disabled = true;
    downloadBtn.style.background = '#6c757d';
    downloadBtn.style.cursor = 'not-allowed';
    downloadBtn.textContent = 'ä¸‹è½½ä¸­...';
    return;
  }
  
  // å§‹ç»ˆå¯ç”¨æŒ‰é’®ï¼ˆå³ä½¿æœåŠ¡æ­£åœ¨è¿è¡Œä¹Ÿå…è®¸ä¸‹è½½æ ¸å¿ƒï¼‰
  // åŸå› ï¼šä¸‹è½½æ ¸å¿ƒéœ€è¦é­”æ³•ç½‘ç»œï¼ˆä»£ç†ï¼‰ï¼Œåœæ­¢æœåŠ¡ä¼šå¯¼è‡´æ— æ³•ä¸‹è½½
  // æ–°æ ¸å¿ƒä¼šä¿å­˜åˆ°Uç›˜å¹¶åˆ é™¤å†…å­˜æ ¸å¿ƒï¼Œé‡å¯æœåŠ¡åè‡ªåŠ¨ä»Uç›˜åŠ è½½
  downloadBtn.disabled = false;
  downloadBtn.style.cursor = 'pointer';
  
  if (window.updateCheckData) {
    var data = window.updateCheckData;
    if (data.has_update) {
      if (data.local === 'not installed') {
        downloadBtn.style.background = '#28a745';
        downloadBtn.textContent = 'ä¸‹è½½æ ¸å¿ƒ';
      } else {
        downloadBtn.style.background = '#ffc107';
        downloadBtn.style.color = '#000';
        downloadBtn.textContent = 'æ›´æ–°åˆ° ' + data.remote;
      }
    } else {
      downloadBtn.style.background = '#6c757d';
      downloadBtn.textContent = 'é‡æ–°å®‰è£…';
    }
  } else {
    downloadBtn.style.background = '#007bff';
    downloadBtn.textContent = 'ä¸‹è½½/æ›´æ–°æ ¸å¿ƒ';
  }
}

// æ™ºèƒ½ä¸‹è½½å‡½æ•°
function smartDownload(target, btn) {
  // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä¸‹è½½
  var progressBox = document.getElementById('progress-core');
  if (progressBox && progressBox.textContent && progressBox.textContent.includes('%')) {
    alert('âš ï¸ æ­£åœ¨ä¸‹è½½ä¸­ï¼Œè¯·ç­‰å¾…å½“å‰ä¸‹è½½å®Œæˆ');
    return;
  }
  
  // æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œï¼ˆç”¨äºæç¤ºï¼Œä¸é˜»æ­¢ä¸‹è½½ï¼‰
  var isServiceRunning = checkServiceRunning();
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°ä¿¡æ¯
  if (!window.updateCheckData) {
    // æ²¡æœ‰æ£€æŸ¥è¿‡æ›´æ–°ï¼Œå…ˆæ£€æŸ¥
    var msg = 'ğŸ“¦ å³å°†ä¸‹è½½æœ€æ–°ç‰ˆæœ¬æ ¸å¿ƒæ–‡ä»¶\n\næ˜¯å¦ç»§ç»­ï¼Ÿ';
    if (isServiceRunning) {
      msg = 'ğŸ“¦ å³å°†ä¸‹è½½æœ€æ–°ç‰ˆæœ¬æ ¸å¿ƒæ–‡ä»¶\n\nâš ï¸ æç¤ºï¼šæœåŠ¡æ­£åœ¨è¿è¡Œï¼Œä¸‹è½½å®Œæˆåéœ€è¦é‡å¯æœåŠ¡æ–°æ ¸å¿ƒæ‰ä¼šç”Ÿæ•ˆ\n\næ˜¯å¦ç»§ç»­ï¼Ÿ';
    }
    if (confirm(msg)) {
      startDownload(target, btn);
    }
    return;
  }
  
  var data = window.updateCheckData;
  
  // æ ¹æ®æ›´æ–°çŠ¶æ€ç»™å‡ºä¸åŒæç¤º
  if (data.has_update) {
    // æœ‰æ–°ç‰ˆæœ¬
    var confirmMsg = '';
    if (data.local === 'not installed') {
      confirmMsg = 'ğŸ“¦ å³å°†ä¸‹è½½æ ¸å¿ƒæ–‡ä»¶\n\næœ€æ–°ç‰ˆæœ¬: ' + data.remote + '\n\næ˜¯å¦ç»§ç»­ï¼Ÿ';
      if (isServiceRunning) {
        confirmMsg = 'ğŸ“¦ å³å°†ä¸‹è½½æ ¸å¿ƒæ–‡ä»¶\n\næœ€æ–°ç‰ˆæœ¬: ' + data.remote + '\n\nâš ï¸ æç¤ºï¼šæœåŠ¡æ­£åœ¨è¿è¡Œï¼Œä¸‹è½½å®Œæˆåéœ€è¦é‡å¯æœåŠ¡æ–°æ ¸å¿ƒæ‰ä¼šç”Ÿæ•ˆ\n\næ˜¯å¦ç»§ç»­ï¼Ÿ';
      }
    } else {
      confirmMsg = 'ğŸ”„ å‘ç°æ–°ç‰ˆæœ¬ï¼\n\nå½“å‰ç‰ˆæœ¬: ' + data.local + '\næœ€æ–°ç‰ˆæœ¬: ' + data.remote + '\n\næ˜¯å¦æ›´æ–°ï¼Ÿ';
      if (isServiceRunning) {
        confirmMsg = 'ğŸ”„ å‘ç°æ–°ç‰ˆæœ¬ï¼\n\nå½“å‰ç‰ˆæœ¬: ' + data.local + '\næœ€æ–°ç‰ˆæœ¬: ' + data.remote + '\n\nâš ï¸ æç¤ºï¼šæœåŠ¡æ­£åœ¨è¿è¡Œï¼Œä¸‹è½½å®Œæˆåéœ€è¦é‡å¯æœåŠ¡æ–°æ ¸å¿ƒæ‰ä¼šç”Ÿæ•ˆ\n\næ˜¯å¦æ›´æ–°ï¼Ÿ';
      }
    }
    
    if (confirm(confirmMsg)) {
      startDownload(target, btn);
    }
  } else {
    // å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè¯¢é—®æ˜¯å¦é‡æ–°å®‰è£…
    var reinstallMsg = 'âœ… å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬: ' + data.remote + '\n\næ˜¯å¦é‡æ–°å®‰è£…ï¼Ÿï¼ˆå¯ç”¨äºä¿®å¤æŸåçš„æ–‡ä»¶ï¼‰';
    if (isServiceRunning) {
      reinstallMsg = 'âœ… å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬: ' + data.remote + '\n\nâš ï¸ æç¤ºï¼šæœåŠ¡æ­£åœ¨è¿è¡Œï¼Œä¸‹è½½å®Œæˆåéœ€è¦é‡å¯æœåŠ¡æ–°æ ¸å¿ƒæ‰ä¼šç”Ÿæ•ˆ\n\næ˜¯å¦é‡æ–°å®‰è£…ï¼Ÿï¼ˆå¯ç”¨äºä¿®å¤æŸåçš„æ–‡ä»¶ï¼‰';
    }
    if (confirm(reinstallMsg)) {
      startDownload(target, btn);
    }
  }
}

function startDownload(target, btn) {
  // æ¸…é™¤æ—§çš„è¿›åº¦/é”™è¯¯ä¿¡æ¯ï¼ˆå¼€å§‹æ–°æ“ä½œï¼‰
  var progressBox = document.getElementById('progress-' + target);
  if (progressBox) {
    progressBox.innerHTML = '';
    progressBox.style.color = '';
    progressBox.style.opacity = '1';
  }
  
  // ç¦ç”¨æ‰€æœ‰ä¸‹è½½æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
  var downloadBtn = document.getElementById('download-btn');
  if (downloadBtn) {
    downloadBtn.dataset.oldText = downloadBtn.innerText;
    downloadBtn.dataset.oldColor = downloadBtn.style.background;
    downloadBtn.disabled = true;
    downloadBtn.style.background = '#6c757d';
    downloadBtn.style.cursor = 'not-allowed';
    downloadBtn.innerText = 'ä¸‹è½½ä¸­...';
  }
  
    var box = document.getElementById('download-msg');
    if (box) box.innerText = 'å·²å‘èµ·ä¸‹è½½ä»»åŠ¡ï¼Œæ­£åœ¨å‡†å¤‡...';
  
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/plugins/easy-mihomo/api.php?cmd=start_download&target=' + encodeURIComponent(target));
  xhr.onload = function(){
    if (xhr.status === 200) {
      if (box) box.innerText = (xhr.responseText || '').trim() || 'ä»»åŠ¡å·²å¯åŠ¨';
    } else {
      // ä¸‹è½½å¯åŠ¨å¤±è´¥ï¼Œæ¢å¤æŒ‰é’®
      if (downloadBtn) {
        downloadBtn.disabled = false;
        downloadBtn.style.background = downloadBtn.dataset.oldColor || '#007bff';
        downloadBtn.style.cursor = 'pointer';
        downloadBtn.innerText = downloadBtn.dataset.oldText || 'ä¸‹è½½æ ¸å¿ƒ';
      }
      // æ˜¾ç¤ºé”™è¯¯
      if (progressBox) {
        progressBox.innerHTML = 'âŒ å¯åŠ¨ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
        progressBox.style.color = '#dc3545';
      }
    }
  };
  xhr.onerror = function(){
    // ç½‘ç»œé”™è¯¯ï¼Œæ¢å¤æŒ‰é’®
    if (downloadBtn) {
      downloadBtn.disabled = false;
      downloadBtn.style.background = downloadBtn.dataset.oldColor || '#007bff';
      downloadBtn.style.cursor = 'pointer';
      downloadBtn.innerText = downloadBtn.dataset.oldText || 'ä¸‹è½½æ ¸å¿ƒ';
    }
    // æ˜¾ç¤ºé”™è¯¯
    if (progressBox) {
      progressBox.innerHTML = 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
      progressBox.style.color = '#dc3545';
    }
  };
  xhr.send();
}

function pollProgress(target, elId) {
  var lastStatus = '';
  var errorTimeout = null;
  var autoHideTimeout = null;
  var intervalId = null;
  
  function tick(){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/plugins/easy-mihomo/api.php?cmd=get_progress&target=' + encodeURIComponent(target));
    xhr.onload = function(){
      if (xhr.status === 200) {
        var box = document.getElementById(elId);
        if (!box) return;
        
        var txt = xhr.responseText || '';
        if (txt.trim()) {
          lastStatus = txt;
          
          // æ£€æµ‹é”™è¯¯ä¿¡æ¯
          if (txt.includes('error:')) {
            box.style.color = '#dc3545';  // çº¢è‰²
            box.style.opacity = '1';
            
            // æ„å»ºé”™è¯¯æ¶ˆæ¯ï¼šé”™è¯¯å†…å®¹ + é‡è¯•é“¾æ¥ + å…³é—­æŒ‰é’®
            var errorMsg = txt.replace('error:', 'âŒ');
            box.innerHTML = errorMsg + 
              ' <a href="javascript:void(0)" onclick="smartDownload(\'' + target + '\', this); return false;" style="color:#007bff;text-decoration:underline;cursor:pointer;">é‡è¯•</a>' +
              ' <span onclick="clearErrorMessage(\'' + elId + '\')" style="color:#999;margin-left:8px;cursor:pointer;font-size:18px;line-height:1;font-weight:bold;transition:color 0.2s;" title="å…³é—­æç¤º" onmouseover="this.style.color=\'#dc3545\'" onmouseout="this.style.color=\'#999\'">Ã—</span>';
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (errorTimeout) clearTimeout(errorTimeout);
            if (autoHideTimeout) clearTimeout(autoHideTimeout);
            
            // 10ç§’ååŠé€æ˜æ˜¾ç¤ºï¼ˆæç¤ºä¿¡æ¯å·²è¿‡æœŸï¼‰
            errorTimeout = setTimeout(function() {
              if (box && box.innerHTML.includes('âŒ')) {
                box.style.opacity = '0.6';
                
                // å†è¿‡20ç§’ï¼ˆæ€»å…±30ç§’ï¼‰è‡ªåŠ¨æ¶ˆå¤±
                autoHideTimeout = setTimeout(function() {
                  if (box && box.innerHTML.includes('âŒ')) {
                    box.innerHTML = '';
                    box.style.opacity = '1';
                    box.style.color = '';
                  }
                }, 20000);
              }
            }, 10000);
            
          } else if (txt.includes('100%')) {
            // ä¸‹è½½å®Œæˆ
            box.style.color = '#28a745';  // ç»¿è‰²
            box.style.opacity = '1';
          box.innerText = txt;
            
            setTimeout(function(){
              if (box) {
                // æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
                var isServiceRunning = checkServiceRunning();
                if (isServiceRunning && target === 'core') {
                  // æ ¸å¿ƒä¸‹è½½å®Œæˆä¸”æœåŠ¡æ­£åœ¨è¿è¡Œ
                  box.innerHTML = 'âœ… æ ¸å¿ƒä¸‹è½½å®Œæˆï¼<span style="color:#ffc107;font-weight:bold;">è¯·é‡å¯æœåŠ¡ä½¿æ–°æ ¸å¿ƒç”Ÿæ•ˆ</span>';
                  // ä¸è‡ªåŠ¨åˆ·æ–°é¡µé¢ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
        } else {
                  // æœåŠ¡æœªè¿è¡Œæˆ–ä¸‹è½½çš„æ˜¯UIï¼Œæ­£å¸¸åˆ·æ–°
                  box.innerText = 'âœ… ä¸‹è½½å®Œæˆï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...';
                  // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°ç‰ˆæœ¬
                  setTimeout(function(){
                    window.location.reload();
                  }, 2000);
                }
              }
            }, 1000);
            
          } else {
            // æ­£å¸¸è¿›åº¦
            box.style.color = '#6c757d';  // ç°è‰²
            box.style.opacity = '1';
            box.innerText = txt;
          }
        } else {
          // è¿›åº¦æ–‡ä»¶å·²è¢«æ¸…ç†
          if (lastStatus && lastStatus.includes('%') && !lastStatus.includes('100%') && !lastStatus.includes('error:')) {
            // å¦‚æœä¹‹å‰æœ‰è¿›åº¦ä½†ä¸æ˜¯100%æˆ–é”™è¯¯ï¼Œç°åœ¨æ²¡äº†ï¼Œè¯´æ˜å¯èƒ½ä¸­æ–­
            box.innerText = 'âš ï¸ ä¸‹è½½å¯èƒ½ä¸­æ–­';
            box.style.color = '#ffc107';
            setTimeout(function(){ if (box) box.innerText=''; }, 5000);
          } else if (lastStatus.includes('100%')) {
            // å·²ç»å®Œæˆäº†
            if (box) box.innerText = '';
          }
          lastStatus = '';
        }
      }
    };
    xhr.send();
  }
  
  tick();
  intervalId = setInterval(tick, 2000);
  return intervalId;
}

// æ‰‹åŠ¨æ¸…é™¤é”™è¯¯æ¶ˆæ¯
function clearErrorMessage(elementId) {
  var box = document.getElementById(elementId);
  if (box) {
    box.innerHTML = '';
    box.style.opacity = '1';
    box.style.color = '';
  }
}

function openConfigEditor() {
  document.getElementById('configModal').style.display = 'block';
  // ç¦ç”¨é¡µé¢æ»šåŠ¨
  document.body.style.overflow = 'hidden';
}

function closeConfigEditor() {
  document.getElementById('configModal').style.display = 'none';
  // æ¢å¤é¡µé¢æ»šåŠ¨
  document.body.style.overflow = 'auto';
}

// ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹å‡ºçª—å£
document.addEventListener('click', function(event) {
  var modal = document.getElementById('configModal');
  if (event.target === modal) {
    closeConfigEditor();
  }
});

// ESCé”®å…³é—­å¼¹å‡ºçª—å£
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeConfigEditor();
  }
});

// ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿè¡¨å•æäº¤ï¼Œç¡®ä¿ emhttp æ­£å¸¸æ¥æ”¶å¸¦ Content-Length çš„ä¸Šä¼ 
</script>
</head>
<body>
<h2 style="display:inline;">Mihomo ç®¡ç†</h2>
<div style="display:inline-block;margin-left:12px;vertical-align:middle;">
  <a href="https://t.me/+7jcTMePlNVwwZjg1" target="_blank" style="display:inline-block;background:#0088cc;color:white;padding:4px 8px;border-radius:4px;text-decoration:none;font-weight:bold;font-size:12px;margin-right:8px;">
    <svg style="display:inline-block;vertical-align:middle;margin-right:4px;" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.781-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.008-1.252-.241-1.865-.44-.752-.244-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635.099-.002.321.023.465.141.121.099.155.232.171.326.016.094.036.308.02.475z"/></svg>
    ç”µæŠ¥ç¾¤äº¤æµ
  </a>
  <a href="https://afdian.com/a/docker" target="_blank" style="display:inline-block;background:#946ce6;color:white;padding:4px 8px;border-radius:4px;text-decoration:none;font-weight:bold;font-size:12px;margin-right:8px;">
    <svg style="display:inline-block;vertical-align:middle;margin-right:4px;" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
    çˆ±å‘ç”µä¸»é¡µ
  </a>
  <a href="https://github.com/wlaosj" target="_blank" style="display:inline-block;background:#24292e;color:white;padding:4px 8px;border-radius:4px;text-decoration:none;font-weight:bold;font-size:12px;margin-right:8px;">
    <svg style="display:inline-block;vertical-align:middle;margin-right:4px;" width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
    GitHub ä¸»é¡µ
  </a>
  <span style="display:inline-block;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:bold;margin-right:8px;animation:pulse 2s ease-in-out infinite;">
    âœ¨ ä¸»é¡µæ›´å¤šç²¾å½©æ’ä»¶
  </span>
  <span style="font-size:12px;color:#6c757d;">
    Easy-Mihomo æ’ä»¶ | ä½œè€…ï¼šéš”å£å°ç‹ | æ ¸å¿ƒï¼šMihomo | UIï¼šZashboard
  </span>
</div>
<?php if ($installStatus) { echo $installStatus; } ?>
<div class="card">
  <div>
    <b>è¿è¡ŒçŠ¶æ€ï¼š</b>
    <?php
      $statusText = trim($status ?? 'unknown');
      if (strpos($statusText, 'running') !== false) {
        $pid = '';
        if (preg_match('/pid=(\d+)/', $statusText, $matches)) { $pid = ' (è¿›ç¨‹ID: ' . $matches[1] . ')'; }
        echo '<span style="color:#28a745;font-weight:bold;">ğŸŸ¢ è¿è¡Œä¸­' . $pid . '</span>';
      } elseif (strpos($statusText, 'stopped') !== false) {
        echo '<span style="color:#dc3545;font-weight:bold;">ğŸ”´ å·²åœæ­¢</span>';
      } else {
        echo '<span style="color:#6c757d;">âšª ' . htmlspecialchars($statusText) . '</span>';
      }
    ?>
  </div>

  <div style="margin-top:8px">
    <b>æ ¸å¿ƒï¼š</b>
    <?php if ($binUdiskExists): ?>
      <span style="color:#28a745">âœ… å·²å®‰è£…</span>
      <span style="color:#6c757d;font-size:11px">ï¼ˆä¿å­˜åœ¨Uç›˜ï¼Œå¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½åˆ°å†…å­˜ï¼‰</span> | 
      <button id="download-btn" onclick="smartDownload('core', this)" style="background:#007bff;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">é‡æ–°å®‰è£…</button> | 
      <button onclick="checkUpdate()" style="background:#17a2b8;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">æ£€æŸ¥æ›´æ–°</button>
      <span style="margin-left:8px">æœ¬åœ°ç‰ˆæœ¬ï¼š<span id="local-version"><?= htmlspecialchars(trim($version ?? 'unknown')) ?></span>
      <?php 
        // æ˜¾ç¤ºå®é™…å®‰è£…çš„ç‰ˆæœ¬ç±»å‹æ ‡è¯†ï¼ˆè€Œéç”¨æˆ·å½“å‰é€‰æ‹©ï¼‰
        $variantLabels = [
          'standard' => ['text' => 'æ ‡å‡†ç‰ˆ', 'color' => '#6c757d'],
          'compatible' => ['text' => 'å…¼å®¹ç‰ˆ', 'color' => '#17a2b8'],
          'v3' => ['text' => 'v3ä¼˜åŒ–ç‰ˆ', 'color' => '#28a745']
        ];
        $label = $variantLabels[$installedVariant] ?? $variantLabels['standard'];
        echo '<span style="display:inline-block;margin-left:4px;padding:1px 6px;background:' . $label['color'] . ';color:white;font-size:10px;border-radius:3px;font-weight:bold;">' . $label['text'] . '</span>';
      ?>
      </span>
      <span id="update-info" style="margin-left:8px;font-weight:bold;"></span>
    <?php else: ?>
      <span style="color:#dc3545">âŒ æœªå®‰è£…</span> | 
      <button id="download-btn" onclick="smartDownload('core', this)" style="background:#28a745;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">ä¸‹è½½æ ¸å¿ƒ</button> | 
      <button onclick="checkUpdate()" style="background:#17a2b8;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬</button>
      <span id="update-info" style="margin-left:8px;font-weight:bold;"></span>
    <?php endif; ?>
    <div id="progress-core" style="font-size:12px;color:#6c757d;margin-top:4px"></div>
  </div>

  <div style="margin-top:6px">
    <b>ç‰ˆæœ¬ç±»å‹ï¼š</b>
    <form method="POST" style="display:inline-block;margin:0 8px;vertical-align:middle">
      <input type="hidden" name="cmd" value="set_variant" />
      <select name="variant" onchange="this.form.submit()" style="min-width:200px;padding:4px 8px;border:1px solid #ddd;border-radius:3px;">
        <option value="standard" <?= $currentVariant === 'standard' ? 'selected' : '' ?>>æ ‡å‡†ç‰ˆï¼ˆx86-64-v2ï¼Œæ¨èï¼‰</option>
        <option value="compatible" <?= $currentVariant === 'compatible' ? 'selected' : '' ?>>å…¼å®¹ç‰ˆï¼ˆè€æ—§CPUï¼‰</option>
        <option value="v3" <?= $currentVariant === 'v3' ? 'selected' : '' ?>>v3ä¼˜åŒ–ç‰ˆï¼ˆé«˜æ€§èƒ½æ–°CPUï¼‰</option>
      </select>
    </form>
    <span style="color:#6c757d;">| 
      <?php if ($currentVariant === 'standard'): ?>
        é€‚ç”¨äº 2008 å¹´åçš„å¤§éƒ¨åˆ† Intel/AMD CPU
      <?php elseif ($currentVariant === 'compatible'): ?>
        é€‚ç”¨äº 2008 å¹´å‰çš„è€æ—§ CPUï¼ˆæ€§èƒ½è¾ƒä½ï¼‰
      <?php elseif ($currentVariant === 'v3'): ?>
        é€‚ç”¨äº 2015 å¹´åçš„æ–° CPUï¼ˆHaswell+/Zen+ï¼‰
      <?php endif; ?>
    </span>
    <div style="margin-top:4px;font-size:12px;color:#6c757d;">
      ğŸ’¡ <strong>æ‰‹åŠ¨å®‰è£…ï¼š</strong>ä» <a href="https://github.com/MetaCubeX/mihomo/releases" target="_blank" style="color:#007bff;">GitHub Releases</a> ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„æ ¸å¿ƒæ–‡ä»¶ï¼Œæ”¾åˆ° <code>/boot/config/plugins/easy-mihomo/mihomo</code>
    </div>
    <div style="margin-top:4px;font-size:12px;color:#6c757d;">
      ğŸ’¡ <strong>æç¤ºï¼š</strong>ä¸ç¡®å®šé€‰å“ªä¸ªï¼Ÿ<strong>ä¿æŒé»˜è®¤"æ ‡å‡†ç‰ˆ"</strong>å³å¯ | 
      <a href="https://github.com/MetaCubeX/mihomo/releases" target="_blank" style="color:#007bff;">æŸ¥çœ‹ç‰ˆæœ¬è¯´æ˜</a>
    </div>
  </div>

  <div style="margin-top:6px">
    <b>UIï¼š</b>
    <?php if ($uiExists): ?>
      <span style="color:#28a745">âœ… å·²å®‰è£…</span>
      <span style="color:#6c757d;font-size:11px">ï¼ˆä¿å­˜åœ¨Uç›˜ï¼Œå¯åŠ¨æ—¶è‡ªåŠ¨è§£å‹åˆ°å†…å­˜ï¼‰</span> | 
      <button id="download-ui-btn" onclick="smartDownloadUI('ui', this)" style="background:#007bff;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">é‡æ–°å®‰è£…</button> | 
      <button onclick="checkUIUpdate()" style="background:#17a2b8;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">æ£€æŸ¥æ›´æ–°</button>
      <span style="margin-left:8px">æœ¬åœ°ç‰ˆæœ¬ï¼š<span id="ui-local-version"><?= htmlspecialchars(trim($uiVersion ?? 'unknown')) ?></span></span>
      <span id="ui-update-info" style="margin-left:8px;font-weight:bold;"></span>
    <?php else: ?>
      <span style="color:#dc3545">âŒ æœªå®‰è£…</span> | 
      <button id="download-ui-btn" onclick="smartDownloadUI('ui', this)" style="background:#28a745;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">ä¸‹è½½ UI</button> | 
      <button onclick="checkUIUpdate()" style="background:#17a2b8;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬</button>
      <span id="ui-update-info" style="margin-left:8px;font-weight:bold;"></span>
    <?php endif; ?>
    <div id="progress-ui" style="font-size:12px;color:#6c757d;margin-top:4px"></div>
    <div style="margin-top:4px;color:#6c757d;font-size:12px;">
      ğŸ’¡ <strong>è®¿é—®ä¿¡æ¯ï¼š</strong>
      ä¸»æœºï¼š<span id="zash-host">-</span>
      | ç«¯å£ï¼š<span><?= $port ? htmlspecialchars($port) : '<span style="color:#dc3545;">æœªè®¾ç½®</span>' ?></span>
      | å¯†ç ï¼š<span><?= $secret ? htmlspecialchars($secret) : '<span style="color:#dc3545;">æœªè®¾ç½®</span>' ?></span>
    </div>
    <div style="margin-top:4px;font-size:12px;color:#6c757d;">
      ğŸ’¡ <strong>æ‰‹åŠ¨å®‰è£…ï¼š</strong>ä¸‹è½½ zashboard çš„ dist.zipï¼Œé‡å‘½åä¸º <code>zashboard.zip</code> æ”¾åˆ° <code>/boot/config/plugins/easy-mihomo/zashboard.zip</code>
    </div>
  </div>

  <div style="margin-top:6px">
    <b>é…ç½®ï¼š</b>
     <form id="configForm" method="POST" style="display:inline-block;margin:0 8px;vertical-align:middle">
       <input type="hidden" name="cmd" value="select_conf" />
       <select name="name" onchange="this.form.submit()" style="min-width:260px">
         <?php if (!$selectedName): ?>
           <option value="" disabled selected>è¯·é€‰æ‹©é…ç½®æ–‡ä»¶</option>
         <?php endif; ?>
         <?php foreach ($available as $f): ?>
           <option value="<?= htmlspecialchars($f) ?>" <?= ($f === $selectedName ? 'selected' : '') ?>><?= htmlspecialchars($f) ?></option>
         <?php endforeach; ?>
       </select>
     </form>
     | 
     <button onclick="openConfigEditor()" <?= $selectedPath? '':'disabled' ?> style="background:#17a2b8;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">
       <i class="fa fa-edit"></i> <?= $selectedPath? 'ç¼–è¾‘é…ç½®':'è¯·å…ˆé€‰æ‹©' ?>
     </button>
     | 
     <button onclick="document.getElementById('configForm').submit()">åˆ·æ–°é…ç½®åˆ—è¡¨</button>
     | 
     <button onclick="openFileManager()">æ‰“å¼€é…ç½®æ–‡ä»¶å¤¹</button>
     | 
     <span style="color:#6c757d">å½“å‰ï¼š<?= $selectedPath ? htmlspecialchars($selectedPath) : 'æœªé€‰æ‹©' ?></span>
    <div style="margin-top:4px;font-size:12px;color:#6c757d;">
      ğŸ’¡ <strong>æ‰‹åŠ¨å®‰è£…ï¼š</strong>å°† .yaml æˆ– .yml é…ç½®æ–‡ä»¶æ”¾åˆ° <code>/boot/config/plugins/easy-mihomo/</code> ç›®å½•ï¼Œç„¶ååˆ·æ–°é…ç½®åˆ—è¡¨
    </div>
    <div style="margin-top:6px;padding:8px 12px;background:#e7f3ff;border-left:3px solid #0088cc;border-radius:4px;">
      <span style="font-size:12px;color:#333;">
        <svg style="display:inline-block;vertical-align:middle;margin-right:4px;" width="14" height="14" viewBox="0 0 24 24" fill="#0088cc"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.781-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.008-1.252-.241-1.865-.44-.752-.244-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635.099-.002.321.023.465.141.121.099.155.232.171.326.016.094.036.308.02.475z"/></svg>
        <strong>æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Ÿ</strong>
        <a href="https://t.me/+7jcTMePlNVwwZjg1" target="_blank" style="color:#0088cc;text-decoration:none;font-weight:bold;">
          åŠ å…¥ç”µæŠ¥ç¾¤
        </a>
        è·å–æµ‹è¯•å…¼å®¹çš„é…ç½®æ–‡ä»¶æ¨¡æ¿ï¼Œå¼€ç®±å³ç”¨ï¼
      </span>
    </div>
  </div>

  <div style="margin-top:8px">
    <b>æ—¥å¿—ï¼š</b> æ–‡ä»¶å¤§å°: <?= $logSizeFormatted ?> | æ€»è¡Œæ•°: <?= $logLines ?> è¡Œ | è‡ªåŠ¨æ¸…ç†: æ¯6å°æ—¶ + å¯åŠ¨æ—¶
    <button onclick="openLogViewer()" style="margin-left:8px;background:#17a2b8;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">
      <i class="fa fa-eye"></i> æŸ¥çœ‹æ—¥å¿—
    </button>
  </div>

  <div style="margin-top:8px">
    <b>å¼€æœºå¯åŠ¨ï¼š</b>
    <form method="POST" style="display:inline-block;margin:0 8px;vertical-align:middle">
      <input type="hidden" name="cmd" value="set_bootstart" />
      <label>
        <input type="checkbox" name="enable" value="1" <?= $bootstartOn ? 'checked' : '' ?> onchange="this.form.submit()" />
        å¼€æœºè‡ªåŠ¨å¯åŠ¨ Mihomo
      </label>
    </form>
    <span style="color:#6c757d">
      <?= $bootstartOn ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨' ?>
    </span>
  </div>

  <div style="margin-top:10px">
    <button onclick="openConsole()" style="background:#17a2b8;color:white;">æ‰“å¼€æ§åˆ¶å°</button>
    <button onclick="executeAction('start')">å¯åŠ¨</button>
    <button onclick="executeAction('stop')">åœæ­¢</button>
    <button onclick="executeAction('restart')">é‡å¯æœåŠ¡</button>
    <button onclick="executeAction('clearlog')">æ¸…ç©ºæ—¥å¿—</button>
  </div>
</div>

<!-- é…ç½®ç¼–è¾‘å¼¹å‡ºçª—å£ -->
<div id="configModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow:auto;box-sizing:border-box;">
  <div style="position:relative;margin:8% auto 5% auto;background:white;border-radius:8px;padding:20px;width:90%;max-width:1200px;min-height:600px;box-shadow:0 4px 20px rgba(0,0,0,0.3);box-sizing:border-box;">
    <div style="margin-bottom:15px;border-bottom:1px solid #eee;padding-bottom:10px;">
      <h3 style="margin:0;">ç¼–è¾‘é…ç½®: <?= htmlspecialchars($selectedName) ?></h3>
    </div>
    <form method="POST" style="display:flex;flex-direction:column;">
      <input type="hidden" name="cmd" value="saveconf" />
      <div style="margin-bottom:15px;">
        <textarea name="content" style="width:100%;height:500px;font-family:monospace;font-size:14px;border:1px solid #ddd;border-radius:4px;padding:10px;resize:vertical;box-sizing:border-box;" spellcheck="false" <?= $selectedPath? '':'disabled' ?>><?php echo htmlspecialchars($confText); ?></textarea>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid #eee;padding-top:15px;">
        <label><input type="checkbox" name="restart" value="1" <?= $selectedPath? '':'disabled' ?> /> ä¿å­˜åé‡å¯æœåŠ¡</label>
        <div>
          <button type="button" onclick="closeConfigEditor()" style="margin-right:10px;padding:8px 16px;border:1px solid #ddd;background:white;border-radius:4px;cursor:pointer;">å–æ¶ˆ</button>
          <button type="submit" <?= $selectedPath? '':'disabled' ?> style="padding:8px 16px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;">ä¿å­˜é…ç½®</button>
        </div>
      </div>
    </form>
    <small style="color:#6c757d;margin-top:10px;display:block;"><?= $selectedPath? 'ä¿å­˜å°†ç›´æ¥è¦†ç›–æ‰€é€‰é…ç½®ï¼ˆä¸Šé™ 1MBï¼‰ã€‚':'å°šæœªé€‰æ‹©é…ç½®æ–‡ä»¶ã€‚' ?></small>
  </div>
</div>

<!-- æ—¥å¿—æŸ¥çœ‹å™¨å¼¹å‡ºçª—å£ -->
<div id="logModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow:auto;box-sizing:border-box;">
  <div style="position:relative;margin:5% auto 5% auto;background:white;border-radius:8px;padding:20px;width:90%;max-width:1200px;min-height:600px;box-shadow:0 4px 20px rgba(0,0,0,0.3);box-sizing:border-box;">
    <div style="margin-bottom:15px;border-bottom:1px solid #eee;padding-bottom:10px;">
      <h3 style="margin:0;">Mihomo æ—¥å¿—æŸ¥çœ‹å™¨</h3>
      <div style="margin-top:8px;color:#6c757d;font-size:14px;">
        æ–‡ä»¶å¤§å°: <?= $logSizeFormatted ?> | æ€»è¡Œæ•°: <?= $logLines ?> è¡Œ | æ˜¾ç¤ºæœ€è¿‘ 200 è¡Œ
      </div>
    </div>
    <div style="margin-bottom:15px;">
      <div style="display:flex;gap:10px;margin-bottom:10px;">
        <button onclick="refreshLogViewer()" style="padding:6px 12px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;">
          <i class="fa fa-refresh"></i> åˆ·æ–°æ—¥å¿—
        </button>
        <button onclick="executeLogAction('clearlog')" style="padding:6px 12px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;">
          <i class="fa fa-trash"></i> æ¸…ç©ºæ—¥å¿—
        </button>
      </div>
      <div style="border:1px solid #ddd;border-radius:4px;background:#f8f9fa;max-height:500px;overflow:auto;">
        <pre id="logContent" style="margin:0;padding:15px;font-family:monospace;font-size:12px;line-height:1.4;white-space:pre-wrap;word-wrap:break-word;"><?= htmlspecialchars($logTail) ?></pre>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid #eee;padding-top:15px;">
      <div style="color:#6c757d;font-size:12px;">
        è‡ªåŠ¨æ¸…ç†: æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡ + å¯åŠ¨æ—¶æ£€æŸ¥ | è¶…è¿‡2MBæ—¶ä¿ç•™æœ€è¿‘1000è¡Œ
      </div>
      <button onclick="closeLogViewer()" style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:4px;cursor:pointer;">å…³é—­</button>
    </div>
  </div>
</div>

<div id="download-msg" style="font-size:12px;color:#6c757d;margin-top:6px"></div>
<script>
// é¡µé¢åŠ è½½åå¼€å§‹è½®è¯¢è¿›åº¦
pollProgress('core', 'progress-core');
pollProgress('ui', 'progress-ui');

// é¡µé¢åŠ è½½åè‡ªåŠ¨æ£€æŸ¥æ›´æ–°ï¼ˆé™é»˜æ¨¡å¼ï¼‰
window.addEventListener('load', function() {
  // 1ç§’åæ£€æŸ¥æ ¸å¿ƒæ›´æ–°
  setTimeout(function() {
    checkUpdate(true); // é™é»˜æ¨¡å¼ï¼Œä¸æ˜¾ç¤º"æ£€æŸ¥ä¸­..."æç¤º
  }, 1000);
  
  // 1.5ç§’åæ£€æŸ¥ UI æ›´æ–°
  setTimeout(function() {
    checkUIUpdate(true); // é™é»˜æ¨¡å¼ï¼Œä¸æ˜¾ç¤º"æ£€æŸ¥ä¸­..."æç¤º
  }, 1500);
  
  // å®šæœŸæ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆæ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æœåŠ¡çŠ¶æ€ï¼‰
  setInterval(function() {
    updateDownloadButtonState();
    updateUIDownloadButtonState();
  }, 3000);
});

// å¡«å…… Zashboard è®¿é—®ä¿¡æ¯ï¼ˆä¸»æœº/ç«¯å£/å¯†ç ï¼‰
document.addEventListener('DOMContentLoaded', function() {
  var elHost = document.getElementById('zash-host');
  if (elHost) {
    elHost.textContent = window.location.hostname || '-';
  }
});

// æ—¥å¿—æŸ¥çœ‹å™¨åŠŸèƒ½
function openLogViewer() {
  document.getElementById('logModal').style.display = 'block';
  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨æ˜¾ç¤ºæœ€æ–°æ—¥å¿—
  setTimeout(function() {
    var logContent = document.getElementById('logContent');
    logContent.scrollTop = logContent.scrollHeight;
  }, 100);
}

function closeLogViewer() {
  document.getElementById('logModal').style.display = 'none';
}

function refreshLogViewer() {
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  var logContent = document.getElementById('logContent');
  var originalContent = logContent.innerHTML;
  logContent.innerHTML = '<span style="color:#6c757d;">æ­£åœ¨åˆ·æ–°æ—¥å¿—...</span>';
  
  // åˆ·æ–°é¡µé¢ä»¥è·å–æœ€æ–°æ—¥å¿—
  setTimeout(function() {
    window.location.reload();
  }, 500);
}

function executeLogAction(action) {
  var actionText = '';
  switch(action) {
    case 'clearlog': actionText = 'æ¸…ç©ºæ—¥å¿—'; break;
  }
  
  if (confirm('ç¡®å®šè¦' + actionText + 'å—ï¼Ÿ')) {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    var logContent = document.getElementById('logContent');
    logContent.innerHTML = '<span style="color:#6c757d;">æ­£åœ¨' + actionText + '...</span>';
    
    // æ‰§è¡Œæ“ä½œ
    var url = new URL(window.location);
    url.searchParams.set('cmd', action);
    
    fetch(url.toString())
      .then(function(response) {
        return response.text();
      })
      .then(function(data) {
        // æ“ä½œå®Œæˆååˆ·æ–°æ—¥å¿—
        setTimeout(function() {
          window.location.reload();
        }, 1000);
      })
      .catch(function(error) {
        logContent.innerHTML = '<span style="color:#dc3545;">æ“ä½œå¤±è´¥: ' + error + '</span>';
      });
  }
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.onclick = function(event) {
  var logModal = document.getElementById('logModal');
  if (event.target == logModal) {
    closeLogViewer();
  }
}

// ESCé”®å…³é—­æ¨¡æ€æ¡†
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeLogViewer();
  }
});
</script>
</body>
</html>
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/api.php">
<INLINE><![CDATA[
<?php
// è½»é‡ APIï¼šçº¯æ–‡æœ¬è¿”å›ï¼Œé¿å… emhttp å¤–å±‚ HTML åŒ…è£…
header('Content-Type: text/plain; charset=utf-8');

$baseRun = '/usr/local/emhttp/plugins/easy-mihomo';
$scripts = $baseRun . '/scripts';
$progressDir = '/var/tmp/easy-mihomo-progress';
@mkdir($progressDir, 0777, true);

// ä»é…ç½®æ–‡ä»¶ä¸­è§£æç«¯å£å’Œå¯†ç ä¿¡æ¯
function getMihomoConfigValues($configPath) {
    if (!file_exists($configPath)) {
        return ['controller' => null, 'secret' => null, 'port' => null];
    }
    
    $content = file_get_contents($configPath);
    $controller = null;
    $secret = null;
    $port = null;
    
    // è§£æ external-controller
    if (preg_match('/external-controller:\s*(.+)/', $content, $matches)) {
        $controller = trim($matches[1]);
        // ä»controllerä¸­æå–ç«¯å£
        if (strpos($controller, ':') !== false) {
            $port = explode(':', $controller)[1] ?? null;
        }
    }
    
    // è§£æ secret
    if (preg_match('/secret:\s*(.+)/', $content, $matches)) {
        $secret = trim($matches[1]);
    }
    
    return ['controller' => $controller, 'secret' => $secret, 'port' => $port];
}

$cmd = $_GET['cmd'] ?? $_POST['cmd'] ?? '';
if ($cmd === 'get_progress') {
  $target = $_GET['target'] ?? $_POST['target'] ?? '';
  $file = '';
  if ($target === 'core') $file = $progressDir . '/core.status';
  if ($target === 'ui')   $file = $progressDir . '/ui.status';
  if ($file && is_file($file)) { echo @file_get_contents($file); }
  exit;
}
if ($cmd === 'check_update') {
  header('Content-Type: application/json; charset=utf-8');
  $updateInfo = shell_exec("bash $scripts/check_update.sh 2>&1");
  echo $updateInfo;
  exit;
}
// æ£€æŸ¥ UI æ›´æ–°
if ($cmd === 'check_ui_update') {
  header('Content-Type: application/json; charset=utf-8');
  $uiUpdateInfo = shell_exec("bash $scripts/check_ui_update.sh 2>&1");
  echo $uiUpdateInfo;
  exit;
}
if ($cmd === 'start_download') {
  $target = $_GET['target'] ?? $_POST['target'] ?? '';
  if ($target === 'core') {
    @unlink($progressDir . '/core.status');
    $out = shell_exec("nohup bash $scripts/download_core.sh --progress >$progressDir/core.log 2>&1 & echo $!");
    echo 'æ ¸å¿ƒä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ PID: ' . trim($out);
  } elseif ($target === 'ui') {
    @unlink($progressDir . '/ui.status');
    $out = shell_exec("nohup bash $scripts/download_ui.sh --progress >$progressDir/ui.log 2>&1 & echo $!");
    echo 'UI ä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ PID: ' . trim($out);
  } else {
    echo 'æœªçŸ¥çš„ä¸‹è½½ç›®æ ‡';
  }
  exit;
}
if ($cmd === 'dashboard_status') {
  // è¿”å›JSONæ ¼å¼çš„ä»ªè¡¨æ¿æ•°æ®
  header('Content-Type: application/json; charset=utf-8');
  
  // è·å–mihomoçŠ¶æ€
  $status = shell_exec("bash $scripts/status.sh 2>&1");
  $version = shell_exec("bash $scripts/version.sh 2>&1");
  
  $isRunning = strpos($status, 'running') !== false;
  $pid = '';
  if (preg_match('/pid=(\d+)/', $status, $matches)) {
    $pid = $matches[1];
  }
  
  // è·å–å†…å­˜ä½¿ç”¨ä¿¡æ¯
  $memoryUsage = '0 MB';
  if ($pid) {
    $memoryInfo = shell_exec("ps -o rss= -p $pid 2>/dev/null");
    if ($memoryInfo) {
      $memoryKB = intval(trim($memoryInfo));
      $memoryMB = round($memoryKB / 1024, 1);
      $memoryUsage = $memoryMB . ' MB';
    }
  }
  
  // è·å–è¿è¡Œæ—¶é—´ä¿¡æ¯
  $uptime = 'æœªçŸ¥';
  if ($pid) {
    $startTime = shell_exec("ps -o lstart= -p $pid 2>/dev/null");
    if ($startTime) {
      $startTimestamp = strtotime(trim($startTime));
      if ($startTimestamp) {
        $currentTime = time();
        $diff = $currentTime - $startTimestamp;
        
        $hours = floor($diff / 3600);
        $minutes = floor(($diff % 3600) / 60);
        
        if ($hours > 0) {
          $uptime = $hours . 'h' . $minutes . 'm';
        } else {
          $uptime = $minutes . 'm';
        }
      }
    }
  }
  
  // è·å–é…ç½®ä¿¡æ¯
  $confDir = '/boot/config/plugins/easy-mihomo';
  $selectFile = $confDir . '/selected.conf';
  $selectedName = is_file($selectFile) ? trim(@file_get_contents($selectFile)) : '';
  $selectedPath = ($selectedName && is_file($confDir . '/' . $selectedName)) ? ($confDir . '/' . $selectedName) : '';
  
  // è§£æé…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£å’Œå¯†ç ä¿¡æ¯
  $configValues = getMihomoConfigValues($selectedPath);
  $controller = $configValues['controller'];
  $secret = $configValues['secret'];
  $port = $configValues['port'];
  
  $result = [
    'running' => $isRunning,
    'status' => trim($status),
    'version' => trim($version),
    'pid' => $pid,
    'memory' => $memoryUsage,
    'uptime' => $uptime,
    'config' => [
      'selected_config' => $selectedName,
      'config_path' => $selectedPath,
      'has_config' => !empty($selectedPath),
      'controller' => $controller,
      'secret' => $secret,
      'port' => $port
    ]
  ];
  
  echo json_encode($result);
  exit;
}
if ($cmd === 'start') {
  $out = shell_exec("bash $scripts/start.sh 2>&1");
  echo htmlspecialchars($out ?? '');
  exit;
}
if ($cmd === 'stop') {
  $out = shell_exec("bash $scripts/stop.sh 2>&1");
  echo htmlspecialchars($out ?? '');
  exit;
}
if ($cmd === 'restart') {
  $out = shell_exec("bash $scripts/restart.sh 2>&1");
  echo htmlspecialchars($out ?? '');
  exit;
}
echo 'unknown command';
]]></INLINE>
</FILE>

<!-- scripts -->
<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/start.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
BIN="/usr/local/bin/mihomo"
CONF_DIR="/boot/config/plugins/easy-mihomo"
SELECT_FILE="$CONF_DIR/selected.conf"
if [ -f "$SELECT_FILE" ]; then
  NAME=$(cat "$SELECT_FILE" 2>/dev/null || true)
  if [ -n "$NAME" ] && [ -f "$CONF_DIR/$NAME" ]; then
    CONF_FILE="$CONF_DIR/$NAME"
  else
    echo "æœªæ‰¾åˆ°æœ‰æ•ˆçš„å·²é€‰é…ç½® ("$NAME")" >&2; exit 1
  fi
else
  echo "æœªé€‰æ‹©é…ç½®ï¼Œè¯·å…ˆåœ¨é¡µé¢ä¸­é€‰æ‹©" >&2; exit 1
fi
LOG_FILE="/var/log/mihomo.log"
PID_FILE="/var/run/mihomo.pid"

# é˜²é‡å¤å¯åŠ¨æ£€æŸ¥ï¼ˆå¿…é¡»åœ¨æœ€å‰é¢ï¼‰
if [ -f "$PID_FILE" ]; then
  PID=$(cat "$PID_FILE" 2>/dev/null || true)
  if [ -n "$PID" ] && ps -p "$PID" >/dev/null 2>&1; then
    echo "running (pid $PID)"
    exit 0
  fi
fi

# å¯åŠ¨å‰æ¸…ç†æ—¥å¿—ï¼ˆé˜²æ­¢æ—¥å¿—è¿‡å¤§å½±å“æ€§èƒ½ï¼‰
LOG_CLEANUP_SCRIPT="/usr/local/emhttp/plugins/easy-mihomo/scripts/log_cleanup.sh"
if [ -x "$LOG_CLEANUP_SCRIPT" ]; then
  "$LOG_CLEANUP_SCRIPT" >/dev/null 2>&1 || true
fi

# ç®€åŒ–æ ¸å¿ƒæ–‡ä»¶æ£€æŸ¥ï¼ˆä¸å†æ¯”è¾ƒç‰ˆæœ¬å·ï¼‰
# åŸç†ï¼šä¸‹è½½æ ¸å¿ƒæ—¶ä¼šåˆ é™¤å†…å­˜æ–‡ä»¶ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨ä»Uç›˜å¤åˆ¶æœ€æ–°ç‰ˆæœ¬
  UDISK_BIN="/boot/config/plugins/easy-mihomo/mihomo"

# æ£€æŸ¥Uç›˜æ ¸å¿ƒæ˜¯å¦å­˜åœ¨
if [ ! -f "$UDISK_BIN" ]; then
  if [ ! -f "$BIN" ]; then
    echo "æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼Œè¯·å…ˆä¸‹è½½æ ¸å¿ƒ" >> "$LOG_FILE" 2>&1
    echo "æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼Œè¯·å…ˆä¸‹è½½æ ¸å¿ƒ"
    exit 1
  fi
  # Uç›˜æ²¡æœ‰ä½†å†…å­˜æœ‰ï¼ˆç½•è§æƒ…å†µï¼‰ï¼Œç»§ç»­ä½¿ç”¨å†…å­˜ç‰ˆæœ¬
  echo "è­¦å‘Šï¼šUç›˜æ ¸å¿ƒæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨å†…å­˜ç°æœ‰ç‰ˆæœ¬" >> "$LOG_FILE" 2>&1
else
  # æ£€æŸ¥å†…å­˜ä¸­æ˜¯å¦æœ‰æ ¸å¿ƒ
  if [ ! -f "$BIN" ]; then
    # å†…å­˜ä¸­ä¸å­˜åœ¨ï¼Œä»Uç›˜å¤åˆ¶ï¼ˆé¦–æ¬¡å¯åŠ¨æˆ–æ›´æ–°æ ¸å¿ƒåï¼‰
    echo "æ£€æµ‹åˆ°å†…å­˜ä¸­æ— æ ¸å¿ƒæ–‡ä»¶ï¼Œä»Uç›˜å¤åˆ¶..." >> "$LOG_FILE" 2>&1
    mkdir -p /usr/local/bin
    cp -f "$UDISK_BIN" "$BIN"
    chmod +x "$BIN"
    echo "æ ¸å¿ƒæ–‡ä»¶å·²ä»Uç›˜å¤åˆ¶åˆ°å†…å­˜" >> "$LOG_FILE" 2>&1
  else
    # å†…å­˜ä¸­å·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ï¼ˆä¸è¿›è¡Œç‰ˆæœ¬æ¯”è¾ƒï¼‰
    echo "æ ¸å¿ƒæ–‡ä»¶å°±ç»ªï¼Œç›´æ¥å¯åŠ¨" >> "$LOG_FILE" 2>&1
  fi
fi

# UI è¿è¡Œäºå†…å­˜ï¼Œç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶è·¯å¾„æŒ‡å‘å†…å­˜ç›®å½•
UI_ZIP_PATH="/boot/config/plugins/easy-mihomo/zashboard.zip"
UI_RAM_DIR="/var/tmp/easy-mihomo-ui/zashboard"

# æ¯æ¬¡å¯åŠ¨éƒ½é‡æ–°è§£å‹UIåˆ°å†…å­˜ï¼ˆç¡®ä¿æœ€æ–°ï¼‰
if [ -f "$UI_ZIP_PATH" ]; then
  echo "è§£å‹ UI åˆ°å†…å­˜ï¼ˆè¦†ç›–ï¼‰..." >> "$LOG_FILE" 2>&1
  rm -rf "$UI_RAM_DIR" && mkdir -p "$UI_RAM_DIR"
  if command -v unzip >/dev/null 2>&1; then
    unzip -oq "$UI_ZIP_PATH" -d "$UI_RAM_DIR" >> "$LOG_FILE" 2>&1 || true
  elif command -v busybox >/dev/null 2>&1; then
    busybox unzip -oq "$UI_ZIP_PATH" -d "$UI_RAM_DIR" >> "$LOG_FILE" 2>&1 || true
  fi
  # è‹¥æœ‰ dist/ å­ç›®å½•ï¼Œä¸Šç§»å…¶å†…å®¹å¹¶åˆ é™¤
  if [ -d "$UI_RAM_DIR/dist" ]; then
    cp -rf "$UI_RAM_DIR/dist/." "$UI_RAM_DIR/" 2>>"$LOG_FILE" || true
    rm -rf "$UI_RAM_DIR/dist" 2>>"$LOG_FILE" || true
  fi
  echo "UI è§£å‹å®Œæˆ" >> "$LOG_FILE" 2>&1
else
  echo "UI zipæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡è§£å‹" >> "$LOG_FILE" 2>&1
fi

# åœ¨mihomoå·¥ä½œç›®å½•å†…åˆ›å»ºbind mountæŒ‡å‘å†…å­˜UIç›®å½•
UI_MOUNT_DIR="/boot/config/plugins/easy-mihomo/ui/zashboard"
echo "åˆ›å»ºUI bind mount..." >> "$LOG_FILE" 2>&1

# ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
mkdir -p "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true

# å¦‚æœå·²ç»æŒ‚è½½ï¼Œå…ˆå¸è½½
if mountpoint -q "$UI_MOUNT_DIR" 2>/dev/null; then
  echo "å¸è½½ç°æœ‰bind mount: $UI_MOUNT_DIR" >> "$LOG_FILE" 2>&1
  umount "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || umount -l "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
fi

# æ¸…ç†ç›®å½•å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if [ -d "$UI_MOUNT_DIR" ] && [ ! -L "$UI_MOUNT_DIR" ]; then
  echo "æ¸…ç†ç›®å½•å†…å®¹: $UI_MOUNT_DIR" >> "$LOG_FILE" 2>&1
  rm -rf "$UI_MOUNT_DIR"/* 2>>"$LOG_FILE" || true
fi

# åˆ›å»ºbind mount
echo "åˆ›å»ºbind mount: $UI_MOUNT_DIR <- $UI_RAM_DIR" >> "$LOG_FILE" 2>&1
mount --bind "$UI_RAM_DIR" "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || {
  echo "bind mountåˆ›å»ºå¤±è´¥ï¼Œå°è¯•æ¸…ç†åé‡è¯•..." >> "$LOG_FILE" 2>&1
  # å¦‚æœå¤±è´¥ï¼Œæ¸…ç†ç›®å½•åé‡è¯•
  rm -rf "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
  mkdir -p "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
  mount --bind "$UI_RAM_DIR" "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
}

# éªŒè¯bind mountæ˜¯å¦æˆåŠŸ
if mountpoint -q "$UI_MOUNT_DIR" 2>/dev/null; then
  echo "bind mountåˆ›å»ºæˆåŠŸ" >> "$LOG_FILE" 2>&1
else
  echo "bind mountåˆ›å»ºå¤±è´¥ï¼Œä½¿ç”¨è½¯é“¾æ¥ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ..." >> "$LOG_FILE" 2>&1
  rm -rf "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
  ln -s "$UI_RAM_DIR" "$UI_MOUNT_DIR" 2>>"$LOG_FILE" || true
fi

# æ£€æŸ¥å¹¶ä¿®å¤é…ç½®æ–‡ä»¶ä¸­çš„UIè·¯å¾„
if [ -f "$CONF_FILE" ]; then
  # è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†å‰ï¼Œå¤‡ä»½ä¸€æ¬¡é…ç½®ï¼ˆä»…ä¿ç•™å•ä¸ªå¤‡ä»½æ–‡ä»¶ï¼‰
  cp "$CONF_FILE" "$CONF_FILE.bak" 2>/dev/null || true

  # åªè¦†å†™UIç›¸å…³é…ç½®é¡¹ï¼Œä¿éšœUIåŠŸèƒ½æ­£å¸¸
  DESIRED_UI_URL="https://github.com/Zephyruso/zashboard/releases/latest/download/dist.zip"
  DESIRED_UI_NAME="zashboard"
  DESIRED_UI_PATH="ui"

  upsert_yaml_key(){
    local key="$1"; shift
    local val="$1"; shift
    # è½¬ä¹‰ / å’Œ &ï¼Œé¿å… sed æ›¿æ¢å†²çª
    local esc_val
    esc_val=$(printf '%s' "$val" | sed 's/[&\/]/\\&/g')
    if grep -qE "^${key}:" "$CONF_FILE"; then
      sed -i "s|^${key}:.*|${key}: ${esc_val}|g" "$CONF_FILE"
    else
      echo "${key}: ${val}" >> "$CONF_FILE"
    fi
  }

  echo "æ ‡å‡†åŒ–UIé…ç½®é¡¹ï¼ˆexternal-ui-url / external-ui-name / external-uiï¼‰..." >> "$LOG_FILE" 2>&1
  upsert_yaml_key "external-ui-url" "$DESIRED_UI_URL"
  upsert_yaml_key "external-ui-name" "$DESIRED_UI_NAME"
  upsert_yaml_key "external-ui" "$DESIRED_UI_PATH"
else
  echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡UIè·¯å¾„æ£€æŸ¥" >> "$LOG_FILE" 2>&1
fi

if [ ! -x "$BIN" ]; then echo "äºŒè¿›åˆ¶ç¼ºå¤±: $BIN" >&2; exit 1; fi
if [ ! -f "$CONF_FILE" ]; then echo "é…ç½®æ–‡ä»¶ç¼ºå¤±: $CONF_FILE" >&2; exit 1; fi

# å°è¯•åŠ è½½ TUNï¼ˆå¿½ç•¥å¤±è´¥ï¼‰
modprobe tun 2>/dev/null || true

# åå°å¯åŠ¨
nohup "$BIN" -d "$CONF_DIR" -f "$CONF_FILE" >> "$LOG_FILE" 2>&1 &
NEWPID=$!
echo $NEWPID > "$PID_FILE"
sleep 1

if ps -p "$NEWPID" >/dev/null 2>&1; then
  echo "started (pid $NEWPID)"
  exit 0
else
  echo "start failed, see $LOG_FILE" >&2
  exit 1
fi
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/stop.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
PID_FILE="/var/run/mihomo.pid"

# ä¼˜å…ˆæŒ‰ pidfile åœæ­¢
if [ -f "$PID_FILE" ]; then
  PID=$(cat "$PID_FILE" 2>/dev/null || true)
  if [ -n "$PID" ] && ps -p "$PID" >/dev/null 2>&1; then
    kill "$PID" 2>/dev/null || true
  fi
fi

# å…œåº•æŒ‰è¿›ç¨‹ååœæ­¢
if pgrep -x mihomo >/dev/null 2>&1; then
  # ç­‰å¾…ä¼˜é›…é€€å‡º
  for i in $(seq 1 5); do
    if pgrep -x mihomo >/dev/null 2>&1; then
      sleep 1
    else
      break
    fi
  done
  # ä»å­˜æ´»åˆ™å¼ºæ€
  if pgrep -x mihomo >/dev/null 2>&1; then
    pkill -9 -x mihomo 2>/dev/null || true
  fi
fi

# æ¸…ç†UI bind mountæˆ–è½¯é“¾æ¥
UI_MOUNT_DIR="/boot/config/plugins/easy-mihomo/ui/zashboard"
if mountpoint -q "$UI_MOUNT_DIR" 2>/dev/null; then
  echo "å¸è½½bind mount: $UI_MOUNT_DIR" >&2
  umount "$UI_MOUNT_DIR" 2>/dev/null || umount -l "$UI_MOUNT_DIR" 2>/dev/null || true
elif [ -L "$UI_MOUNT_DIR" ]; then
  echo "æ¸…ç†è½¯é“¾æ¥: $UI_MOUNT_DIR" >&2
  rm -f "$UI_MOUNT_DIR" 2>/dev/null || true
elif [ -d "$UI_MOUNT_DIR" ]; then
  echo "æ¸…ç†ç›®å½•: $UI_MOUNT_DIR" >&2
  rm -rf "$UI_MOUNT_DIR" 2>/dev/null || true
fi

# æ¸…ç† pidfileï¼ˆè‹¥è¿›ç¨‹å·²ä¸å­˜åœ¨ï¼‰
if [ -f "$PID_FILE" ]; then
  if ! ps -p $(cat "$PID_FILE" 2>/dev/null || echo 0) >/dev/null 2>&1; then
    rm -f "$PID_FILE"
  fi
fi

echo "stopped"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/restart.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
SCRIPT_DIR="/usr/local/emhttp/plugins/easy-mihomo/scripts"

bash "$SCRIPT_DIR/stop.sh" || true
sleep 1
bash "$SCRIPT_DIR/start.sh"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/status.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
PID_FILE="/var/run/mihomo.pid"
STATUS="stopped"; PID=""
if pgrep -x mihomo >/dev/null 2>&1; then STATUS="running"; PID=$(pgrep -x mihomo | head -n1); fi
echo "status=$STATUS pid=$PID"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/version.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
VERSION_FILE="/boot/config/plugins/easy-mihomo/.version"

# è¯»å–ç‰ˆæœ¬æ–‡ä»¶ï¼ˆæ ¼å¼ï¼šç‰ˆæœ¬å·|ç‰ˆæœ¬ç±»å‹ï¼Œä¾‹å¦‚ï¼š1.19.15|v3ï¼‰
if [ -f "$VERSION_FILE" ]; then
  CONTENT=$(cat "$VERSION_FILE" 2>/dev/null | tr -d '\n\r' || echo "")
  if [ -n "$CONTENT" ]; then
    # æå–ç‰ˆæœ¬å·ï¼ˆåˆ†éš”ç¬¦å‰çš„éƒ¨åˆ†ï¼‰
    VERSION=$(echo "$CONTENT" | cut -d'|' -f1)
    if [ -n "$VERSION" ]; then
      echo "$VERSION"
      exit 0
    fi
  fi
fi

# ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º
echo "unknown"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/ui_version.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e
UI_VERSION_FILE="/boot/config/plugins/easy-mihomo/.ui-version"

# è¯»å– UI ç‰ˆæœ¬æ–‡ä»¶
if [ -f "$UI_VERSION_FILE" ]; then
  UI_VERSION=$(cat "$UI_VERSION_FILE" 2>/dev/null | tr -d '\n\r' || echo "")
  if [ -n "$UI_VERSION" ]; then
    echo "$UI_VERSION"
    exit 0
  fi
fi

# ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º
echo "unknown"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/check_update.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e

GITHUB_REPO="MetaCubeX/mihomo"
GITHUB_API="https://api.github.com/repos/$GITHUB_REPO/releases/latest"
TMP_JSON="/tmp/mihomo-check-update.json"
VERSION_FILE="/boot/config/plugins/easy-mihomo/.version"

# è¯»å–ç‰ˆæœ¬æ–‡ä»¶ï¼ˆæ ¼å¼ï¼šç‰ˆæœ¬å·|ç‰ˆæœ¬ç±»å‹ï¼Œä¾‹å¦‚ï¼š1.19.15|v3ï¼‰
LOCAL_VERSION=""
if [ -f "$VERSION_FILE" ]; then
  CONTENT=$(cat "$VERSION_FILE" 2>/dev/null | tr -d '\n\r' || echo "")
  if [ -n "$CONTENT" ]; then
    # æå–ç‰ˆæœ¬å·ï¼ˆåˆ†éš”ç¬¦å‰çš„éƒ¨åˆ†ï¼‰
    LOCAL_VERSION=$(echo "$CONTENT" | cut -d'|' -f1)
  fi
fi

# å¦‚æœç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œæ£€æŸ¥æ ¸å¿ƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ -z "$LOCAL_VERSION" ]; then
  UDISK_BIN="/boot/config/plugins/easy-mihomo/mihomo"
  if [ -f "$UDISK_BIN" ]; then
    LOCAL_VERSION="unknown"
  else
    LOCAL_VERSION="not installed"
  fi
fi

# è·å–è¿œç¨‹æœ€æ–°ç‰ˆæœ¬ï¼ˆä½¿ç”¨åˆ†æ®µè¶…æ—¶ï¼‰
REMOTE_VERSION=""
if wget -q --connect-timeout=8 --read-timeout=15 --tries=2 --waitretry=2 -O "$TMP_JSON" "$GITHUB_API" 2>/dev/null; then
  REMOTE_VERSION=$(grep -o '"tag_name"[[:space:]]*:[[:space:]]*"[^"]*"' "$TMP_JSON" | head -n1 | sed 's/.*"tag_name"[[:space:]]*:[[:space:]]*"v\?\([^"]*\)".*/\1/')
  rm -f "$TMP_JSON"
fi

# è¾“å‡ºç»“æœï¼ˆJSONæ ¼å¼ï¼‰
echo "{"
echo "  \"local\": \"$LOCAL_VERSION\","
echo "  \"remote\": \"$REMOTE_VERSION\","

if [ -z "$REMOTE_VERSION" ]; then
  echo "  \"has_update\": false,"
  echo "  \"message\": \"æ— æ³•è·å–è¿œç¨‹ç‰ˆæœ¬ä¿¡æ¯\""
elif [ "$LOCAL_VERSION" = "not installed" ]; then
  echo "  \"has_update\": true,"
  echo "  \"message\": \"æ ¸å¿ƒæœªå®‰è£…ï¼Œæœ€æ–°ç‰ˆæœ¬: $REMOTE_VERSION\""
elif [ "$LOCAL_VERSION" != "$REMOTE_VERSION" ]; then
  echo "  \"has_update\": true,"
  echo "  \"message\": \"å‘ç°æ–°ç‰ˆæœ¬: $REMOTE_VERSION\""
else
  echo "  \"has_update\": false,"
  echo "  \"message\": \"å·²æ˜¯æœ€æ–°ç‰ˆæœ¬\""
fi

echo "}"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/check_ui_update.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e

GITHUB_REPO="Zephyruso/zashboard"
GITHUB_API="https://api.github.com/repos/$GITHUB_REPO/releases/latest"
TMP_JSON="/tmp/zashboard-check-update.json"
UI_VERSION_FILE="/boot/config/plugins/easy-mihomo/.ui-version"

# è·å–æœ¬åœ° UI ç‰ˆæœ¬
LOCAL_UI_VERSION=""
if [ -f "$UI_VERSION_FILE" ]; then
  LOCAL_UI_VERSION=$(cat "$UI_VERSION_FILE" 2>/dev/null | tr -d '\n\r' || echo "")
fi

# å¦‚æœæœ¬åœ°ç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œæ£€æŸ¥ ZIP æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ -z "$LOCAL_UI_VERSION" ]; then
  UI_ZIP="/boot/config/plugins/easy-mihomo/zashboard.zip"
  if [ -f "$UI_ZIP" ]; then
    LOCAL_UI_VERSION="unknown"
  else
    LOCAL_UI_VERSION="not installed"
  fi
fi

# è·å–è¿œç¨‹æœ€æ–°ç‰ˆæœ¬
REMOTE_UI_VERSION=""
if wget -q --connect-timeout=8 --read-timeout=15 --tries=2 --waitretry=2 -O "$TMP_JSON" "$GITHUB_API" 2>/dev/null; then
  REMOTE_UI_VERSION=$(grep -o '"tag_name"[[:space:]]*:[[:space:]]*"[^"]*"' "$TMP_JSON" | head -n1 | sed 's/.*"tag_name"[[:space:]]*:[[:space:]]*"v\?\([^"]*\)".*/\1/')
  rm -f "$TMP_JSON"
fi

# è¾“å‡º JSON ç»“æœ
echo "{"
echo "  \"local\": \"$LOCAL_UI_VERSION\","
echo "  \"remote\": \"$REMOTE_UI_VERSION\","

if [ -z "$REMOTE_UI_VERSION" ]; then
  echo "  \"has_update\": false,"
  echo "  \"message\": \"æ— æ³•è·å–è¿œç¨‹ç‰ˆæœ¬ä¿¡æ¯\""
elif [ "$LOCAL_UI_VERSION" = "not installed" ]; then
  echo "  \"has_update\": true,"
  echo "  \"message\": \"UI æœªå®‰è£…ï¼Œæœ€æ–°ç‰ˆæœ¬: $REMOTE_UI_VERSION\""
elif [ "$LOCAL_UI_VERSION" = "unknown" ]; then
  echo "  \"has_update\": true,"
  echo "  \"message\": \"æ— æ³•ç¡®å®šæœ¬åœ°ç‰ˆæœ¬ï¼Œè¿œç¨‹ç‰ˆæœ¬: $REMOTE_UI_VERSION\""
elif [ "$LOCAL_UI_VERSION" != "$REMOTE_UI_VERSION" ]; then
  echo "  \"has_update\": true,"
  echo "  \"message\": \"å‘ç°æ–°ç‰ˆæœ¬: $REMOTE_UI_VERSION\""
else
  echo "  \"has_update\": false,"
  echo "  \"message\": \"å·²æ˜¯æœ€æ–°ç‰ˆæœ¬\""
fi

echo "}"
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/download_core.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e

PROGRESS=0
if [ "$1" = "--progress" ]; then PROGRESS=1; fi

GITHUB_REPO="MetaCubeX/mihomo"
GITHUB_API="https://api.github.com/repos/$GITHUB_REPO/releases/latest"
TMP_BIN="/tmp/mihomo-latest"
TMP_JSON="/tmp/mihomo-release.json"
STATUS_DIR="/var/tmp/easy-mihomo-progress"
STATUS_FILE="$STATUS_DIR/core.status"
VERSION_FILE="/boot/config/plugins/easy-mihomo/.version"
VARIANT_FILE="/boot/config/plugins/easy-mihomo/variant.conf"
mkdir -p "$STATUS_DIR"

# è¯»å–ç”¨æˆ·é€‰æ‹©çš„ç‰ˆæœ¬ç±»å‹ï¼ˆé»˜è®¤ standardï¼‰
VARIANT="standard"
if [ -f "$VARIANT_FILE" ]; then
  VARIANT=$(cat "$VARIANT_FILE" 2>/dev/null | tr -d '\n\r' || echo "standard")
  # éªŒè¯æœ‰æ•ˆæ€§
  case "$VARIANT" in
    standard|compatible|v3) ;;
    *) VARIANT="standard" ;;
  esac
fi

write_status(){
  echo "$1"
  if [ "$PROGRESS" = "1" ]; then echo "$1" > "$STATUS_FILE"; fi
}

trap 'write_status "error: unexpected failure"' ERR

write_status "5%: æ­£åœ¨è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯..."

# è·å–æœ€æ–° release ä¿¡æ¯ï¼ˆä½¿ç”¨åˆ†æ®µè¶…æ—¶ï¼‰
if ! wget -q --connect-timeout=10 --read-timeout=20 --tries=2 --waitretry=2 -O "$TMP_JSON" "$GITHUB_API"; then
  write_status "error: æ— æ³•è¿æ¥åˆ° GitHub APIï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•"
  rm -f "$TMP_JSON"
  exit 1
fi

write_status "10%: è§£æç‰ˆæœ¬ä¿¡æ¯..."

# æå–ç‰ˆæœ¬å·
RELEASE_TAG=$(grep -o '"tag_name"[[:space:]]*:[[:space:]]*"[^"]*"' "$TMP_JSON" | head -n1 | sed 's/.*"tag_name"[[:space:]]*:[[:space:]]*"v\?\([^"]*\)".*/\1/')

if [ -z "$RELEASE_TAG" ]; then
  write_status "error: æ— æ³•è§£æç‰ˆæœ¬ä¿¡æ¯ï¼ŒGitHub API å“åº”å¼‚å¸¸"
  rm -f "$TMP_JSON"
  exit 1
fi

# æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„ç‰ˆæœ¬ç±»å‹æ„å»ºæ–‡ä»¶åæ¨¡å¼
case "$VARIANT" in
  compatible)
    # å…¼å®¹ç‰ˆï¼šmihomo-linux-amd64-compatible-v{ç‰ˆæœ¬å·}.gz
    PATTERN="mihomo-linux-amd64-compatible-v${RELEASE_TAG}\.gz"
    VARIANT_NAME="å…¼å®¹ç‰ˆ"
    ;;
  v3)
    # v3ä¼˜åŒ–ç‰ˆï¼šmihomo-linux-amd64-v3-v{ç‰ˆæœ¬å·}.gz
    PATTERN="mihomo-linux-amd64-v3-v${RELEASE_TAG}\.gz"
    VARIANT_NAME="v3ä¼˜åŒ–ç‰ˆ"
    ;;
  *)
    # æ ‡å‡†ç‰ˆï¼šmihomo-linux-amd64-v{ç‰ˆæœ¬å·}.gzï¼ˆéœ€æ’é™¤ compatible å’Œ v3ï¼‰
    PATTERN="mihomo-linux-amd64-v${RELEASE_TAG}\.gz"
    VARIANT_NAME="æ ‡å‡†ç‰ˆ"
    ;;
esac

# æå–ä¸‹è½½åœ°å€
DOWNLOAD_URL=$(grep -o '"browser_download_url"[[:space:]]*:[[:space:]]*"[^"]*'"$PATTERN"'"' "$TMP_JSON" | head -n1 | sed 's/.*"browser_download_url"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')

if [ -z "$DOWNLOAD_URL" ]; then
  write_status "error: æ‰¾ä¸åˆ° ${VARIANT_NAME} çš„ä¸‹è½½åœ°å€ï¼Œè¯·æ£€æŸ¥ç‰ˆæœ¬ç±»å‹é€‰æ‹©"
  rm -f "$TMP_JSON"
  exit 1
fi

write_status "15%: å‘ç°æœ€æ–°ç‰ˆæœ¬ v$RELEASE_TAG (${VARIANT_NAME})"
write_status "20%: å¼€å§‹ä¸‹è½½æ ¸å¿ƒæ–‡ä»¶ï¼ˆçº¦12MBï¼Œæ ¹æ®ç½‘é€Ÿéœ€è¦10-60ç§’ï¼‰..."

# ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä½¿ç”¨åˆ†æ®µè¶…æ—¶ï¼Œæ”¯æŒæ…¢é€Ÿç½‘ç»œï¼‰
# --connect-timeout=15: è¿æ¥å»ºç«‹è¶…æ—¶15ç§’ï¼ˆå¿«é€Ÿå‘ç°æ–­ç½‘ï¼‰
# --read-timeout=120: æ•°æ®ä¼ è¾“è¶…æ—¶120ç§’ï¼ˆå…è®¸æ…¢é€Ÿç½‘ç»œï¼‰
# --tries=3: å¤±è´¥åé‡è¯•3æ¬¡
# --waitretry=5: é‡è¯•é—´éš”5ç§’
if ! wget -q --connect-timeout=15 --read-timeout=120 --tries=3 --waitretry=5 --show-progress -O "$TMP_BIN.gz" "$DOWNLOAD_URL" 2>&1 | while IFS= read -r line; do
  # å°è¯•è§£æ wget è¿›åº¦
  if echo "$line" | grep -q "%"; then
    PERCENT=$(echo "$line" | grep -o '[0-9]\+%' | head -n1 | tr -d '%')
    if [ -n "$PERCENT" ] && [ "$PERCENT" -ge 20 ] && [ "$PERCENT" -le 80 ]; then
      write_status "$PERCENT%: æ­£åœ¨ä¸‹è½½..."
    fi
  fi
done; then
  write_status "error: ä¸‹è½½è¶…æ—¶æˆ–ç½‘ç»œä¸­æ–­ï¼ˆå·²å°è¯•3æ¬¡ï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåç‚¹å‡»é‡è¯•"
  rm -f "$TMP_JSON" "$TMP_BIN.gz"
  exit 1
fi

write_status "85%: ä¸‹è½½å®Œæˆï¼Œæ­£åœ¨è§£å‹..."

# è§£å‹æ–‡ä»¶
if gunzip -c "$TMP_BIN.gz" > "$TMP_BIN" 2>/dev/null; then
  chmod +x "$TMP_BIN"
else
  write_status "error: è§£å‹å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½æŸåï¼Œè¯·é‡è¯•ä¸‹è½½"
  rm -f "$TMP_JSON" "$TMP_BIN.gz" "$TMP_BIN"
  exit 1
fi

# éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
if [ ! -s "$TMP_BIN" ]; then
  write_status "error: æ–‡ä»¶æŸåæˆ–ä¸å®Œæ•´ï¼Œè¯·é‡è¯•ä¸‹è½½"
  rm -f "$TMP_JSON" "$TMP_BIN.gz" "$TMP_BIN"
  exit 1
fi

write_status "90%: æ­£åœ¨å®‰è£…æ ¸å¿ƒ..."
mkdir -p /boot/config/plugins/easy-mihomo

# ç®€åŒ–ç­–ç•¥ï¼šåªä¿å­˜åˆ°Uç›˜ï¼Œåˆ é™¤å†…å­˜æ ¸å¿ƒï¼ˆå¼ºåˆ¶ä¸‹æ¬¡å¯åŠ¨åŒæ­¥ï¼‰
write_status "92%: æ­£åœ¨ä¿å­˜æ ¸å¿ƒåˆ°Uç›˜..."
cp -f "$TMP_BIN" /boot/config/plugins/easy-mihomo/mihomo
chmod +x /boot/config/plugins/easy-mihomo/mihomo 2>/dev/null || true

# ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç‰ˆæœ¬å· + ç‰ˆæœ¬ç±»å‹ï¼Œç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
echo "${RELEASE_TAG}|${VARIANT}" > "$VERSION_FILE"

# åˆ é™¤å†…å­˜ä¸­çš„æ ¸å¿ƒï¼ˆæ— è®ºæœåŠ¡æ˜¯å¦è¿è¡Œï¼‰
# åŸç†ï¼šä¸‹æ¬¡å¯åŠ¨æ—¶ä¼šä»Uç›˜å¤åˆ¶æœ€æ–°ç‰ˆæœ¬ï¼Œç¡®ä¿æ›´æ–°ç”Ÿæ•ˆ
write_status "94%: æ¸…ç†å†…å­˜ä¸­çš„æ—§æ ¸å¿ƒï¼ˆä¸‹æ¬¡å¯åŠ¨å°†ä½¿ç”¨æ–°ç‰ˆæœ¬ï¼‰..."
rm -f /usr/local/bin/mihomo

write_status "96%: æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
rm -f "$TMP_BIN" "$TMP_BIN.gz" "$TMP_JSON"

write_status "100%: æ ¸å¿ƒå®‰è£…å®Œæˆ (v$RELEASE_TAG ${VARIANT_NAME})"
( sleep 2; rm -f "$STATUS_FILE" ) >/dev/null 2>&1 &
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/scripts/download_ui.sh" Mode="0755">
<INLINE><![CDATA[
#!/bin/bash
set -e

PROGRESS=0
if [ "$1" = "--progress" ]; then PROGRESS=1; fi

GITHUB_REPO="Zephyruso/zashboard"
GITHUB_API="https://api.github.com/repos/$GITHUB_REPO/releases/latest"
UI_URL="https://github.com/Zephyruso/zashboard/releases/latest/download/dist.zip"
UI_ROOT="/boot/config/plugins/easy-mihomo"
ZIP_PATH="$UI_ROOT/zashboard.zip"
RAM_ROOT="/var/tmp/easy-mihomo-ui"
RAM_DIR="$RAM_ROOT/zashboard"
STATUS_DIR="/var/tmp/easy-mihomo-progress"
STATUS_FILE="$STATUS_DIR/ui.status"
TMP_DIR="/tmp/easy-mihomo-ui"
ZIP_FILE="$TMP_DIR/dist.zip"
TMP_JSON="$TMP_DIR/release.json"
UI_VERSION_FILE="$UI_ROOT/.ui-version"

mkdir -p "$STATUS_DIR" "$TMP_DIR" "$UI_ROOT" "$RAM_DIR"

write_status(){
  echo "$1"
  if [ "$PROGRESS" = "1" ]; then echo "$1" > "$STATUS_FILE"; fi
}

trap 'write_status "error: unexpected failure"' ERR

write_status "5%: æ­£åœ¨è·å– UI ç‰ˆæœ¬ä¿¡æ¯..."
# è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œå¤±è´¥ä¸å½±å“ä¸‹è½½ï¼‰
UI_VERSION="unknown"
if wget -q --connect-timeout=8 --read-timeout=10 --tries=2 -O "$TMP_JSON" "$GITHUB_API" 2>/dev/null; then
  UI_VERSION=$(grep -o '"tag_name"[[:space:]]*:[[:space:]]*"[^"]*"' "$TMP_JSON" | head -n1 | sed 's/.*"tag_name"[[:space:]]*:[[:space:]]*"v\?\([^"]*\)".*/\1/' || echo "unknown")
  rm -f "$TMP_JSON"
fi

write_status "10%: æ­£åœ¨ä¸‹è½½ UI åŒ…ï¼ˆçº¦5MBï¼Œç‰ˆæœ¬: $UI_VERSIONï¼‰..."
if ! wget -qO "$ZIP_FILE" --connect-timeout=10 --read-timeout=60 --tries=3 --waitretry=3 "$UI_URL"; then
  write_status "error: UI ä¸‹è½½è¶…æ—¶æˆ–ç½‘ç»œä¸­æ–­ï¼ˆå·²å°è¯•3æ¬¡ï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•"; rm -rf "$TMP_DIR"; exit 1
fi

write_status "60%: æ­£åœ¨ä¿å­˜åˆ°Uç›˜..."
# å•æ¬¡é¡ºåºå†™å…¥åˆ° U ç›˜ï¼Œå‡å°‘éšæœºå†™
mv -f "$ZIP_FILE" "$ZIP_PATH"

write_status "90%: æ­£åœ¨è§£å‹åˆ°å†…å­˜..."
# åœ¨å†…å­˜ç›®å½•ä¸­è§£å‹ï¼ˆè¦†ç›–ç°æœ‰ï¼‰
rm -rf "$RAM_DIR" && mkdir -p "$RAM_DIR"
if command -v unzip >/dev/null 2>&1; then
  unzip -oq "$ZIP_PATH" -d "$RAM_DIR" || {
    write_status "error: UI è§£å‹å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½æŸåï¼Œè¯·é‡è¯•ä¸‹è½½"
    rm -rf "$TMP_DIR"
    exit 1
  }
elif command -v busybox >/dev/null 2>&1; then
  busybox unzip -oq "$ZIP_PATH" -d "$RAM_DIR" || {
    write_status "error: UI è§£å‹å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½æŸåï¼Œè¯·é‡è¯•ä¸‹è½½"
    rm -rf "$TMP_DIR"
    exit 1
  }
else
  write_status "error: ç³»ç»Ÿç¼ºå°‘ unzip å·¥å…·ï¼Œæ— æ³•è§£å‹ UI"
  rm -rf "$TMP_DIR"
  exit 1
fi
# è§„èŒƒåŒ–ï¼šå¦‚æœè§£å‹åå­˜åœ¨ dist/ å­ç›®å½•ï¼Œç§»åŠ¨å…¶å†…å®¹åˆ°æ ¹å¹¶åˆ é™¤ dist/
if [ -d "$RAM_DIR/dist" ]; then
  cp -rf "$RAM_DIR/dist/." "$RAM_DIR/"
  rm -rf "$RAM_DIR/dist"
fi

rm -rf "$TMP_DIR"

# ä¿å­˜ UI ç‰ˆæœ¬ä¿¡æ¯
echo "$UI_VERSION" > "$UI_VERSION_FILE"

write_status "100%: UI å·²ä¿å­˜åˆ°Uç›˜å¹¶è§£å‹åˆ°å†…å­˜ (v$UI_VERSION)"
( sleep 1; rm -f "$STATUS_FILE" ) >/dev/null 2>&1 &
]]></INLINE>
</FILE>

<!-- Main page content -->
<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/EasyMihomo.Main.page">
<INLINE><![CDATA[
Menu="Utilities"
Type="xmenu"
Title="Easy-Mihomo"
Icon="icon-network"
Tabs="false"
---
<?php
include '/usr/local/emhttp/plugins/easy-mihomo/index.php';
?>
]]></INLINE>
</FILE>

<!-- Dashboard page content -->
<FILE Name="/usr/local/emhttp/plugins/easy-mihomo/EasyMihomo.Dashboard.page">
<INLINE><![CDATA[
Menu="Dashboard:0"
Icon="icon-network"
---
<?php
/*
  MIT License

  Copyright (c) 2024 Easy-Mihomo

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in all
  copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
*/

require_once('/usr/local/emhttp/plugins/dynamix/include/Wrappers.php');
$pluginname = "easy-mihomo";

// è·å–mihomoçŠ¶æ€
function getMihomoStatus() {
    $status = shell_exec("bash /usr/local/emhttp/plugins/easy-mihomo/scripts/status.sh 2>&1");
    $version = shell_exec("bash /usr/local/emhttp/plugins/easy-mihomo/scripts/version.sh 2>&1");
    
    $isRunning = strpos($status, 'running') !== false;
    $pid = '';
    if (preg_match('/pid=(\d+)/', $status, $matches)) {
        $pid = $matches[1];
    }
    
    return [
        'running' => $isRunning,
        'status' => trim($status),
        'version' => trim($version),
        'pid' => $pid
    ];
}

// è·å–é…ç½®ä¿¡æ¯
function getMihomoConfig() {
    $confDir = '/boot/config/plugins/easy-mihomo';
    $selectFile = $confDir . '/selected.conf';
    $selectedName = is_file($selectFile) ? trim(@file_get_contents($selectFile)) : '';
    $selectedPath = ($selectedName && is_file($confDir . '/' . $selectedName)) ? ($confDir . '/' . $selectedName) : '';
    
    return [
        'selected_config' => $selectedName,
        'config_path' => $selectedPath,
        'has_config' => !empty($selectedPath)
    ];
}

// è·å–æ—¥å¿—ä¿¡æ¯
function getMihomoLogInfo() {
    $logFile = '/var/log/mihomo.log';
    $logSize = file_exists($logFile) ? filesize($logFile) : 0;
    $logLines = file_exists($logFile) ? count(file($logFile)) : 0;
    
    function formatBytes($size, $precision = 2) {
        $units = array('B', 'KB', 'MB', 'GB', 'TB');
        for ($i = 0; $size > 1024 && $i < count($units) - 1; $i++) {
            $size /= 1024;
        }
        return round($size, $precision) . ' ' . $units[$i];
    }
    
    return [
        'size' => formatBytes($logSize),
        'lines' => $logLines,
        'exists' => file_exists($logFile)
    ];
}

$mihomoStatus = getMihomoStatus();
$mihomoConfig = getMihomoConfig();
$logInfo = getMihomoLogInfo();

// åˆ›å»ºä»ªè¡¨æ¿ç“¦ç‰‡
$mytiles[$pluginname]['column1'] =
<<<EOT
<tbody id="tblMihomoDash" title="_(Mihomo ä»£ç†çŠ¶æ€)_">
<tr>
    <td>
        <span class='tile-header'>
        <span class='tile-header-left'>
            <i class='icon-network f32'></i>
            <div class='section'>
                <span class='mihomo-status'>
                    <i class='fa fa-circle mihomo-status-icon'></i>
                    <span class='mihomo-status-text'>_(çŠ¶æ€: åŠ è½½ä¸­...)_</span>
                </span>
                <span class='mihomo-version' id='mihomo-version'>_(ç‰ˆæœ¬: åŠ è½½ä¸­...)_</span>
            </div>
        </span>
        <span class='tile-header-right'>
            <span class='tile-header-right-controls'>
            <a href="/Settings/EasyMihomo.Main" title="_(å‰å¾€ Mihomo è®¾ç½®)_">
                <i class="fa fa-fw fa-cog control"></i>
            </a>
            </span>
        </span>
        </span>
    </td>
</tr>
<tr class="header"><td><span class="w25">_(è¿è¡ŒçŠ¶æ€)_</span><span class="w25">_(é…ç½®æ–‡ä»¶)_</span><span class="w25">_(å†…å­˜ä½¿ç”¨)_</span><span class="w25">_(è¿è¡Œæ—¶é—´)_</span></td></tr>
<tr class="updated">
    <td>
        <span class="w25">
            <span class="mihomo-service-status">_(åŠ è½½ä¸­...)_</span>
        </span>
        <span class="w25">
            <span class="mihomo-config-info">_(åŠ è½½ä¸­...)_</span>
        </span>
        <span class="w25">
            <span class="mihomo-memory-info">_(åŠ è½½ä¸­...)_</span>
        </span>
        <span class="w25">
            <span class="mihomo-uptime-info">_(åŠ è½½ä¸­...)_</span>
        </span>
    </td>
</tr>
<tr class="updated">
    <td>
        <span class="w25">
            <button class="mihomo-btn mihomo-btn-start" onclick="mihomoAction('start')" title="_(å¯åŠ¨ Mihomo æœåŠ¡)_">
                <i class="fa fa-play"></i> _(å¯åŠ¨)_
            </button>
        </span>
        <span class="w25">
            <button class="mihomo-btn mihomo-btn-restart" onclick="mihomoAction('restart')" title="_(é‡å¯ Mihomo æœåŠ¡)_">
                <i class="fa fa-refresh"></i> _(é‡å¯)_
            </button>
        </span>
        <span class="w25">
            <button class="mihomo-btn mihomo-btn-stop" onclick="mihomoAction('stop')" title="_(åœæ­¢ Mihomo æœåŠ¡)_">
                <i class="fa fa-stop"></i> _(åœæ­¢)_
            </button>
        </span>
        <span class="w25">
            <button class="mihomo-btn mihomo-btn-ui" onclick="mihomoAction('ui')" title="_(æ‰“å¼€ Mihomo ç®¡ç†ç•Œé¢)_">
                <i class="fa fa-external-link"></i> _(æ‰“å¼€UI)_
            </button>
        </span>
    </td>
</tr>
<tr><td><span></span></td></tr>
</tbody>
EOT;

?>
<style type="text/css">
.mihomo-status {
    display: inline-block;
    margin-right: 10px;
}

.mihomo-status-icon {
    margin-right: 5px;
}

.mihomo-status-icon.running {
    color: #28a745;
}

.mihomo-status-icon.stopped {
    color: #dc3545;
}

.mihomo-status-icon.loading {
    color: #6c757d;
}

.mihomo-version {
    display: block;
    font-size: 12px;
    color: #6c757d;
    margin-top: 2px;
}

.mihomo-service-status {
    font-weight: bold;
}

.mihomo-config-info {
    font-size: 12px;
    color: #6c757d;
}

.mihomo-memory-info {
    font-size: 12px;
    color: #6c757d;
    font-weight: bold;
}

.mihomo-uptime-info {
    font-size: 12px;
    color: #6c757d;
    font-weight: bold;
}

/* ç¡®ä¿4åˆ—ç­‰å®½å¯¹é½ */
.w25 {
    width: 25% !important;
    display: inline-block;
    text-align: center;
    vertical-align: top;
    box-sizing: border-box;
    padding: 0 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* æŒ‰é’®æ ·å¼ */
.mihomo-btn {
    background: #2c3e50;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 80px;
    margin: 2px;
}

.mihomo-btn:hover {
    opacity: 0.8;
    transform: translateY(-1px);
}

.mihomo-btn:active {
    transform: translateY(0);
}

.mihomo-btn i {
    margin-right: 4px;
}

.mihomo-btn-start {
    background: #28a745;
}

.mihomo-btn-restart {
    background: #ffc107;
    color: #212529;
}

.mihomo-btn-stop {
    background: #dc3545;
}

.mihomo-btn-ui {
    background: #17a2b8;
}

</style>

<script type="text/javascript" src="/plugins/easy-mihomo/scripts/mihomo-dashboard.js"></script>
<script type="text/javascript">
function refreshMihomoDashboard() {
    $.getJSON('/plugins/easy-mihomo/api.php?cmd=dashboard_status', function(data) {
        if (data) {
            // ä¿å­˜APIæ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
            window.mihomoLastData = data;
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            var statusIcon = $('.mihomo-status-icon');
            var statusText = $('.mihomo-status-text');
            var versionText = $('#mihomo-version');
            var serviceStatus = $('.mihomo-service-status');
            var configInfo = $('.mihomo-config-info');
            var memoryInfo = $('.mihomo-memory-info');
            var uptimeInfo = $('.mihomo-uptime-info');
            
            // çŠ¶æ€å›¾æ ‡å’Œæ–‡æœ¬
            statusIcon.removeClass('running stopped loading').addClass(data.running ? 'running' : 'stopped');
            statusText.text(data.running ? _('è¿è¡Œä¸­') : _('å·²åœæ­¢'));
            
            // é¡¶éƒ¨ç‰ˆæœ¬ä¿¡æ¯
            versionText.text(_('ç‰ˆæœ¬: ') + (data.version || _('æœªçŸ¥')));
            
            // è¿è¡ŒçŠ¶æ€
            if (data.running) {
                serviceStatus.html('<span style="color:#28a745;font-weight:bold;">' + _('è¿è¡Œä¸­') + '</span>');
            } else {
                serviceStatus.html('<span style="color:#dc3545;font-weight:bold;">' + _('å·²åœæ­¢') + '</span>');
            }
            
            // é…ç½®æ–‡ä»¶ä¿¡æ¯
            if (data.config && data.config.has_config) {
                var configName = data.config.selected_config || _('æœªçŸ¥');
                configInfo.html('<span style="color:#28a745;">' + configName + '</span>');
            } else {
                configInfo.html('<span style="color:#dc3545;">' + _('æœªé€‰æ‹©é…ç½®') + '</span>');
            }
            
            // å†…å­˜ä½¿ç”¨ä¿¡æ¯
            if (data.running && data.memory) {
                memoryInfo.html('<span style="color:#17a2b8;">' + data.memory + '</span>');
            } else {
                memoryInfo.html('<span style="color:#6c757d;">' + _('æœªçŸ¥') + '</span>');
            }
            
            // è¿è¡Œæ—¶é—´ä¿¡æ¯
            if (data.running && data.uptime) {
                uptimeInfo.html('<span style="color:#28a745;">' + data.uptime + '</span>');
            } else {
                uptimeInfo.html('<span style="color:#6c757d;">' + _('æœªçŸ¥') + '</span>');
            }
        }
    }).fail(function() {
        // æ›´æ–°å¤±è´¥æ—¶çš„æ˜¾ç¤º
        $('.mihomo-status-icon').removeClass('running stopped').addClass('loading');
        $('.mihomo-status-text').text(_('çŠ¶æ€: é”™è¯¯'));
        $('.mihomo-service-status').text(_('é”™è¯¯'));
        $('.mihomo-config-info').text(_('é”™è¯¯'));
        $('.mihomo-memory-info').text(_('é”™è¯¯'));
        $('.mihomo-uptime-info').text(_('é”™è¯¯'));
    });
}

// æŒ‰é’®æ“ä½œå‡½æ•°
function mihomoAction(action) {
    switch(action) {
        case 'start':
        case 'stop':
        case 'restart':
            // é™é»˜å¤„ç†æ“ä½œï¼Œä¸è·³è½¬é¡µé¢
            var actionText = '';
            switch(action) {
                case 'start': actionText = _('å¯åŠ¨'); break;
                case 'stop': actionText = _('åœæ­¢'); break;
                case 'restart': actionText = _('é‡å¯'); break;
            }
            
            // æ˜¾ç¤ºæ“ä½œçŠ¶æ€
            $('.mihomo-status-text').text(_('çŠ¶æ€: ') + actionText + _('ä¸­...'));
            $('.mihomo-status-icon').removeClass('running stopped').addClass('loading');
            
            // å‘é€æ“ä½œè¯·æ±‚
            $.get('/plugins/easy-mihomo/api.php?cmd=' + action, function(response) {
                // æ“ä½œå®Œæˆååˆ·æ–°çŠ¶æ€
                setTimeout(function() {
                    refreshMihomoDashboard();
                }, 1000);
            }).fail(function() {
                // æ“ä½œå¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯
                $('.mihomo-status-text').text(_('çŠ¶æ€: æ“ä½œå¤±è´¥'));
                $('.mihomo-status-icon').removeClass('running stopped loading').addClass('stopped');
            });
            break;
        case 'ui':
            // æ‰“å¼€æ§åˆ¶å°UI
            var currentHostname = window.location.hostname;
            // ä»APIæ•°æ®ä¸­è·å–ç«¯å£ä¿¡æ¯
            var port = null;
            if (window.mihomoLastData && window.mihomoLastData.config && window.mihomoLastData.config.port) {
                port = window.mihomoLastData.config.port;
            }
            
            if (!port) {
                alert('è¯·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® external-controller ç«¯å£');
                return;
            }
            
            var consoleUrl = 'http://' + currentHostname + ':' + port + '/ui/zashboard/#/proxies';
            window.open(consoleUrl, '_blank');
            break;
    }
}

// é¡µé¢åŠ è½½æ—¶ç«‹å³åˆ·æ–°ä¸€æ¬¡
$(document).ready(function() {
    refreshMihomoDashboard();
    
    // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
    setInterval(refreshMihomoDashboard, 5000);
});
</script>
]]></INLINE>
</FILE>

<!-- post-install: setup menu entry -->
<FILE Run="/bin/bash">
<INLINE>
set -e
echo "Mihomo plugin installed. Persistent path: /boot/config/plugins/easy-mihomo"
</INLINE>
</FILE>

<!-- version cleanup -->
<FILE Run="/bin/bash">
<INLINE>
set -e
echo "Cleanup completed"
</INLINE>
</FILE>

<!-- remove -->
<FILE Run="/bin/bash" Method="remove">
<INLINE><![CDATA[
set -e
echo "æ­£åœ¨å¸è½½ Easy-Mihomo æ’ä»¶..."

# åœæ­¢mihomoè¿›ç¨‹
echo "  - æ­£åœ¨åœæ­¢ Mihomo æœåŠ¡..."
if pgrep -x mihomo >/dev/null 2>&1; then
  echo "    æ£€æµ‹åˆ°mihomoè¿›ç¨‹ï¼Œæ­£åœ¨åœæ­¢..."
  pkill -9 -x mihomo 2>/dev/null || true
  # ç­‰å¾…è¿›ç¨‹å®Œå…¨åœæ­¢
  sleep 2
  if pgrep -x mihomo >/dev/null 2>&1; then
    echo "    å¼ºåˆ¶åœæ­¢mihomoè¿›ç¨‹..."
    pkill -9 -x mihomo 2>/dev/null || true
    sleep 1
  fi
  echo "  âœ“ Mihomo æœåŠ¡å·²åœæ­¢"
else
  echo "  âœ“ Mihomo æœåŠ¡æœªè¿è¡Œ"
fi

# å¸è½½ UI bind æŒ‚è½½ï¼ˆè‹¥å­˜åœ¨ï¼‰
echo "  - å¸è½½ UI æŒ‚è½½..."
UI_MOUNT_DIR="/boot/config/plugins/easy-mihomo/ui/zashboard"
if [ -d "$UI_MOUNT_DIR" ] && mountpoint -q "$UI_MOUNT_DIR"; then
  echo "    æ£€æµ‹åˆ°bind mountï¼Œæ­£åœ¨å¸è½½..."
  umount "$UI_MOUNT_DIR" 2>/dev/null || umount -l "$UI_MOUNT_DIR" 2>/dev/null || true
  echo "    bind mountå·²å¸è½½"
elif [ -L "$UI_MOUNT_DIR" ]; then
  echo "    æ£€æµ‹åˆ°è½¯é“¾æ¥ï¼Œæ­£åœ¨åˆ é™¤..."
  rm -f "$UI_MOUNT_DIR" 2>/dev/null || true
  echo "    è½¯é“¾æ¥å·²åˆ é™¤"
else
  echo "    æ— éœ€å¤„ç†UIæŒ‚è½½"
fi
echo "  âœ“ UI æŒ‚è½½å¤„ç†å®Œæˆ"

# æ¸…ç†PIDæ–‡ä»¶
echo "  - æ¸…ç†è¿›ç¨‹æ–‡ä»¶..."
rm -f /var/run/mihomo.pid
echo "  âœ“ è¿›ç¨‹æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†äºŒè¿›åˆ¶æ–‡ä»¶
echo "  - æ¸…ç†äºŒè¿›åˆ¶æ–‡ä»¶..."
rm -f /usr/local/bin/mihomo
rm -f /boot/config/plugins/easy-mihomo/mihomo
echo "  âœ“ äºŒè¿›åˆ¶æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†æ’ä»¶ç›®å½•
echo "  - æ¸…ç†æ’ä»¶ç›®å½•..."
rm -rf /usr/local/emhttp/plugins/easy-mihomo
rm -f /boot/config/plugins/easy-mihomo/.version
rm -rf /boot/config/plugins/easy-mihomo
echo "  âœ“ æ’ä»¶ç›®å½•å·²æ¸…ç†"

# æ¸…ç†å†…å­˜ä¸´æ—¶ç›®å½•
echo "  - æ¸…ç†å†…å­˜ä¸´æ—¶ç›®å½•..."
rm -rf /var/tmp/easy-mihomo-ui /var/tmp/easy-mihomo-progress /tmp/easy-mihomo-ui /tmp/mihomo-download
echo "  âœ“ å†…å­˜ä¸´æ—¶ç›®å½•å·²æ¸…ç†"

# æ¸…ç†ç³»ç»Ÿè¦†ç›–å±‚æ–‡ä»¶ï¼ˆä»…é™æœ¬æ’ä»¶å‘½åç©ºé—´ï¼‰
echo "  - æ¸…ç†ç³»ç»Ÿæ–‡ä»¶..."
rm -rf /var/local/overlay/usr/local/emhttp/plugins/easy-mihomo
rm -f /var/local/overlay/usr/local/emhttp/plugins/easy-mihomo.*
echo "  âœ“ ç³»ç»Ÿæ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
echo "  - æ¸…ç†æ—¥å¿—æ–‡ä»¶..."
rm -f /var/log/mihomo.log
echo "  âœ“ æ—¥å¿—æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
echo "  - æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
rm -f /tmp/mihomo
echo "  âœ“ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"

# æ¸…ç†å¼€æœºå³å¯åŠ¨æ³¨å…¥ä¸æ ‡å¿—
echo "  - æ¸…ç†å¼€æœºå¯åŠ¨é…ç½®..."
sed -i "/^# BEGIN easy-mihomo (do not edit)$/,/^# END easy-mihomo$/d" /boot/config/go 2>/dev/null || true
rm -f /boot/config/plugins/easy-mihomo/bootstart.enabled
echo "  âœ“ å¼€æœºå¯åŠ¨é…ç½®å·²æ¸…ç†"

# æ¸…ç†å®šæ—¶ä»»åŠ¡
echo "  - æ¸…ç†å®šæ—¶æ¸…ç†ä»»åŠ¡..."
crontab -l 2>/dev/null | grep -v "mihomo.*log_cleanup" | crontab - 2>/dev/null || true
echo "  âœ“ å®šæ—¶æ¸…ç†ä»»åŠ¡å·²æ¸…ç†"

echo ""
echo "ğŸ‰ Easy-Mihomo æ’ä»¶å¸è½½å®Œæˆï¼"
echo "   æ‰€æœ‰ç›¸å…³æ–‡ä»¶å’Œé…ç½®å·²å®Œå…¨æ¸…ç†ã€‚"
]]></INLINE>
</FILE>

</PLUGIN>
